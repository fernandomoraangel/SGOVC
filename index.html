<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de OVC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos CSS (sin cambios) */
        .sidebar-link.active {
            background-color: #ec4899;
            color: white;
        }

        /* --- Kanban Styles Start --- */
        /* Estilos personalizados (igual que la versión anterior) */
        .kanban-body {
            /* Applied to body when kanban is active? Or just use existing body styles? */
            font-family: 'Inter', sans-serif;
            /* background-color: #f3f4f6; /* Let index.html body style handle this */
        }

        .kanban-container {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
            margin-top: 1.5rem;
            /* Or adjust based on integration */
        }

        .kanban-column {
            min-height: 300px;
            background-color: #f9fafb;
            border-radius: 0.5rem;
            padding: 1rem;
            flex: 1;
            display: flex;
            flex-direction: column;
            border: 1px solid #e5e7eb;
        }

        .kanban-tasks {
            flex-grow: 1;
            min-height: 200px;
            border-radius: 0.375rem;
        }

        .task-card {
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            cursor: grab;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .task-card.editing {
            cursor: default;
            box-shadow: 0 0 0 2px #3b82f6;
            /* Tailwind blue-500 */
        }

        .task-card:not(.editing):hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .task-card.dragging {
            opacity: 0.6;
            cursor: grabbing;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .task-card p {
            margin-bottom: 0.25rem;
            word-wrap: break-word;
        }

        .task-card .details {
            font-size: 0.8rem;
            color: #6b7280;
            /* Tailwind gray-500 */
        }

        .task-card .edit-input {
            width: 100%;
            padding: 0.3rem 0.5rem;
            border: 1px solid #d1d5db;
            /* Tailwind gray-300 */
            border-radius: 0.25rem;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .task-card .edit-textarea {
            min-height: 60px;
            resize: vertical;
        }

        /* --- Subtask Styles --- */
        .subtasks-section {
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid #e5e7eb;
            /* Tailwind gray-200 */
        }

        .subtasks-list-view,
        .subtasks-list-edit {
            margin-top: 0.5rem;
            padding-left: 0.5rem;
            /* Indent subtasks slightly */
            list-style: none;
            /* Remove default list bullets */
            padding-inline-start: 10px;
            /* Override browser default padding */
        }

        .subtask-item-view {
            font-size: 0.85rem;
            color: #4b5563;
            /* Tailwind gray-600 */
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .subtask-item-view input[type="checkbox"] {
            width: 0.8rem;
            height: 0.8rem;
            cursor: pointer;
            margin-right: 0.3rem;
            /* Space after checkbox */
            flex-shrink: 0;
            /* Prevent checkbox shrinking */
            /* Consider Tailwind accent color: accent-pink-500 */
        }

        .subtask-item-view span {
            word-break: break-word;
            /* Wrap long subtask text */
        }

        .subtask-item-view span.completed {
            text-decoration: line-through;
            color: #9ca3af;
            /* Tailwind gray-400 */
        }

        .subtasks-list-edit {
            max-height: 150px;
            /* Limit height and allow scroll */
            overflow-y: auto;
            padding-right: 5px;
            /* Space for scrollbar */
        }

        .subtask-item-edit {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.3rem 0.2rem;
            margin-bottom: 0.3rem;
            background-color: #f9fafb;
            /* Tailwind gray-50 */
            border: 1px solid #e5e7eb;
            /* Tailwind gray-200 */
            border-radius: 0.25rem;
            font-size: 0.85rem;
        }

        .subtask-item-edit.sortable-ghost {
            /* Style for dragged item placeholder */
            opacity: 0.4;
            background-color: #dbeafe;
            /* Tailwind blue-100 */
        }

        .subtask-drag-handle {
            cursor: grab;
            color: #9ca3af;
            /* Tailwind gray-400 */
            padding: 0 0.2rem;
            align-self: center;
            /* Center handle vertically */
        }

        .subtask-item-edit input[type="text"] {
            flex-grow: 1;
            border: none;
            padding: 0.2rem 0.4rem;
            font-size: 0.85rem;
            background-color: transparent;
            /* Match item background */
            min-width: 0;
            /* Allow shrinking */
        }

        .subtask-item-edit input[type="text"]:focus {
            outline: none;
            background-color: white;
            /* Highlight on focus */
            box-shadow: inset 0 0 0 1px #d1d5db;
            /* Tailwind gray-300 */
            border-radius: 0.15rem;
        }

        .subtask-delete-btn {
            background: none;
            border: none;
            color: #ef4444;
            /* Tailwind red-500 */
            cursor: pointer;
            font-size: 0.9rem;
            padding: 0 0.3rem;
            line-height: 1;
            flex-shrink: 0;
            /* Prevent button shrinking */
        }

        .subtask-delete-btn:hover {
            color: #dc2626;
            /* Tailwind red-600 */
        }

        .add-subtask-container {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .add-subtask-input {
            flex-grow: 1;
            padding: 0.3rem 0.5rem;
            border: 1px solid #d1d5db;
            /* Tailwind gray-300 */
            border-radius: 0.25rem;
            font-size: 0.85rem;
            min-width: 0;
            /* Allow shrinking */
        }

        .add-subtask-btn {
            padding: 0.3rem 0.6rem;
            font-size: 0.8rem;
            flex-shrink: 0;
            /* Prevent button shrinking */
            /* Reuse edit-button styles */
        }

        .view-subtasks-btn {
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: #4b5563;
            /* Tailwind gray-600 */
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.2rem 0;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .view-subtasks-btn:hover {
            color: #1f2937;
            /* Tailwind gray-800 */
            text-decoration: underline;
        }

        .view-subtasks-btn .arrow {
            transition: transform 0.2s ease-in-out;
            display: inline-block;
            /* Needed for transform */
        }

        .view-subtasks-btn[aria-expanded="true"] .arrow {
            transform: rotate(90deg);
        }

        /* --- End Subtask Styles --- */

        .task-card .edit-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 0.75rem;
            /* Increased margin */
        }

        .task-card .edit-button {
            padding: 0.25rem 0.6rem;
            border-radius: 0.25rem;
            font-size: 0.8rem;
            font-weight: 500;
            border: 1px solid transparent;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: inline-flex;
            /* Para alinear emoji y texto */
            align-items: center;
            gap: 0.25rem;
            /* Espacio entre emoji y texto */
        }

        .task-card .save-button {
            background-color: #2563eb;
            /* Tailwind blue-600 */
            color: white;
            border-color: #2563eb;
            /* Tailwind blue-600 */
        }

        .task-card .save-button:hover {
            background-color: #1d4ed8;
            /* Tailwind blue-700 */
        }

        .task-card .cancel-button {
            background-color: #e5e7eb;
            /* Tailwind gray-200 */
            color: #374151;
            /* Tailwind gray-700 */
            border-color: #d1d5db;
            /* Tailwind gray-300 */
        }

        .task-card .cancel-button:hover {
            background-color: #d1d5db;
            /* Tailwind gray-300 */
        }

        .context-menu {
            position: absolute;
            background-color: white;
            border: 1px solid #d1d5db;
            /* Tailwind gray-300 */
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 0.5rem 0;
            z-index: 1000;
            display: none;
            min-width: 150px;
        }

        .context-menu-item {
            display: flex;
            align-items: center;
            padding: 0.6rem 1rem;
            cursor: pointer;
            font-size: 0.9rem;
            color: #374151;
            /* Tailwind gray-700 */
            gap: 0.5rem;
            /* Espacio para emojis */
        }

        .context-menu-item:hover {
            background-color: #f3f4f6;
            /* Tailwind gray-100 */
        }

        .color-swatch {
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            border: 1px solid #ccc;
        }

        .bg-task-red {
            background-color: #fee2e2;
            border-left: 4px solid #f87171;
        }

        /* red-100, red-400 */
        .bg-task-blue {
            background-color: #dbeafe;
            border-left: 4px solid #60a5fa;
        }

        /* blue-100, blue-400 */
        .bg-task-green {
            background-color: #d1fae5;
            border-left: 4px solid #34d399;
        }

        /* green-100, green-400 */
        .bg-task-yellow {
            background-color: #fef3c7;
            border-left: 4px solid #facc15;
        }

        /* yellow-100, yellow-400 */
        .bg-task-purple {
            background-color: #e9d5ff;
            border-left: 4px solid #a78bfa;
        }

        /* purple-100, purple-400 */
        .bg-task-default {
            background-color: white;
            border-left: 4px solid #d1d5db;
        }

        /* gray-300 */

        .kanban-tasks.drag-over {
            background-color: #e5e7eb;
            /* Tailwind gray-200 */
            border: 1px dashed #9ca3af;
            /* Tailwind gray-400 */
        }

        /* Modal styles (reusing existing modal styles might be better if consistent) */
        .kanban-modal {
            /* Use a specific class to avoid conflicts */
            display: none;
            position: fixed;
            z-index: 1050;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .kanban-modal-content {
            /* Use a specific class */
            background-color: #fefefe;
            margin: 10% auto;
            padding: 2rem;
            border: none;
            width: 90%;
            max-width: 500px;
            border-radius: 0.5rem;
            position: relative;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .kanban-close-button {
            /* Use a specific class */
            color: #9ca3af;
            /* Tailwind gray-400 */
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .kanban-close-button:hover,
        .kanban-close-button:focus {
            color: #1f2937;
            /* Tailwind gray-800 */
            text-decoration: none;
        }

        #addTaskBtn {
            /* ID might need adjustment if conflicts */
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Estilo para emojis en títulos y botones */
        .emoji {
            margin-right: 0.4rem;
            /* Espacio después del emoji */
            display: inline-block;
            /* Asegura espaciado correcto */
        }

        /* --- Kanban Styles End --- */

        .btn-create-ovc {
            background-color: #343a40;
            color: white;
            transition: background-color 0.3s ease;
        }

        .btn-create-ovc:hover {
            background-color: #495057;
        }

        .btn-create-ovc span:first-child {
            margin-right: 0.5rem;
        }

        .sidebar-link span:first-child {
            display: inline-block;
            width: 24px;
            text-align: center;
            margin-right: 0.75rem;
            font-size: 1.2rem;
        }

        body {
            font-family: 'Inter', sans-serif;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        .logo-placeholder {
            font-weight: bold;
            font-size: 1.1rem;
            text-align: center;
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 1rem;
        }

        .udea-logo {
            max-width: 100px;
            height: auto;
            margin-top: auto;
            margin-bottom: 1rem;
            align-self: center;
        }

        .image-preview {
            width: 200px;
            height: 150px;
            border: 2px dashed #cbd5e1;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8fafc;
            color: #94a3b8;
            font-size: 0.875rem;
            overflow: hidden;
            text-align: center;
        }

        .image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }

        .custom-file-input::-webkit-file-upload-button {
            visibility: hidden;
        }

        .custom-file-input::before {
            content: 'Seleccionar archivo';
            display: inline-block;
            background: linear-gradient(top, #f9f9f9, #e3e3e3);
            border: 1px solid #999;
            border-radius: 3px;
            padding: 5px 8px;
            outline: none;
            white-space: nowrap;
            -webkit-user-select: none;
            cursor: pointer;
            text-shadow: 1px 1px #fff;
            font-weight: 700;
            font-size: 10pt;
            margin-right: 10px;
        }

        .custom-file-input:hover::before {
            border-color: black;
        }

        .custom-file-input:active::before {
            background: -webkit-linear-gradient(top, #e3e3e3, #f9f9f9);
        }

        .btn-add,
        .btn-remove {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            line-height: 1;
        }

        .btn-add span,
        .btn-remove span {
            margin-right: 0.25rem;
        }

        .modal-overlay {
            transition: opacity 0.3s ease-in-out;
        }



        .modal-content {
            transition: transform 0.3s ease-in-out;
        }

        .empty-table-row td {
            text-align: center;
            color: #6b7280;
            font-style: italic;
            padding: 2rem;
        }

        label>span:first-child,
        h2>span:first-child,
        h3>span:first-child {
            margin-right: 0.3em;
        }

        button[title="Salir"] span {
            margin-right: 0;
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            pointer-events: none;
        }

        .action-btn {
            cursor: pointer;
        }

        .hidden {
            display: none;
        }

        /* Styles for Rubrics Submenu */
        .submenu {
            display: none;
            /* Hidden by default */
            padding-left: 1.5rem;
            /* Indentation for submenu items */
            background-color: #f8f9fa;
            /* Slightly different background */
        }

        .submenu.open {
            display: block;
            /* Show when open */
        }

        .submenu-link {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            font-size: 0.9rem;
            /* Slightly smaller font */
        }

        .submenu-toggle-icon {
            margin-left: auto;
            /* Push arrow to the right */
            transition: transform 0.2s ease-in-out;
            font-size: 0.8rem;
        }

        .submenu-toggle-icon.open {
            transform: rotate(90deg);
        }
    </style>
    <script>
    </script>
    <script>
        // Listeners DOMContentLoaded de líneas 171-228 eliminados (redundantes con lógica principal en 846+)
    </script>
    <!-- SortableJS for drag-and-drop subtasks -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <!-- Duplicate SortableJS removed -->
</head>

<body class="bg-gray-100 font-sans">
    <div class="flex h-screen bg-gray-100">
        <aside class="w-64 bg-white shadow-md flex flex-col fixed h-full z-10">
            <div class="logo-placeholder text-gray-700">
                <img src="logocd.png" alt="Creación Digital" style="max-width: 150px; height: auto;">
            </div>
            <nav class="flex-grow">
                <ul>
                    <li>
                        <a href="#" class="sidebar-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-200"
                            data-section="crear">
                            <span>➕</span> <span>Crear OVC</span>
                        </a>
                    </li>
                    <li>
                        <a href="#"
                            class="sidebar-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-200 active"
                            data-section="listar">
                            <span>📋</span> <span>Listar OVC</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" class="sidebar-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-200"
                            data-section="rizoma" id="rizoma-link">
                            <span>🌱</span> <span>Ver Rizoma</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" class="sidebar-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-200"
                            data-section="kanban">
                            <span>📋</span> <span>Tablero Kanban</span>
                        </a>
                    </li>
                    </li>
                    <li>
                        <a href="#" class="sidebar-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-200"
                            id="rubricas-toggle">
                            <span>📊</span> <span>Rúbricas</span>
                            <span class="submenu-toggle-icon">▶️</span>
                        </a>
                        <ul class="submenu" id="rubricas-submenu">
                            <li>
                                <a href="disenar_rubrica.html"
                                    class="sidebar-link submenu-link flex items-center px-6 py-2 text-gray-600 hover:bg-gray-200">
                                    <span>✏️</span> <span>Diseñar Rúbrica</span>
                                </a>
                            </li>
                            <li>
                                <a href="evaluar_ovc.html"
                                    class="sidebar-link submenu-link flex items-center px-6 py-2 text-gray-600 hover:bg-gray-200">
                                    <span>✔️</span> <span>Evaluar OVC</span>
                                </a>
                            </li>
                            <li>
                                <a href="ver_promedios.html"
                                    class="sidebar-link submenu-link flex items-center px-6 py-2 text-gray-600 hover:bg-gray-200">
                                    <span>📈</span> <span>Ver Promedios</span>
                                </a>
                            </li>
                            <li>
                                <a href="resumen_rubricas.html"
                                    class="sidebar-link submenu-link flex items-center px-6 py-2 text-gray-600 hover:bg-gray-200">
                                    <span>📑</span> <span>Resumen Rúbricas</span>
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </nav>
            <div class="p-4 mt-auto flex justify-center border-t border-gray-200">
                <img src="logoudea.png" alt="Logo Ude@" class="udea-logo">
            </div>
        </aside>

        <div class="flex-1 flex flex-col ml-64 min-h-0"> <!-- Added min-h-0 -->
            <header class="bg-gray-800 shadow-md p-4 flex justify-between items-center">
                <div class="text-white text-xl font-semibold" id="section-title">
                    <span>📋</span> Mis objetos virtuales creativos
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-white">👤 Fernando Mora Angel</span>
                    <div
                        class="w-10 h-10 rounded-full bg-pink-500 flex items-center justify-center text-white font-bold">
                        FM
                    </div>
                    <button class="text-gray-300 hover:text-white text-xl" title="Salir">
                        <span>🚪</span> </button>
                </div>
            </header>

            <main class="flex-1 p-6 lg:p-8"> <!-- Removed overflow-y-auto -->
                <div id="content-area" class="flex flex-col flex-1 min-h-0 h-full"> <!-- Added h-full -->
                    <div id="listar-section" class="space-y-6">
                        <div class="flex justify-between items-center mb-6">

                            <div class="flex items-center space-x-4">
                                <button id="go-to-create-btn"
                                    class="btn-create-ovc flex items-center px-4 py-2 rounded-lg shadow hover:shadow-md transition duration-300">
                                    <span>➕</span><span>Crear OVC</span> </button>
                                <div class="relative">
                                    <span class="search-icon">🔍</span> <input type="text" placeholder="Buscar..."
                                        id="search-input"
                                        class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-transparent">
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col"
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Título (Recurso)</th>
                                            <th scope="col"
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Autor Principal</th>
                                            <th scope="col"
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Asignaturas</th>
                                            <th scope="col"
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Año-Semestre</th>
                                            <th scope="col"
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Etiquetas</th>
                                            <th scope="col" class="relative px-6 py-3">
                                                <span class="sr-only">Acciones</span>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="ovc-table-body" class="bg-white divide-y divide-gray-200">
                                    </tbody>
                                </table>
                            </div>
                            <div
                                class="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6 mt-4 rounded-b-lg">
                                <div class="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
                                    <div>
                                        <p class="text-sm text-gray-700">
                                            Mostrando <span id="pagination-start">0</span> a <span
                                                id="pagination-end">0</span> de <span id="pagination-total">0</span>
                                            resultados
                                        </p>
                                    </div>
                                    <div>
                                        <nav class="isolate inline-flex -space-x-px rounded-md shadow-sm"
                                            aria-label="Pagination">
                                            <a href="#"
                                                class="relative inline-flex items-center rounded-l-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0">
                                                <span>⏪</span> </a>
                                            <a href="#"
                                                class="relative inline-flex items-center px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0">
                                                <span>⬅️</span> </a>
                                            <a href="#"
                                                class="relative inline-flex items-center px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0">
                                                <span>➡️</span> </a>
                                            <a href="#"
                                                class="relative inline-flex items-center rounded-r-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0">
                                                <span>⏩</span> </a>
                                        </nav>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Eliminado div duplicado con id="rizoma-section" que estaba aquí -->
                    <div id="crear-section" class="hidden space-y-8">
                        <!-- Eliminado: Título duplicado -->

                        <form id="crear-ovc-form" class="space-y-10 bg-white p-8 rounded-lg shadow-lg">
                            <input type="hidden" id="edit-ovc-id" name="edit-ovc-id">
                            <div class="border-b border-gray-200 pb-6">
                                <h2 class="text-xl font-semibold text-gray-700 mb-4"><span>ℹ️</span> Información Básica
                                </h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="ovc-imagen" class="block text-sm font-medium text-gray-700 mb-1">
                                            <span>🖼️</span> Imagen de Portada </label>
                                        <input type="file" id="ovc-imagen" name="ovc-imagen" accept="image/*"
                                            class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-pink-50 file:text-pink-700 hover:file:bg-pink-100 custom-file-input">
                                        <div id="image-preview-container" class="image-preview">
                                            <span>Previsualización</span>
                                        </div>
                                        <span id="imagen-filename" class="text-xs text-gray-500 mt-1 block"></span>
                                        <input type="hidden" id="imagen-data-url">
                                    </div>
                                    <div class="space-y-4">
                                        <div>
                                            <label for="ovc-titulo"
                                                class="block text-sm font-medium text-gray-700"><span>📄</span> Título
                                                del OVC</label> <input type="text" id="ovc-titulo" name="ovc-titulo"
                                                required
                                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 sm:text-sm">
                                        </div>
                                        <div>
                                            <label for="ovc-descripcion"
                                                class="block text-sm font-medium text-gray-700"><span>📄</span>
                                                Descripción</label> <textarea id="ovc-descripcion"
                                                name="ovc-descripcion" rows="4" required
                                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 sm:text-sm"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="border-b border-gray-200 pb-6">
                                <div class="flex justify-between items-center mb-3">
                                    <h2 class="text-xl font-semibold text-gray-700"><span>👥</span> Autores</h2> <button
                                        type="button" id="add-autor"
                                        class="btn-add inline-flex items-center px-3 py-1.5 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                        <span>➕</span> Añadir Autor </button>
                                </div>
                                <div id="autores-container" class="space-y-4">
                                    <div
                                        class="autor-item grid grid-cols-1 sm:grid-cols-5 gap-4 items-end p-4 border rounded-md bg-gray-50">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-600"><span>👤</span>
                                                Nombre</label> <input type="text" name="autor_nombre[]"
                                                placeholder="Nombre completo"
                                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 sm:text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-600"><span>💼</span>
                                                Rol</label> <input type="text" name="autor_rol[]"
                                                placeholder="Ej: Investigador"
                                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 sm:text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-600"><span>@</span>
                                                E-mail</label> <input type="email" name="autor_email[]"
                                                placeholder="correo@ejemplo.com"
                                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 sm:text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-600"><span>%</span>
                                                Participación (%)</label> <input type="number"
                                                name="autor_participacion[]" placeholder="Ej: 50" min="0" max="100"
                                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 sm:text-sm">
                                        </div>
                                        <button type="button"
                                            class="btn-remove remove-item self-end inline-flex justify-center items-center px-3 py-1.5 border border-red-300 text-sm font-medium rounded-md shadow-sm text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                            <span>🗑️</span> </button>
                                    </div>
                                </div>
                            </div>
                            <div class="border-b border-gray-200 pb-6 grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <h3 class="text-lg font-medium text-gray-700"><span>🏷️</span> Etiquetas</h3>
                                        <button type="button" id="add-etiqueta"
                                            class="btn-add inline-flex items-center px-2 py-1 border border-transparent text-xs font-medium rounded shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                            <span>➕</span> Añadir </button>
                                    </div>
                                    <div id="etiquetas-container" class="space-y-2">
                                        <div class="etiqueta-item flex items-center gap-2">
                                            <input type="text" name="etiquetas[]" placeholder="Ej: Realidad Aumentada"
                                                class="block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 sm:text-sm">
                                            <button type="button"
                                                class="btn-remove remove-item inline-flex justify-center items-center p-1 border border-red-300 text-xs font-medium rounded text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                                <span>🗑️</span> </button>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h3 class="text-lg font-medium text-gray-700 mb-2"><span>☑️</span> Asignaturas</h3>
                                    <div class="space-y-2">
                                        <div class="flex items-center">
                                            <input id="asig-lab" name="asignaturas[]" type="checkbox"
                                                value="Laboratorio de convergencia"
                                                class="h-4 w-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                                            <label for="asig-lab" class="ml-2 block text-sm text-gray-900">Laboratorio
                                                de convergencia</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input id="asig-cod" name="asignaturas[]" type="checkbox"
                                                value="Códigos y lenguajes"
                                                class="h-4 w-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                                            <label for="asig-cod" class="ml-2 block text-sm text-gray-900">Códigos y
                                                lenguajes</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input id="asig-hist" name="asignaturas[]" type="checkbox"
                                                value="Historia de las artes electrónicas"
                                                class="h-4 w-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                                            <label for="asig-hist" class="ml-2 block text-sm text-gray-900">Historia de
                                                las artes electrónicas</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input id="asig-mod" name="asignaturas[]" type="checkbox"
                                                value="Modelado 3D"
                                                class="h-4 w-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                                            <label for="asig-mod" class="ml-2 block text-sm text-gray-900">Modelado
                                                3D</label>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label for="ovc-semestre"
                                        class="block text-sm font-medium text-gray-700 mb-1"><span>📅</span>
                                        Año-Semestre</label> <select id="ovc-semestre" name="ovc-semestre"
                                        class="mt-1 block w-full rounded-md border-gray-300 py-2 pl-3 pr-10 text-base focus:border-pink-500 focus:outline-none focus:ring-pink-500 sm:text-sm">
                                        <option>2025-2</option>
                                        <option selected>2025-1</option>
                                        <option>2024-2</option>
                                        <option>2024-1</option>
                                        <option>2023-2</option>
                                        <option>2023-1</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="ovc-licencia"
                                        class="block text-sm font-medium text-gray-700 mb-1"><span>©️</span> Tipo de
                                        Licenciamiento</label> <select id="ovc-licencia" name="ovc-licencia"
                                        class="mt-1 block w-full rounded-md border-gray-300 py-2 pl-3 pr-10 text-base focus:border-pink-500 focus:outline-none focus:ring-pink-500 sm:text-sm">
                                        <option selected value="CC BY">Creative Commons Atribución (CC BY)</option>
                                        <option value="CC BY-SA">Creative Commons Atribución-CompartirIgual (CC BY-SA)
                                        </option>
                                        <option value="CC BY-NC">Creative Commons Atribución-NoComercial (CC BY-NC)
                                        </option>
                                        <option value="CC BY-ND">Creative Commons Atribución-SinDerivadas (CC BY-ND)
                                        </option>
                                        <option value="CC BY-NC-SA">Creative Commons
                                            Atribución-NoComercial-CompartirIgual (CC BY-NC-SA)</option>
                                        <option value="CC BY-NC-ND">Creative Commons Atribución-NoComercial-SinDerivadas
                                            (CC BY-NC-ND)</option>
                                        <option value="CC0">Creative Commons Dominio Público (CC0)</option>
                                        <option value="Proprietary">Propietario / Todos los derechos reservados</option>
                                    </select>
                                </div>
                            </div>
                            <div class="border-b border-gray-200 pb-6">
                                <div class="flex justify-between items-center mb-3">
                                    <h2 class="text-xl font-semibold text-gray-700"><span>🔗</span> Enlaces Externos
                                    </h2> <button type="button" id="add-enlace"
                                        class="btn-add inline-flex items-center px-3 py-1.5 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                        <span>➕</span> Añadir Enlace </button>
                                </div>
                                <div id="enlaces-container" class="space-y-4">
                                    <div
                                        class="enlace-item grid grid-cols-1 sm:grid-cols-3 gap-4 items-end p-4 border rounded-md bg-gray-50">
                                        <div class="sm:col-span-1">
                                            <label class="block text-xs font-medium text-gray-600"><span>ℹ️</span>
                                                Descripción</label> <input type="text" name="enlace_desc[]"
                                                placeholder="Ej: Repositorio GitHub"
                                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 sm:text-sm">
                                        </div>
                                        <div class="sm:col-span-1">
                                            <label class="block text-xs font-medium text-gray-600"><span>🔗</span>
                                                URL</label> <input type="url" name="enlace_url[]"
                                                placeholder="https://ejemplo.com"
                                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 sm:text-sm">
                                        </div>
                                        <button type="button"
                                            class="btn-remove remove-item self-end inline-flex justify-center items-center px-3 py-1.5 border border-red-300 text-sm font-medium rounded-md shadow-sm text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                            <span>🗑️</span> </button>
                                    </div>
                                </div>
                            </div>
                            <div class="border-b border-gray-200 pb-6">
                                <h2 class="text-xl font-semibold text-gray-700 mb-4"><span>📎</span> Archivo Principal
                                </h2>
                                <div>
                                    <label for="ovc-archivo"
                                        class="block text-sm font-medium text-gray-700 mb-1"><span>☁️</span> Subir
                                        archivo del OVC</label> <input type="file" id="ovc-archivo" name="ovc-archivo"
                                        class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-pink-50 file:text-pink-700 hover:file:bg-pink-100 custom-file-input">
                                    <span id="archivo-filename" class="text-xs text-gray-500 mt-1 block"></span>
                                </div>
                            </div>
                            <div class="border-b border-gray-200 pb-6">
                                <div class="flex justify-between items-center mb-3">
                                    <h2 class="text-xl font-semibold text-gray-700"><span>↔️</span> Relaciones con otros
                                        OVC</h2> <button type="button" id="add-relacion"
                                        class="btn-add inline-flex items-center px-3 py-1.5 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                        <span>➕</span> Añadir Relación </button>
                                </div>
                                <div id="relaciones-container" class="space-y-4">
                                    <div
                                        class="relacion-item grid grid-cols-1 sm:grid-cols-4 gap-4 items-end p-4 border rounded-md bg-gray-50">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-600"><span>🔗</span> OVC
                                                Relacionado</label> <input type="text" name="relacion_ovc[]"
                                                placeholder="Buscar o seleccionar OVC..."
                                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 sm:text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-600"><span>🏷️</span>
                                                Etiqueta de Relación</label> <input type="text"
                                                name="relacion_etiqueta[]" placeholder="Ej: Se basa en, Continúa"
                                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 sm:text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-600"><span>↔️</span>
                                                Dirección</label> <select name="relacion_direccion[]"
                                                class="mt-1 block w-full rounded-md border-gray-300 py-2 pl-3 pr-10 text-base focus:border-pink-500 focus:outline-none focus:ring-pink-500 sm:text-sm">
                                                <option value="saliente">Saliente (Este OVC -> Otro)</option>
                                                <option value="entrante">Entrante (Otro OVC -> Este)</option>
                                                <option value="bidireccional">Bidireccional</option>
                                            </select>
                                        </div>
                                        <button type="button"
                                            class="btn-remove remove-item self-end inline-flex justify-center items-center px-3 py-1.5 border border-red-300 text-sm font-medium rounded-md shadow-sm text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                            <span>🗑️</span> </button>
                                    </div>
                                </div>
                            </div>

                            <div class="flex justify-end pt-6">
                                <button type="submit" id="form-submit-button"
                                    class="inline-flex items-center justify-center py-2 px-6 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-pink-600 hover:bg-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500">
                                    <span class="mr-2">💾</span><span id="form-submit-button-text">Guardar OVC</span>
                                </button>
                            </div>
                        </form>
                    </div>


                    <div id="rizoma-section" class="hidden flex flex-col flex-1 min-h-0 h-full"> <!-- Added h-full -->

                        <div class="flex justify-between items-center mb-6">

                            <div class="relative">
                                <span class="search-icon">🔍</span>
                                <input type="text" placeholder="Buscar..." id="rizoma-search-input"
                                    class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-transparent">
                            </div>
                        </div>

                        <div class="bg-white rounded-lg shadow flex-1 flex flex-col text-gray-500 min-h-0 h-full">
                            <!-- Removed min-h-[600px] test class -->
                            <svg id="rizoma-graph" class="w-full h-full"></svg>
                        </div>
                    </div>

                    <!-- Placeholder for Kanban Board -->
                    <div id="kanban-section" class="hidden flex flex-col flex-1 min-h-0 h-full">
                        <!-- Kanban content will be loaded here -->
                    </div>

                </div>

        </div>


        </main>

    </div>

    </div>

    <div id="confirmation-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden"
        aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div id="modal-overlay" class="absolute inset-0 bg-gray-600 bg-opacity-75 modal-overlay"></div>
        <div class="modal-content bg-white rounded-lg shadow-xl overflow-hidden transform sm:max-w-md sm:w-full mx-4">
            <div class="px-6 py-4">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title"><span>✅</span> Confirmación
                    </h3> <button id="modal-close-button-x" type="button"
                        class="text-gray-400 hover:text-gray-600 text-2xl">
                        <span>❌</span> </button>
                </div>
                <div class="mt-4 text-center">
                    <span class="text-5xl mb-3 inline-block">✅</span>
                    <p class="text-lg text-gray-700" id="confirmation-modal-text">
                        ¡El OVC se ha guardado correctamente!
                    </p>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-3 text-right">
                <button id="modal-close-button-ok" type="button"
                    class="inline-flex items-center justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-pink-600 text-base font-medium text-white hover:bg-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500 sm:text-sm">
                    Aceptar
                </button>
            </div>
        </div>
    </div>

    <div id="delete-confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden"
        aria-labelledby="delete-modal-title" role="dialog" aria-modal="true">
        <div id="delete-modal-overlay" class="absolute inset-0 bg-gray-800 bg-opacity-60 modal-overlay"></div>
        <div class="modal-content bg-white rounded-lg shadow-xl overflow-hidden transform sm:max-w-lg sm:w-full mx-4">
            <div class="px-6 py-5">
                <div class="flex items-start">
                    <div
                        class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                        <span class="text-red-600 text-xl">⚠️</span>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="delete-modal-title">
                            Confirmar Eliminación
                        </h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-600">
                                ¿Estás seguro de que quieres eliminar este OVC? Esta acción no se puede deshacer.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-100 px-6 py-4 sm:flex sm:flex-row-reverse">
                <button id="delete-confirm-button" type="button"
                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Eliminar
                </button>
                <button id="delete-cancel-button" type="button"
                    class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <div id="ovc-summary-modal"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden transition-opacity duration-300"
        aria-labelledby="ovc-summary-modal-title" role="dialog" aria-modal="true">
        <div id="ovc-summary-modal-overlay" class="absolute inset-0 bg-gray-600 bg-opacity-75"></div>
        <div class="modal-content bg-white rounded-lg shadow-xl overflow-hidden transform sm:max-w-lg sm:w-full mx-4">
            <div class="px-6 py-4">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="ovc-summary-modal-title"><span></span>
                    </h3>
                    <button id="ovc-summary-modal-close" type="button"
                        class="text-gray-400 hover:text-gray-600 text-2xl">
                    </button>
                </div>
                <div class="mt-4">
                    <div id="ovc-summary-modal-content" class="flex flex-col space-y-4 items-start">
                        <!-- Aquí se llenará el contenido dinámicamente -->
                        <div class="flex-1">
                            <h4 class="text-md font-semibold text-gray-700">Detalles</h4>
                            <p class="text-sm text-gray-600">Aquí se mostrarán los detalles principales del OVC.</p>
                        </div>
                        <div class="flex-1">
                            <h4 class="text-md font-semibold text-gray-700">Autores</h4>
                            <ul class="list-disc list-inside text-sm text-gray-600">
                                <li>Autor 1</li>
                                <li>Autor 2</li>
                            </ul>
                        </div>
                        <div class="flex-1">
                            <h4 class="text-md font-semibold text-gray-700">Etiquetas</h4>
                            <span
                                class="inline-block bg-gray-200 text-gray-700 text-xs font-medium px-2 py-1 rounded">Etiqueta
                                1</span>
                            <span
                                class="inline-block bg-gray-200 text-gray-700 text-xs font-medium px-2 py-1 rounded">Etiqueta
                                2</span>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-6 py-3 text-right">
                    <button id="ovc-summary-modal-ok" type="button"
                        class="inline-flex items-center justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-pink-600 text-base font-medium text-white hover:bg-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500 sm:text-sm">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="rizoma.js"></script>
    <script>
        /**
         * ADVERTENCIA IMPORTANTE SOBRE LOCALSTORAGE Y ARCHIVOS:
         * Guardar imágenes (o archivos grandes) como Base64 en localStorage
         * NO es recomendable para aplicaciones reales. localStorage tiene límites
         * de tamaño estrictos (5-10MB) que se alcanzan rápidamente.
         * La solución estándar es subir los archivos a un servidor y guardar
         * solo la URL en localStorage o en una base de datos.
         * Esta implementación con Base64 es solo para fines de DEMOSTRACIÓN
         * en este entorno limitado.
         */
        // Función para obtener OVCs desde localStorage
        function getOvcsFromStorage() {
            const ovcsJson = localStorage.getItem('ovcData');
            try {
                return ovcsJson ? JSON.parse(ovcsJson) : [];
            } catch (e) {
                console.error("Error al analizar los datos de OVC:", e);
                return [];
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const summaryModal = document.getElementById('ovc-summary-modal');
            const summaryModalOverlay = document.getElementById('ovc-summary-modal-overlay');
            const summaryModalClose = document.getElementById('ovc-summary-modal-close');
            const summaryModalOk = document.getElementById('ovc-summary-modal-ok');
            const summaryModalContent = document.getElementById('ovc-summary-modal-content');

            // Función para mostrar el modal con el resumen del OVC
            window.showSummaryModal = function (ovcId) { // Hacer la función global
                const ovcs = getOvcsFromStorage();
                const ovc = ovcs.find(ovc => ovc.id === Number(ovcId));

                if (!ovc) {
                    console.error(`Error: No se encontró el OVC con ID ${ovcId}`);
                    return;
                }

                // Generar contenido del resumen
                summaryModalContent.innerHTML = `
            <div class="p-4 bg-white rounded-lg shadow-lg space-y-4">
                <div>
                    ${ovc.imagen && ovc.imagen.dataUrl ? `<img src="${ovc.imagen.dataUrl}" alt="Imagen de Portada" class="w-full h-auto rounded-md">` : '<span>No disponible</span>'}
                </div>
                <div>
                    <strong>Título:</strong> ${ovc.titulo || 'N/A'}
                </div>
                <div>
                    <strong>Descripción:</strong> ${ovc.descripcion || 'N/A'}
                </div>
                <div>
                    <strong>Autores:</strong> ${ovc.autores.map(a => `${a.nombre} (${a.rol})`).join(', ') || 'N/A'}
                </div>
                <div>
                    <strong>Semestre:</strong> ${ovc.semestre || 'N/A'}
                </div>
                <div>
                    <strong>Etiquetas:</strong> ${ovc.etiquetas.join(', ') || 'N/A'}
                </div>
                <div>
                    <strong>Relaciones:</strong> ${ovc.relaciones.map(r => `${r.ovc} (${r.etiqueta})`).join(', ') || 'N/A'}
                </div>
                <div>
                    <strong>Enlaces Externos:</strong><br>
                    ${ovc.enlaces.map(e => `<a href="${e.url}" target="_blank" class="text-blue-600 underline">${e.descripcion}</a>`).join('<br>') || 'N/A'}
                </div>
            </div>
        `;

                // Mostrar el modal con animación
                summaryModal.classList.remove('hidden');
                summaryModal.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                setTimeout(() => {
                    summaryModal.classList.remove('opacity-0');
                }, 10);
            }

            // Función para ocultar el modal
            function hideSummaryModal() {
                summaryModal.classList.add('hidden');
            }

            // Listeners para cerrar el modal
            summaryModalOverlay.addEventListener('click', hideSummaryModal);
            summaryModalClose.addEventListener('click', hideSummaryModal);
            summaryModalOk.addEventListener('click', hideSummaryModal);

            // Listener para el botón "Ver"
            const ovcTableBody = document.getElementById('ovc-table-body');
            if (ovcTableBody) {
                ovcTableBody.addEventListener('click', function (event) {
                    const viewButton = event.target.closest('.view-ovc-btn');
                    if (viewButton) {
                        event.preventDefault();
                        const ovcId = viewButton.getAttribute('data-id');
                        showSummaryModal(ovcId);
                    }
                });
            }
        });
        document.addEventListener('DOMContentLoaded', function () {
            // --- Selección de Elementos ---
            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            const contentArea = document.getElementById('content-area');
            const sectionTitle = document.getElementById('section-title');
            const ovcTableBody = document.getElementById('ovc-table-body');
            const goToCreateBtn = document.getElementById('go-to-create-btn');
            const crearOvcForm = document.getElementById('crear-ovc-form');
            const formSubmitButton = document.getElementById('form-submit-button');
            const formSubmitButtonText = document.getElementById('form-submit-button-text');
            const editOvcIdInput = document.getElementById('edit-ovc-id');
            const imagenInput = document.getElementById('ovc-imagen');
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const imagenFilenameSpan = document.getElementById('imagen-filename');
            const imagenDataUrlInput = document.getElementById('imagen-data-url'); // Input oculto para DataURL
            const archivoInput = document.getElementById('ovc-archivo');
            const archivoFilenameSpan = document.getElementById('archivo-filename');
            const confirmationModal = document.getElementById('confirmation-modal');
            const confirmationModalText = document.getElementById('confirmation-modal-text');
            const modalOverlay = document.getElementById('modal-overlay');
            const modalCloseButtonX = document.getElementById('modal-close-button-x');
            const modalCloseButtonOk = document.getElementById('modal-close-button-ok');
            const deleteConfirmModal = document.getElementById('delete-confirm-modal');
            const deleteModalOverlay = document.getElementById('delete-modal-overlay');
            const deleteConfirmButton = document.getElementById('delete-confirm-button');
            const deleteCancelButton = document.getElementById('delete-cancel-button');

            const sections = {
                crear: document.getElementById('crear-section'),
                listar: document.getElementById('listar-section'),
                rizoma: document.getElementById('rizoma-section'),
                kanban: document.getElementById('kanban-section') // Added Kanban section
                // Rubric sections are handled differently (iframe)
            };
            const sectionTitles = {
                crear: '<span>➕</span> Crear Nuevo Objeto Virtual Creativo',
                listar: '<span>📋</span> Mis objetos virtuales creativos',
                rizoma: '<span>🌱</span> Visualización del Rizoma',
                kanban: '<span>📋</span> Tablero Kanban', // Added Kanban title
                // Titles for rubric pages will be set dynamically
            };
            const OVC_STORAGE_KEY = 'ovcData';

            // --- Estado de Edición ---
            let isEditMode = false;
            let currentEditOvcId = null;
            let ovcIdToDeleteConfirm = null;

            // --- Navegación ---
            function showSection(sectionId) {
                console.log(`DEBUG: Mostrando sección interna: ${sectionId}`);
                // Clear iframe if it exists
                const contentArea = document.getElementById('content-area');
                const existingIframe = contentArea.querySelector('iframe');
                if (existingIframe) {
                    existingIframe.remove();
                }

                // Hide all regular sections
                Object.values(sections).forEach(section => {
                    if (section) section.classList.add('hidden');
                });
                // Deactivate all links first
                sidebarLinks.forEach(link => link.classList.remove('active'));
                // Deactivate rubric parent toggle if active
                rubricasToggle.classList.remove('active');


                const activeSection = sections[sectionId];
                if (activeSection) {
                    activeSection.classList.remove('hidden');
                } else {
                    console.warn(`Sección con ID '${sectionId}' no encontrada.`);
                }


                if (sectionId !== 'crear' && isEditMode) {
                    resetFormToCreateMode();
                }

                if (sectionTitles[sectionId]) {
                    sectionTitle.innerHTML = sectionTitles[sectionId];
                }

                // Activate the correct link
                const activeLink = document.querySelector(`.sidebar-link[data-section="${sectionId}"]`);
                if (activeLink) {
                    activeLink.classList.add('active');
                }


                if (sectionId === 'listar') {
                    renderOvcTable();
                } else if (sectionId === 'crear' && !isEditMode) {
                    resetFormToCreateMode();
                } else if (sectionId === 'rizoma') {
                    // Retrasar ligeramente la renderización para dar tiempo al layout
                    setTimeout(() => {
                        console.log("DEBUG: Llamando a renderRizomaGraph desde showSection (retrasado)");
                        renderRizomaGraph(); // Renderizar el grafo
                    }, 50); // Un retraso corto debería ser suficiente
                } else if (sectionId === 'kanban') {
                    const kanbanSection = sections['kanban'];
                    if (kanbanSection && !kanbanSection.dataset.loaded) { // Check a flag
                        console.log("DEBUG: Cargando contenido de kanban.html...");
                        fetch('kanban.html')
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                return response.text();
                            })
                            .then(html => {
                                const parser = new DOMParser();
                                const doc = parser.parseFromString(html, 'text/html');

                                // Extract specific elements needed for Kanban
                                const title = doc.querySelector('h1'); // First h1
                                const description = doc.querySelector('p'); // First p
                                const container = doc.querySelector('.kanban-container');
                                const contextMenu = doc.getElementById('contextMenu');
                                const taskModal = doc.getElementById('taskModal');

                                if (title && description && container && contextMenu && taskModal) {
                                    // Clear previous content and append new elements
                                    kanbanSection.innerHTML = '';
                                    kanbanSection.appendChild(title.cloneNode(true));
                                    kanbanSection.appendChild(description.cloneNode(true));
                                    kanbanSection.appendChild(container.cloneNode(true));
                                    kanbanSection.appendChild(contextMenu.cloneNode(true));
                                    kanbanSection.appendChild(taskModal.cloneNode(true));
                                    kanbanSection.dataset.loaded = 'true'; // Set flag

                                    console.log("DEBUG: Contenido de Kanban cargado. Inicializando KanbanApp con retraso...");

                                    // Initialize KanbanApp after a short delay to ensure DOM is ready
                                    setTimeout(() => {
                                        if (typeof KanbanApp !== 'undefined' && typeof KanbanApp.init === 'function') {
                                            KanbanApp.init();
                                        } else {
                                            console.error("KanbanApp o KanbanApp.init no está definido al intentar inicializar.");
                                        }
                                    }, 50); // 50ms delay

                                } else {
                                    console.error("Error: No se pudieron encontrar todos los elementos necesarios en kanban.html.");
                                    kanbanSection.innerHTML = '<p class="text-red-500">Error al extraer contenido del tablero Kanban.</p>';
                                }
                            })
                            .catch(error => {
                                console.error('Error al cargar o procesar kanban.html:', error);
                                kanbanSection.innerHTML = '<p class="text-red-500">Error al cargar el tablero Kanban.</p>';
                                delete kanbanSection.dataset.loaded; // Reset flag on error
                            });
                    } else if (kanbanSection) {
                        console.log("DEBUG: Sección Kanban ya cargada, mostrando.");
                        // If already loaded, just ensure it's visible. Re-init might be needed if state can change externally.
                    }
                }
            }

            // --- Navigation Handling ---
            sidebarLinks.forEach(link => {
                link.addEventListener('click', function (event) {
                    const sectionId = this.getAttribute('data-section');
                    const isSubmenuLink = this.classList.contains('submenu-link');
                    const targetUrl = this.getAttribute('href');

                    if (sectionId) {
                        // Handle regular section toggle
                        event.preventDefault();
                        showSection(sectionId);
                        // Ensure submenu is closed if a main section is clicked
                        if (!this.closest('.submenu') && rubricasSubmenu.classList.contains('open')) {
                            rubricasToggle.click(); // Simulate click to close
                        }
                    } else if (isSubmenuLink && targetUrl && targetUrl !== '#') {
                        // Handle rubric submenu link click (load in iframe)
                        event.preventDefault();
                        loadPageInContentArea(targetUrl, this);
                    }
                    // Allow default behavior for other links (like the main Rubricas toggle)
                });
            });
            if (goToCreateBtn) { /* ... */
                goToCreateBtn.addEventListener('click', () => {
                    resetFormToCreateMode();
                    showSection('crear');
                });
            }

            // --- LocalStorage y Renderizado Tabla ---

            function saveOvcsToStorage(ovcs) {
                try {
                    if (!Array.isArray(ovcs)) { console.error("Error: Not an array:", ovcs); return; }
                    const dataToSave = JSON.stringify(ovcs);
                    // console.log(`DEBUG: Guardando en localStorage (${OVC_STORAGE_KEY}):`, dataToSave); // Opcional: muy verboso con Base64
                    localStorage.setItem(OVC_STORAGE_KEY, dataToSave);
                    console.log("DEBUG: Guardado/Actualizado exitoso en localStorage.");
                } catch (e) {
                    console.error("Error saving OVC data to localStorage:", e);
                    // Podría ser un error de cuota si las imágenes son muy grandes
                    if (e.name === 'QuotaExceededError') {
                        alert('Error: No se pudo guardar. El almacenamiento local está lleno.\n(Guardar imágenes directamente tiene límites).');
                    } else {
                        alert('Error inesperado al guardar los datos.');
                    }
                }
            }
            function renderOvcTable() { /* ... código sin cambios ... */
                if (!ovcTableBody) return;
                const ovcs = getOvcsFromStorage();
                ovcTableBody.innerHTML = '';
                const paginationStart = document.getElementById('pagination-start');
                const paginationEnd = document.getElementById('pagination-end');
                const paginationTotal = document.getElementById('pagination-total');
                if (paginationStart && paginationEnd && paginationTotal) {
                    paginationStart.textContent = ovcs.length > 0 ? '1' : '0';
                    paginationEnd.textContent = ovcs.length;
                    paginationTotal.textContent = ovcs.length;
                }
                if (ovcs.length === 0) {
                    ovcTableBody.innerHTML = `<tr class="empty-table-row"><td colspan="6">No hay OVCs guardados.</td></tr>`;
                } else {
                    ovcs.forEach((ovc) => {
                        const row = document.createElement('tr');
                        const truncate = (str, num) => str && str.length > num ? str.slice(0, num) + "..." : str;
                        const displayAutores = (autores) => {
                            if (!autores || !Array.isArray(autores) || autores.length === 0) return 'N/A';
                            const firstAuthor = autores[0].nombre || 'Autor Desconocido';
                            const remainingCount = autores.length - 1;
                            return `${firstAuthor}${remainingCount > 0 ? ` (+${remainingCount})` : ''}`;
                        };
                        const asignaturasStr = Array.isArray(ovc.asignaturas) ? ovc.asignaturas.join(', ') : '';
                        const etiquetasStr = Array.isArray(ovc.etiquetas) ? ovc.etiquetas.join(', ') : '';
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${ovc.titulo || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${displayAutores(ovc.autores)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${truncate(asignaturasStr, 30) || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ovc.semestre || 'N/A'}</td>
                            <td class="px-6 py-4 text-sm text-gray-500 break-words">${truncate(etiquetasStr, 40) || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <a href="#" class="text-indigo-600 hover:text-indigo-900 action-btn edit-ovc-btn" title="Editar" data-id="${ovc.id}">✏️</a>
                                <a href="#" class="text-blue-600 hover:text-blue-900 ml-4 action-btn view-ovc-btn" title="Ver" data-id="${ovc.id}">🔍</a>
                                <a href="#" class="text-red-600 hover:text-red-900 ml-4 action-btn delete-ovc-btn" title="Eliminar" data-id="${ovc.id}">🗑️</a>
                            </td>
                        `;
                        ovcTableBody.appendChild(row);
                    });
                }
            }

            // --- Funcionalidad Formulario Crear/Editar OVC ---

            // Previsualización de Imagen (con Base64)
            if (imagenInput && imagePreviewContainer && imagenFilenameSpan && imagenDataUrlInput) {
                imagenInput.addEventListener('change', function (event) {
                    console.log("DEBUG: Evento 'change' detectado en input de imagen.");
                    const file = event.target.files[0];
                    imagenDataUrlInput.value = ''; // Limpiar DataURL anterior
                    imagenFilenameSpan.dataset.originalName = ''; // Limpiar nombre anterior

                    if (file && file.type.startsWith('image/')) {
                        imagenFilenameSpan.textContent = `Procesando: ${file.name}...`; // Mensaje mientras carga
                        imagePreviewContainer.innerHTML = '<span>Cargando...</span>';
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            const dataUrl = e.target.result;
                            console.log("DEBUG: FileReader cargó la imagen como DataURL (tamaño aprox:", Math.round(dataUrl.length / 1024), "KB)");
                            if (dataUrl.length > 5 * 1024 * 1024) { // Advertencia si > 5MB (aproximado)
                                console.warn("ADVERTENCIA: La imagen es muy grande, podría llenar localStorage.");
                                alert("Advertencia: La imagen seleccionada es muy grande y podría causar problemas de almacenamiento.");
                            }
                            imagePreviewContainer.innerHTML = `<img src="${dataUrl}" alt="Previsualización">`;
                            imagenDataUrlInput.value = dataUrl; // Guardar DataURL temporalmente
                            imagenFilenameSpan.dataset.originalName = file.name; // Guardar nombre original
                            imagenFilenameSpan.textContent = `Nuevo archivo: ${file.name}`; // Actualizar span
                        }
                        reader.onerror = function (e) { /* ... error handling ... */
                            console.error("DEBUG: Error de FileReader:", e);
                            imagenFilenameSpan.textContent = 'Error al leer archivo';
                            imagePreviewContainer.innerHTML = '<span>Error</span>';
                        }
                        reader.readAsDataURL(file);
                    } else if (file) { /* ... archivo no imagen ... */
                        console.warn("DEBUG: Tipo de archivo no soportado:", file.type);
                        imagenFilenameSpan.textContent = `Archivo ${file.name} no es una imagen.`;
                        imagePreviewContainer.innerHTML = '<span>No es imagen</span>';
                        imagenInput.value = '';
                    } else { /* ... no se seleccionó archivo ... */
                        console.log("DEBUG: No se seleccionó archivo.");
                        imagenFilenameSpan.textContent = isEditMode ? imagenFilenameSpan.textContent : '';
                        imagePreviewContainer.innerHTML = isEditMode ? imagePreviewContainer.innerHTML : '<span>Previsualización</span>';
                    }
                });
            } else { console.warn("DEBUG: Faltan elementos para previsualización."); }

            // Nombre archivo principal (sin cambios)
            if (archivoInput && archivoFilenameSpan) { /* ... */
                archivoInput.addEventListener('change', function (event) {
                    const file = event.target.files[0];
                    if (file) { archivoFilenameSpan.textContent = `Archivo seleccionado: ${file.name}`; }
                    else { if (!isEditMode) { archivoFilenameSpan.textContent = ''; } }
                });
            }

            // Listas dinámicas (sin cambios)
            function setupDynamicList(containerId, addButtonId, itemSelector) { /* ... */
                const container = document.getElementById(containerId);
                const addButton = document.getElementById(addButtonId);
                if (!container || !addButton) return;
                const template = container.querySelector(itemSelector);
                if (!template) return;
                const templateHTML = template.cloneNode(true);
                addButton.addEventListener('click', () => { /* ... */
                    const newItem = templateHTML.cloneNode(true);
                    newItem.querySelectorAll('input, select, textarea').forEach(input => {
                        if (input.type === 'checkbox' || input.type === 'radio') input.checked = false;
                        else input.value = '';
                    });
                    container.appendChild(newItem);
                });
                container.addEventListener('click', (event) => { /* ... */
                    const removeButton = event.target.closest('.remove-item');
                    if (removeButton) {
                        const itemToRemove = removeButton.closest(itemSelector);
                        if (container.querySelectorAll(itemSelector).length > 1) {
                            if (itemToRemove) itemToRemove.remove();
                        } else {
                            itemToRemove.querySelectorAll('input, select, textarea').forEach(input => {
                                if (input.type === 'checkbox' || input.type === 'radio') input.checked = false;
                                else input.value = '';
                            });
                        }
                    }
                });
            }
            setupDynamicList('autores-container', 'add-autor', '.autor-item');
            setupDynamicList('etiquetas-container', 'add-etiqueta', '.etiqueta-item');
            setupDynamicList('enlaces-container', 'add-enlace', '.enlace-item');
            setupDynamicList('relaciones-container', 'add-relacion', '.relacion-item');

            // --- Lógica de Edición ---
            function populateFormForEdit(ovcId) {
                console.log(`DEBUG: Iniciando populateFormForEdit para ID: ${ovcId}`);
                const ovcs = getOvcsFromStorage();
                const ovcData = ovcs.find(ovc => ovc.id === Number(ovcId));

                if (!ovcData) { /* ... error handling ... */
                    console.error(`Error: No se encontró OVC con ID ${ovcId} para editar.`);
                    resetFormToCreateMode(); return;
                }

                // console.log("DEBUG: Datos del OVC a editar:", ovcData); // Opcional: puede ser muy verboso con Base64
                isEditMode = true;
                currentEditOvcId = ovcData.id;
                editOvcIdInput.value = ovcData.id;
                // El título de la sección 'crear' se actualiza en showSection
                // Ya no se necesita manipular #crear-title aquí.
                formSubmitButtonText.textContent = 'Actualizar OVC';

                // Rellenar campos simples
                document.getElementById('ovc-titulo').value = ovcData.titulo || '';
                document.getElementById('ovc-descripcion').value = ovcData.descripcion || '';
                document.getElementById('ovc-semestre').value = ovcData.semestre || '2025-1';
                document.getElementById('ovc-licencia').value = ovcData.licencia || 'CC BY';

                // --- Manejo de Imagen Guardada (Base64) ---
                imagenInput.value = ''; // Limpiar input file
                imagenDataUrlInput.value = ''; // Limpiar DataURL temporal
                if (ovcData.imagen && ovcData.imagen.dataUrl && typeof ovcData.imagen.dataUrl === 'string' && ovcData.imagen.dataUrl.startsWith('data:image')) {
                    console.log("DEBUG: Mostrando imagen guardada (Base64)");
                    imagePreviewContainer.innerHTML = `<img src="${ovcData.imagen.dataUrl}" alt="Previsualización guardada">`;
                    imagenFilenameSpan.textContent = `Archivo actual: ${ovcData.imagen.filename || 'Desconocido'}`;
                    // Guardar nombre original en data attribute por si no se cambia la imagen
                    imagenFilenameSpan.dataset.originalName = ovcData.imagen.filename || '';
                } else {
                    console.log("DEBUG: No hay imagen guardada o dataUrl inválido.");
                    imagePreviewContainer.innerHTML = '<span>No hay imagen guardada</span>';
                    imagenFilenameSpan.textContent = '';
                    imagenFilenameSpan.dataset.originalName = '';
                }

                // Archivo principal (solo nombre)
                archivoFilenameSpan.textContent = ovcData.archivo ? `Archivo actual: ${ovcData.archivo.replace('Archivo seleccionado: ', '')}` : '';
                archivoInput.value = '';

                // Rellenar checkboxes y listas dinámicas (sin cambios)
                document.querySelectorAll('input[name="asignaturas[]"]').forEach(checkbox => { /* ... */
                    checkbox.checked = ovcData.asignaturas?.includes(checkbox.value) || false;
                });
                populateDynamicListField('autores-container', '.autor-item', ovcData.autores || [], (item, data) => { /* ... */
                    item.querySelector('input[name="autor_nombre[]"]').value = data.nombre || '';
                    item.querySelector('input[name="autor_rol[]"]').value = data.rol || '';
                    item.querySelector('input[name="autor_email[]"]').value = data.email || '';
                    item.querySelector('input[name="autor_participacion[]"]').value = data.participacion || '';
                });
                populateDynamicListField('etiquetas-container', '.etiqueta-item', ovcData.etiquetas || [], (item, data) => { /* ... */
                    item.querySelector('input[name="etiquetas[]"]').value = data || '';
                });
                populateDynamicListField('enlaces-container', '.enlace-item', ovcData.enlaces || [], (item, data) => { /* ... */
                    item.querySelector('input[name="enlace_desc[]"]').value = data.descripcion || '';
                    item.querySelector('input[name="enlace_url[]"]').value = data.url || '';
                });
                populateDynamicListField('relaciones-container', '.relacion-item', ovcData.relaciones || [], (item, data) => { /* ... */
                    item.querySelector('input[name="relacion_ovc[]"]').value = data.ovc || '';
                    item.querySelector('input[name="relacion_etiqueta[]"]').value = data.etiqueta || '';
                    item.querySelector('select[name="relacion_direccion[]"]').value = data.direccion || 'saliente';
                });

                console.log("DEBUG: Formulario poblado para edición.");
            }

            // Helper para poblar listas dinámicas (sin cambios)
            function populateDynamicListField(containerId, itemSelector, dataArray, fillFunction) { /* ... código sin cambios ... */
                const container = document.getElementById(containerId);
                if (!container) return;
                const template = container.querySelector(itemSelector);
                if (!template) return;
                container.querySelectorAll(`${itemSelector}:not(:first-child)`).forEach(el => el.remove());
                const firstItem = container.querySelector(itemSelector);
                if (!Array.isArray(dataArray) || dataArray.length === 0) {
                    firstItem.querySelectorAll('input, select, textarea').forEach(input => {
                        if (input.type === 'checkbox' || input.type === 'radio') input.checked = false;
                        else input.value = '';
                    });
                } else {
                    dataArray.forEach((data, index) => {
                        let currentItem = (index === 0) ? firstItem : template.cloneNode(true);
                        if (index > 0) container.appendChild(currentItem);
                        fillFunction(currentItem, data);
                    });
                }
            }

            // Función para resetear el formulario a modo creación (actualizada para DataURL)
            function resetFormToCreateMode() {
                console.log("DEBUG: Reseteando formulario a modo creación.");
                isEditMode = false;
                currentEditOvcId = null;
                editOvcIdInput.value = '';
                // crearTitle.innerHTML = '<span>➕</span> Crear Nuevo Objeto Virtual Creativo'; // Eliminado: Título gestionado por showSection
                formSubmitButtonText.textContent = 'Guardar OVC';
                crearOvcForm.reset();
                if (imagePreviewContainer) imagePreviewContainer.innerHTML = '<span>Previsualización</span>';
                if (imagenFilenameSpan) {
                    imagenFilenameSpan.textContent = '';
                    imagenFilenameSpan.dataset.originalName = ''; // Limpiar data attribute
                }
                if (archivoFilenameSpan) archivoFilenameSpan.textContent = '';
                if (imagenDataUrlInput) imagenDataUrlInput.value = ''; // Limpiar DataURL oculto
                // Limpiar listas dinámicas
                ['autores-container', 'etiquetas-container', 'enlaces-container', 'relaciones-container'].forEach(containerId => { /* ... */
                    const container = document.getElementById(containerId);
                    if (!container) return;
                    const itemSelector = `#${containerId} > div`;
                    container.querySelectorAll(`${itemSelector}:not(:first-child)`).forEach(el => el.remove());
                    const firstItem = container.querySelector(itemSelector);
                    if (firstItem) {
                        firstItem.querySelectorAll('input, select, textarea').forEach(input => {
                            if (input.type === 'checkbox' || input.type === 'radio') input.checked = false;
                            else input.value = '';
                        });
                    }
                });
                console.log("DEBUG: Formulario reseteado.");
            }


            // --- Guardado (Crear y Actualizar) y Modal Confirmación ---
            function showConfirmationModal(isUpdate = false) { /* ... código sin cambios ... */
                if (confirmationModal) {
                    confirmationModalText.textContent = isUpdate ? '¡El OVC se ha actualizado correctamente!' : '¡El OVC se ha guardado correctamente!';
                    confirmationModal.classList.remove('hidden');
                    modalOverlay.classList.add('opacity-100');
                    confirmationModal.querySelector('.modal-content').classList.add('scale-100');
                }
            }
            function hideConfirmationModal() { /* ... código sin cambios ... */
                if (confirmationModal) {
                    modalOverlay.classList.remove('opacity-100');
                    confirmationModal.querySelector('.modal-content').classList.remove('scale-100');
                    setTimeout(() => { confirmationModal.classList.add('hidden'); }, 300);
                }
            }

            // Submit del formulario (Maneja Crear y Actualizar con Base64)
            if (crearOvcForm) {
                crearOvcForm.addEventListener('submit', function (event) {
                    event.preventDefault();
                    console.log(`DEBUG: Formulario enviado. Modo Edición: ${isEditMode}`);

                    const ovcs = getOvcsFromStorage();
                    let originalOvc = null;
                    if (isEditMode && currentEditOvcId) {
                        originalOvc = ovcs.find(ovc => ovc.id === Number(currentEditOvcId));
                    }

                    // --- Recolectar Imagen (Base64) ---
                    let imagenData = null;
                    const newDataUrl = imagenDataUrlInput.value; // Obtener DataURL del input oculto
                    const newFilename = imagenFilenameSpan.dataset.originalName; // Obtener nombre original del data attribute

                    if (newDataUrl && newFilename) {
                        imagenData = { dataUrl: newDataUrl, filename: newFilename };
                        console.log("DEBUG: Usando nueva imagen Base64.");
                    } else if (isEditMode && originalOvc && originalOvc.imagen) {
                        imagenData = originalOvc.imagen;
                        console.log("DEBUG: Conservando imagen Base64 original.");
                    } else {
                        console.log("DEBUG: No hay imagen nueva ni original.");
                    }

                    // 1. Recolectar datos
                    const formData = {
                        id: isEditMode ? Number(currentEditOvcId) : Date.now(),
                        titulo: document.getElementById('ovc-titulo')?.value || '',
                        descripcion: document.getElementById('ovc-descripcion')?.value || '',
                        imagen: imagenData, // Guardar objeto {dataUrl, filename} o null
                        autores: [],
                        etiquetas: [],
                        asignaturas: [],
                        semestre: document.getElementById('ovc-semestre')?.value || '',
                        licencia: document.getElementById('ovc-licencia')?.value || '',
                        enlaces: [],
                        archivo: archivoInput.files.length > 0 ? `Archivo seleccionado: ${archivoInput.files[0].name}` : (originalOvc ? originalOvc.archivo : ''),
                        relaciones: [],
                        fechaCreacion: isEditMode && originalOvc ? originalOvc.fechaCreacion : new Date().toISOString()
                    };
                    // ... (recolección de autores, etiquetas, etc. - sin cambios) ...
                    document.querySelectorAll('#autores-container .autor-item').forEach(item => { /* ... */
                        const nombre = item.querySelector('input[name="autor_nombre[]"]')?.value || '';
                        if (nombre.trim() !== '') {
                            formData.autores.push({
                                nombre: nombre,
                                rol: item.querySelector('input[name="autor_rol[]"]')?.value || '',
                                email: item.querySelector('input[name="autor_email[]"]')?.value || '',
                                participacion: item.querySelector('input[name="autor_participacion[]"]')?.value || ''
                            });
                        }
                    });
                    document.querySelectorAll('#etiquetas-container .etiqueta-item input').forEach(input => { /* ... */
                        if (input.value.trim()) formData.etiquetas.push(input.value.trim());
                    });
                    document.querySelectorAll('input[name="asignaturas[]"]:checked').forEach(checkbox => { /* ... */
                        formData.asignaturas.push(checkbox.value);
                    });
                    document.querySelectorAll('#enlaces-container .enlace-item').forEach(item => { /* ... */
                        const desc = item.querySelector('input[name="enlace_desc[]"]')?.value || '';
                        const url = item.querySelector('input[name="enlace_url[]"]')?.value || '';
                        if (desc.trim() && url.trim()) { formData.enlaces.push({ descripcion: desc, url: url }); }
                    });
                    document.querySelectorAll('#relaciones-container .relacion-item').forEach(item => { /* ... */
                        const ovcRel = item.querySelector('input[name="relacion_ovc[]"]')?.value || '';
                        const etiquetaRel = item.querySelector('input[name="relacion_etiqueta[]"]')?.value || '';
                        const direccionRel = item.querySelector('select[name="relacion_direccion[]"]')?.value || '';
                        if (ovcRel.trim() && etiquetaRel.trim()) { formData.relaciones.push({ ovc: ovcRel, etiqueta: etiquetaRel, direccion: direccionRel }); }
                    });

                    console.log("DEBUG: Datos recolectados finales:", formData);

                    // 2. Guardar o Actualizar en localStorage
                    if (isEditMode) {
                        const index = ovcs.findIndex(ovc => ovc.id === formData.id);
                        if (index !== -1) {
                            console.log(`DEBUG: Actualizando OVC en índice ${index}`);
                            ovcs[index] = formData;
                            saveOvcsToStorage(ovcs);
                            showConfirmationModal(true);
                            resetFormToCreateMode();
                            showSection('listar');
                        } else { /* ... error handling ... */
                            console.error(`Error: No se encontró OVC con ID ${formData.id} para actualizar.`);
                            alert("Error al actualizar el OVC. No se encontró el original.");
                            resetFormToCreateMode();
                        }
                    } else {
                        console.log("DEBUG: Creando nuevo OVC.");
                        ovcs.push(formData);
                        saveOvcsToStorage(ovcs);
                        showConfirmationModal(false);
                        resetFormToCreateMode();
                    }
                });
            }

            // Cerrar modal de confirmación
            if (modalOverlay) modalOverlay.addEventListener('click', hideConfirmationModal);
            if (modalCloseButtonX) modalCloseButtonX.addEventListener('click', hideConfirmationModal);
            if (modalCloseButtonOk) modalCloseButtonOk.addEventListener('click', hideConfirmationModal);

            // --- Funcionalidad de Borrado (con Modal) ---
            function showDeleteConfirmModal(ovcId) { /* ... código sin cambios ... */
                ovcIdToDeleteConfirm = ovcId;
                if (deleteConfirmModal) {
                    console.log(`DEBUG: Mostrando modal de confirmación de borrado para ID: ${ovcId}`);
                    deleteConfirmModal.classList.remove('hidden');
                }
            }
            function hideDeleteConfirmModal() { /* ... código sin cambios ... */
                ovcIdToDeleteConfirm = null;
                if (deleteConfirmModal) {
                    console.log("DEBUG: Ocultando modal de confirmación de borrado.");
                    deleteConfirmModal.classList.add('hidden');
                }
            }

            // Listener para botones dentro del modal de borrado
            if (deleteCancelButton) deleteCancelButton.addEventListener('click', hideDeleteConfirmModal);
            if (deleteModalOverlay) deleteModalOverlay.addEventListener('click', hideDeleteConfirmModal);

            if (deleteConfirmButton) { /* ... código sin cambios ... */
                deleteConfirmButton.addEventListener('click', () => {
                    if (ovcIdToDeleteConfirm) {
                        console.log(`DEBUG: Confirmado borrado para ID: ${ovcIdToDeleteConfirm}`);
                        const ovcs = getOvcsFromStorage();
                        const updatedOvcs = ovcs.filter(ovc => ovc.id !== Number(ovcIdToDeleteConfirm));
                        if (ovcs.length === updatedOvcs.length) {
                            console.warn(`DEBUG: No se encontró OVC con ID ${ovcIdToDeleteConfirm} para borrar.`);
                        } else {
                            saveOvcsToStorage(updatedOvcs);
                            console.log("DEBUG: OVC eliminado. Renderizando tabla de nuevo...");
                            renderOvcTable();
                        }
                    } else { console.error("Error: No se encontró ID para borrar al confirmar."); }
                    hideDeleteConfirmModal();
                });
            }

            // Listener para clics en la tabla (Editar y Borrar)
            if (ovcTableBody) { /* ... código sin cambios ... */
                ovcTableBody.addEventListener('click', function (event) {
                    const editButton = event.target.closest('.edit-ovc-btn');
                    const deleteButton = event.target.closest('.delete-ovc-btn');

                    if (editButton) {
                        event.preventDefault();
                        const ovcIdToEdit = editButton.getAttribute('data-id');
                        console.log(`DEBUG: Clic en Editar para ID: ${ovcIdToEdit}`);
                        if (ovcIdToEdit) {
                            populateFormForEdit(ovcIdToEdit);
                            showSection('crear');
                        }
                    } else if (deleteButton) {
                        event.preventDefault();
                        const ovcIdToDelete = deleteButton.getAttribute('data-id');
                        console.log(`DEBUG: Clic en Borrar para ID: ${ovcIdToDelete}`);
                        if (ovcIdToDelete) {
                            showDeleteConfirmModal(ovcIdToDelete);
                        }
                    }
                });
            } else { console.error("Error: Elemento #ovc-table-body no encontrado."); }


            // --- Inicialización ---
            let loadedFromUrlParams = false; // Flag to track if content was loaded based on URL
            const urlParams = new URLSearchParams(window.location.search);
            const initialTab = urlParams.get('initialTab');
            const editIndex = urlParams.get('editIndex');

            // Check specifically for the designer tab parameter
            if (initialTab === 'designer') {
                const designerLink = document.querySelector('a.sidebar-link[href="disenar_rubrica.html"]');
                if (designerLink) {
                    let targetUrl = 'disenar_rubrica.html';
                    if (editIndex !== null && !isNaN(parseInt(editIndex))) {
                        targetUrl += `?editIndex=${encodeURIComponent(editIndex)}`;
                        console.log(`DEBUG: URL Params indicate loading designer with editIndex: ${editIndex}`);
                    } else {
                        console.log("DEBUG: URL Params indicate loading designer (no editIndex).");
                    }
                    // Load the iframe content
                    loadPageInContentArea(targetUrl, designerLink);
                    loadedFromUrlParams = true; // Mark that we loaded based on params
                } else {
                    console.warn("DEBUG: initialTab=designer specified, but designer link not found.");
                }
            }
            // Add more 'else if' blocks here for other potential initialTab values if needed

            // If no specific URL parameters were handled, load the default section
            if (!loadedFromUrlParams) {
                console.log("DEBUG: No relevant URL parameters found or processed, loading default section.");
                const initialActiveLink = document.querySelector('.sidebar-link.active[data-section]'); // Find active section link
                if (initialActiveLink) {
                    showSection(initialActiveLink.getAttribute('data-section'));
                } else {
                    showSection('listar'); // Fallback to 'listar' if no active link found
                }
            }

            // Always clear URL parameters after initial load to prevent re-triggering on refresh
            if (window.history.replaceState) {
                const cleanUrl = window.location.pathname; // Get path without query string
                window.history.replaceState({ path: cleanUrl }, '', cleanUrl);
                console.log("DEBUG: Cleared URL parameters.");
            }
            console.log("DEBUG: Script inicializado.");


            // --- Function to Load Rubric Pages into Content Area ---
            function loadPageInContentArea(url, clickedLink) {
                console.log(`DEBUG: Cargando contenido de ${url} en iframe.`);
                const contentArea = document.getElementById('content-area');

                // Hide all other sections first
                Object.values(sections).forEach(section => {
                    if (section) section.classList.add('hidden');
                });

                // Clear previous content (including any old iframe)
                contentArea.innerHTML = '';

                // Create and configure iframe
                const iframe = document.createElement('iframe');
                iframe.setAttribute('src', url);
                iframe.setAttribute('frameborder', '0');
                iframe.style.width = '100%';
                iframe.style.height = '100%'; // Make iframe fill the container
                iframe.style.border = 'none';

                // Append iframe
                contentArea.appendChild(iframe);

                // Update title (use text content of the clicked link)
                const linkText = clickedLink.textContent.trim().replace(/^[^\w]+/, ''); // Clean up emoji/prefix
                sectionTitle.innerHTML = `<span>📊</span> Rúbricas: ${linkText}`;

                // Update active link state
                sidebarLinks.forEach(link => link.classList.remove('active'));
                if (clickedLink) {
                    clickedLink.classList.add('active');
                }
                // Also mark the main "Rúbricas" toggle as active visually
                rubricasToggle.classList.add('active');

                // Ensure the submenu stays open visually
                if (!rubricasSubmenu.classList.contains('open')) {
                    rubricasSubmenu.classList.add('open');
                    rubricasToggleIcon.classList.add('open');
                    rubricasToggleIcon.textContent = '▼';
                }
            }


            // Mover aquí la definición de renderRizomaGraph para que esté en el scope correcto
            /**
             * Llama a la función verRizoma para renderizar el grafo D3.
             */
            function renderRizomaGraph() {
                console.log("DEBUG: Llamando a verRizoma para renderizar el grafo.");
                const containerId = '#rizoma-graph'; // ID del elemento SVG
                const containerElement = document.querySelector(containerId);

                if (containerElement) {
                    // Asegurarse de que los datos estén en localStorage antes de llamar
                    if (localStorage.getItem('ovcData')) {
                        // Llamar a la función asíncrona verRizoma
                        verRizoma(containerId)
                            .then(() => {
                                console.log("DEBUG: Grafo rizoma renderizado exitosamente.");
                            })
                            .catch(error => {
                                console.error("Error al renderizar el grafo rizoma:", error);
                                // Opcionalmente mostrar error en la UI
                                containerElement.innerHTML = `<text x="50%" y="50%" text-anchor="middle" fill="red">Error al cargar grafo: ${error.message}</text>`;
                            });
                    } else {
                        console.warn("DEBUG: No hay 'ovcData' en localStorage. No se puede renderizar el grafo.");
                        containerElement.innerHTML = `<text x="50%" y="50%" text-anchor="middle">No hay datos OVC en localStorage para mostrar el grafo.</text>`;
                    }
                } else {
                    console.error(`Error: Contenedor SVG con ID '${containerId}' no encontrado.`);
                }
            }

            // --- Búsqueda en Rizoma (Adaptar si es necesario para D3) ---
            // La lógica actual de búsqueda manipula display, lo cual puede no funcionar
            // bien con D3 que controla las posiciones. Se necesitaría una lógica
            // diferente para resaltar o filtrar nodos/enlaces en D3.
            // Por ahora, comentamos la lógica de búsqueda específica del rizoma
            // para evitar conflictos con D3.
            /*
            const rizomaSearchInput = document.getElementById('rizoma-search-input');
            if (rizomaSearchInput) {
                rizomaSearchInput.addEventListener('input', () => {
                    const query = rizomaSearchInput.value.trim().toLowerCase();
                    console.log("Búsqueda en Rizoma (lógica pendiente de adaptar para D3):", query);
                    // Aquí iría la lógica de filtrado/resaltado para D3
                    // Ejemplo: filtrar datos y volver a renderizar, o aplicar clases CSS
                });
            }
            */

        }); // Fin del listener DOMContentLoaded principal


        // =====================================================================
        // ======================= KANBAN BOARD LOGIC ==========================
        // =====================================================================
        const KanbanApp = (() => {
            // --- Elementos del DOM (Kanban) ---
            let columns = null;
            let contextMenu = null;
            let taskModal = null;
            let addTaskBtn = null;
            let taskForm = null;
            let draggedTask = null;
            let currentTaskElement = null; // For context menu target
            let currentEditingTask = null; // For inline editing target

            // --- Colores disponibles (Kanban) ---
            const taskColorClasses = [
                'bg-task-default', 'bg-task-red', 'bg-task-blue',
                'bg-task-green', 'bg-task-yellow', 'bg-task-purple'
            ];

            // --- Funciones (Kanban) ---

            function generateId(prefix = 'task') {
                return `${prefix}-` + Date.now() + '-' + Math.floor(Math.random() * 1000);
            }

            function getTaskDataFromElement(taskElement) {
                const description = taskElement.querySelector('p.font-medium')?.textContent || '';
                const dueDateText = taskElement.querySelector('.details p:first-child')?.textContent || '';
                const assigneeText = taskElement.querySelector('.details p:last-child:not(:first-child)')?.textContent || '';
                const dueDate = dueDateText.includes(' ') ? dueDateText.substring(dueDateText.indexOf(' ') + 1).trim() : '';
                const assignee = assigneeText.includes(' ') ? assigneeText.substring(assigneeText.indexOf(' ') + 1).trim() : '';
                return { description, dueDate, assignee };
            }

            function renderTaskViewContent(taskData) {
                const subtasks = taskData.subtasks || [];
                const completedSubtasks = subtasks.filter(st => st.completed).length;
                const totalSubtasks = subtasks.length;
                const subtasksExist = totalSubtasks > 0;

                return `
                    <p class="font-medium text-gray-800">${taskData.description || 'Sin descripción'}</p>
                    <div class="details mt-2 text-xs">
                        ${taskData.dueDate ? `<p class="flex items-center gap-1"><span class="emoji">📅</span> ${taskData.dueDate}</p>` : ''}
                        ${taskData.assignee ? `<p class="flex items-center gap-1 mt-1"><span class="emoji">👤</span> ${taskData.assignee}</p>` : ''}
                    </div>
                    ${subtasksExist ? `
                    <button class="view-subtasks-btn" aria-expanded="false">
                        <span class="arrow mr-1">▶</span><span class="emoji">📑</span> Subtareas (${completedSubtasks}/${totalSubtasks})
                    </button>
                    <div class="subtasks-list-view" style="display: none;">
                        ${renderSubtasksView(subtasks, taskData.id)}
                    </div>
                    ` : ''}
                `;
            }

            function renderSubtasksView(subtasks, taskId) {
                if (!subtasks || subtasks.length === 0) return '<p class="text-xs text-gray-500 italic ml-1">No hay subtareas.</p>';
                return `
                    <ul>
                        ${subtasks.map(subtask => `
                            <li class="subtask-item-view" data-subtask-id="${subtask.id}">
                                <input type="checkbox" ${subtask.completed ? 'checked' : ''} onchange="KanbanApp.toggleSubtaskCompletion(event, '${taskId}', '${subtask.id}')" aria-label="Marcar subtarea ${subtask.description} como completada">
                                <span class="${subtask.completed ? 'completed' : ''}">${subtask.description}</span>
                            </li>
                        `).join('')}
                    </ul>
                `;
            }

            function createTaskElement(taskData) {
                const taskElement = document.createElement('div');
                taskElement.id = taskData.id;
                taskElement.classList.add('task-card');
                taskElement.draggable = true;

                const colorClass = (taskData.color && taskColorClasses.includes(taskData.color)) ? taskData.color : 'bg-task-default';
                taskElement.classList.add(colorClass);

                taskElement._subtasks = taskData.subtasks || []; // Store subtasks data

                taskElement.innerHTML = renderTaskViewContent(taskData);

                taskElement.addEventListener('click', handleTaskClick);
                taskElement.addEventListener('dragstart', handleDragStart);
                taskElement.addEventListener('dragend', handleDragEnd);
                taskElement.addEventListener('contextmenu', handleContextMenu);

                taskElement.addEventListener('click', (event) => {
                    if (event.target.classList.contains('view-subtasks-btn') || event.target.closest('.view-subtasks-btn')) {
                        const button = event.target.classList.contains('view-subtasks-btn') ? event.target : event.target.closest('.view-subtasks-btn');
                        toggleSubtasksView(button);
                        event.stopPropagation();
                    }
                    if (event.target.matches('.subtask-item-view input[type="checkbox"]')) {
                        event.stopPropagation();
                    }
                });

                return taskElement;
            }

            function addTask(taskData, save = true) {
                if (!taskData.id) taskData.id = generateId('task');
                if (!taskData.columnId) taskData.columnId = 'todo';
                if (!taskData.color) taskData.color = 'bg-task-default';
                if (!taskData.subtasks) taskData.subtasks = [];

                const taskElement = createTaskElement(taskData);
                const targetColumn = document.querySelector(`.kanban-tasks[data-column-id="${taskData.columnId}"]`);

                if (targetColumn) {
                    targetColumn.appendChild(taskElement);
                    if (save) saveBoardState();
                } else {
                    console.error(`Columna Kanban con ID "${taskData.columnId}" no encontrada.`);
                    const todoColumn = document.querySelector('.kanban-tasks[data-column-id="todo"]');
                    if (todoColumn) {
                        todoColumn.appendChild(taskElement);
                        taskData.columnId = 'todo';
                        if (save) saveBoardState();
                    } else {
                        console.error("Columna Kanban 'todo' tampoco encontrada.");
                    }
                }
            }

            function deleteTask(taskId) {
                const taskElement = document.getElementById(taskId);
                if (taskElement) {
                    if (currentEditingTask && currentEditingTask.id === taskId) {
                        disableEditMode(currentEditingTask, false);
                    }
                    taskElement.remove();
                    saveBoardState();
                    console.log(`Tarea Kanban ${taskId} eliminada.`);
                } else {
                    console.warn(`No se encontró la tarea Kanban con ID ${taskId} para eliminar.`);
                }
            }

            function handleTaskClick(event) {
                const taskCard = event.currentTarget;
                if (event.target.closest('.view-subtasks-btn') || event.target.closest('.subtasks-list-view')) {
                    return;
                }
                if (currentEditingTask || taskCard.classList.contains('editing') || event.target.closest('.edit-actions') || event.button === 2) {
                    return;
                }
                enableEditMode(taskCard);
            }

            function enableEditMode(taskElement) {
                if (currentEditingTask && currentEditingTask !== taskElement) {
                    disableEditMode(currentEditingTask, false);
                }

                currentEditingTask = taskElement;
                taskElement.classList.add('editing');
                taskElement.draggable = false;

                const originalData = getTaskDataFromElement(taskElement);
                const originalSubtasks = JSON.parse(JSON.stringify(taskElement._subtasks || []));
                taskElement.dataset.originalDescription = originalData.description;
                taskElement.dataset.originalDueDate = originalData.dueDate;
                taskElement.dataset.originalAssignee = originalData.assignee;
                taskElement._originalSubtasks = originalSubtasks;

                taskElement.innerHTML = `
                    <textarea class="edit-input edit-textarea" placeholder="Descripción..." aria-label="Descripción de la tarea">${originalData.description}</textarea>
                    <input type="date" class="edit-input" value="${originalData.dueDate}" aria-label="Fecha de vencimiento">
                    <input type="text" class="edit-input" placeholder="Responsable..." value="${originalData.assignee}" aria-label="Responsable">
                    <div class="subtasks-section">
                        <h4 class="text-sm font-medium text-gray-600 mb-2">Subtareas</h4>
                        <ul class="subtasks-list-edit mb-3" aria-label="Lista de subtareas editables">
                            ${renderSubtasksEdit(originalSubtasks)}
                        </ul>
                        <div class="add-subtask-container">
                            <input type="text" class="add-subtask-input" placeholder="Añadir nueva subtarea..." aria-label="Nueva subtarea">
                            <button type="button" class="edit-button add-subtask-btn bg-gray-200 hover:bg-gray-300 text-gray-700 border-gray-300" aria-label="Añadir subtarea">➕ Añadir</button>
                        </div>
                    </div>
                    <div class="edit-actions">
                        <button class="edit-button cancel-button"><span class="emoji">❌</span>Cancelar</button>
                        <button class="edit-button save-button"><span class="emoji">💾</span>Guardar</button>
                    </div>
                `;

                const subtaskListElement = taskElement.querySelector('.subtasks-list-edit');
                const addSubtaskInput = taskElement.querySelector('.add-subtask-input');
                const addSubtaskBtn = taskElement.querySelector('.add-subtask-btn');

                taskElement.querySelector('.save-button').addEventListener('click', () => disableEditMode(taskElement, true));
                taskElement.querySelector('.cancel-button').addEventListener('click', () => disableEditMode(taskElement, false));

                addSubtaskBtn.addEventListener('click', () => {
                    const description = addSubtaskInput.value.trim();
                    if (description) {
                        addSubtaskToEditList(subtaskListElement, description);
                        addSubtaskInput.value = '';
                        addSubtaskInput.focus();
                    }
                });
                addSubtaskInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addSubtaskBtn.click();
                    }
                });

                subtaskListElement.addEventListener('click', (e) => {
                    if (e.target.classList.contains('subtask-delete-btn')) {
                        deleteSubtaskFromEditList(e.target.closest('.subtask-item-edit'));
                    }
                });

                // Initialize SortableJS only if Sortable is defined
                if (typeof Sortable !== 'undefined') {
                    Sortable.create(subtaskListElement, {
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        handle: '.subtask-drag-handle',
                        forceFallback: true,
                        fallbackOnBody: true,
                        swapThreshold: 0.65
                    });
                } else {
                    console.warn("SortableJS no está definido. La función de arrastrar subtareas no funcionará.");
                }


                taskElement.querySelector('textarea').focus();
                document.addEventListener('click', handleClickOutsideEdit, true);
            }

            function disableEditMode(taskElement, saveData) {
                if (!taskElement || !taskElement.classList.contains('editing')) return;

                let updatedData = {};

                if (saveData) {
                    const newDescription = taskElement.querySelector('textarea').value.trim();
                    const newDueDate = taskElement.querySelector('input[type="date"]').value;
                    const newAssignee = taskElement.querySelector('input[type="text"]').value.trim();
                    if (!newDescription) {
                        alert("La descripción no puede estar vacía.");
                        taskElement.querySelector('textarea').focus();
                        return;
                    }
                    updatedData = {
                        description: newDescription,
                        dueDate: newDueDate,
                        assignee: newAssignee,
                        subtasks: getSubtasksFromEditList(taskElement.querySelector('.subtasks-list-edit'))
                    };
                    taskElement._subtasks = updatedData.subtasks;
                } else {
                    updatedData = {
                        description: taskElement.dataset.originalDescription,
                        dueDate: taskElement.dataset.originalDueDate,
                        assignee: taskElement.dataset.originalAssignee,
                        subtasks: taskElement._originalSubtasks || []
                    };
                    taskElement._subtasks = updatedData.subtasks;
                }

                taskElement.innerHTML = renderTaskViewContent(updatedData);
                taskElement.classList.remove('editing');
                taskElement.draggable = true;

                delete taskElement.dataset.originalDescription;
                delete taskElement.dataset.originalDueDate;
                delete taskElement.dataset.originalAssignee;
                delete taskElement._originalSubtasks;

                taskElement.addEventListener('click', handleTaskClick);
                taskElement.addEventListener('dragstart', handleDragStart);
                taskElement.addEventListener('dragend', handleDragEnd);
                taskElement.addEventListener('contextmenu', handleContextMenu);

                currentEditingTask = null;
                document.removeEventListener('click', handleClickOutsideEdit, true);

                if (saveData) {
                    saveBoardState();
                }
            }

            function handleClickOutsideEdit(event) {
                if (contextMenu && contextMenu.contains(event.target) || (currentEditingTask && currentEditingTask.contains(event.target))) {
                    return;
                }
                if (currentEditingTask) {
                    if (event.target.closest('.sortable-fallback') || event.target.closest('.sortable-ghost')) {
                        return;
                    }
                    disableEditMode(currentEditingTask, false);
                }
            }

            function renderSubtasksEdit(subtasks) {
                if (!subtasks || subtasks.length === 0) return '<p class="text-xs text-gray-500 italic px-1">No hay subtareas añadidas.</p>';
                return subtasks.map(subtask => `
                    <li class="subtask-item-edit" data-subtask-id="${subtask.id}" data-completed="${subtask.completed}">
                        <span class="subtask-drag-handle" title="Arrastrar para reordenar">⠿</span>
                        <input type="text" value="${subtask.description}" placeholder="Descripción subtarea..." aria-label="Descripción de la subtarea ${subtask.description}">
                        <button type="button" class="subtask-delete-btn" title="Eliminar subtarea">✖</button>
                    </li>
                `).join('');
            }

            function addSubtaskToEditList(listElement, description) {
                const noSubtasksMsg = listElement.querySelector('p');
                if (noSubtasksMsg) noSubtasksMsg.remove();

                const newSubtaskId = generateId('sub');
                const newSubtask = { id: newSubtaskId, description: description, completed: false };
                const li = document.createElement('li');
                li.className = 'subtask-item-edit';
                li.dataset.subtaskId = newSubtask.id;
                li.dataset.completed = 'false';
                li.innerHTML = `
                    <span class="subtask-drag-handle" title="Arrastrar para reordenar">⠿</span>
                    <input type="text" value="${newSubtask.description}" placeholder="Descripción subtarea..." aria-label="Descripción de la subtarea ${newSubtask.description}">
                    <button type="button" class="subtask-delete-btn" title="Eliminar subtarea">✖</button>
                `;
                listElement.appendChild(li);
            }

            function deleteSubtaskFromEditList(subtaskItemElement) {
                const listElement = subtaskItemElement.parentElement;
                subtaskItemElement.remove();
                if (listElement && !listElement.querySelector('.subtask-item-edit')) {
                    listElement.innerHTML = '<p class="text-xs text-gray-500 italic px-1">No hay subtareas añadidas.</p>';
                }
            }

            function getSubtasksFromEditList(listElement) {
                const subtaskItems = listElement.querySelectorAll('.subtask-item-edit');
                const subtasks = [];
                subtaskItems.forEach(item => {
                    const input = item.querySelector('input[type="text"]');
                    const description = input ? input.value.trim() : '';
                    if (description) {
                        subtasks.push({
                            id: item.dataset.subtaskId,
                            description: description,
                            completed: item.dataset.completed === 'true'
                        });
                    } else {
                        console.warn("Subtarea Kanban vacía encontrada y omitida al guardar:", item.dataset.subtaskId);
                    }
                });
                return subtasks;
            }

            function toggleSubtasksView(button) {
                const subtaskList = button.nextElementSibling;
                const isExpanded = button.getAttribute('aria-expanded') === 'true';
                const arrow = button.querySelector('.arrow');
                if (subtaskList) {
                    subtaskList.style.display = isExpanded ? 'none' : 'block';
                    button.setAttribute('aria-expanded', !isExpanded);
                    if (arrow) {
                        arrow.style.transform = isExpanded ? 'rotate(0deg)' : 'rotate(90deg)';
                    }
                }
            }

            function toggleSubtaskCompletion(event, taskId, subtaskId) {
                const isChecked = event.target.checked;
                const taskElement = document.getElementById(taskId);
                if (taskElement && taskElement._subtasks) {
                    const subtaskIndex = taskElement._subtasks.findIndex(st => st.id === subtaskId);
                    if (subtaskIndex !== -1) {
                        taskElement._subtasks[subtaskIndex].completed = isChecked;

                        const subtaskSpan = event.target.nextElementSibling;
                        if (subtaskSpan) {
                            subtaskSpan.classList.toggle('completed', isChecked);
                        }
                        const viewButton = taskElement.querySelector('.view-subtasks-btn');
                        if (viewButton) {
                            const completedCount = taskElement._subtasks.filter(st => st.completed).length;
                            const totalCount = taskElement._subtasks.length;
                            viewButton.innerHTML = `<span class="arrow mr-1" style="transform: ${viewButton.getAttribute('aria-expanded') === 'true' ? 'rotate(90deg)' : 'rotate(0deg)'};">▶</span><span class="emoji">📑</span> Subtareas (${completedCount}/${totalCount})`;
                        }
                        saveBoardState();
                    } else {
                        console.error("Subtask Kanban no encontrada en datos internos:", subtaskId, "para tarea:", taskId);
                    }
                } else {
                    console.error("Elemento de tarea Kanban o datos internos de subtarea no encontrados:", taskId);
                }
            }

            function handleDragStart(event) {
                if (event.target.classList.contains('editing')) {
                    event.preventDefault(); return;
                }
                if (event.target.classList.contains('task-card')) {
                    draggedTask = event.target;
                    event.dataTransfer.setData('text/plain', event.target.id);
                    event.dataTransfer.effectAllowed = 'move';
                    setTimeout(() => { if (draggedTask) draggedTask.classList.add('dragging'); }, 0);
                } else {
                    event.preventDefault();
                }
            }
            function handleDragEnd(event) {
                if (draggedTask) draggedTask.classList.remove('dragging');
                if (columns) columns.forEach(col => col.classList.remove('drag-over'));
                draggedTask = null;
            }
            function handleDragOver(event) {
                event.preventDefault();
                event.dataTransfer.dropEffect = 'move';
                const targetColumn = event.target.closest('.kanban-tasks');
                if (targetColumn && (!draggedTask || !targetColumn.contains(draggedTask))) {
                    if (columns) columns.forEach(col => col !== targetColumn && col.classList.remove('drag-over'));
                    targetColumn.classList.add('drag-over');
                }
            }
            function handleDragEnter(event) {
                event.preventDefault();
                const targetColumn = event.target.closest('.kanban-tasks');
                if (targetColumn && (!draggedTask || !targetColumn.contains(draggedTask))) {
                    targetColumn.classList.add('drag-over');
                }
            }
            function handleDragLeave(event) {
                const targetColumn = event.target.closest('.kanban-tasks');
                if (targetColumn && !targetColumn.contains(event.relatedTarget)) {
                    targetColumn.classList.remove('drag-over');
                }
                if (!event.relatedTarget || !event.relatedTarget.closest('.kanban-tasks')) {
                    if (columns) columns.forEach(col => col.classList.remove('drag-over'));
                }
            }
            function handleDrop(event) {
                event.preventDefault();
                const targetColumn = event.target.closest('.kanban-tasks');
                if (targetColumn && draggedTask && targetColumn !== draggedTask.parentElement) {
                    targetColumn.appendChild(draggedTask);
                    saveBoardState();
                }
                if (targetColumn) targetColumn.classList.remove('drag-over');
            }

            function handleContextMenu(event) {
                if (event.currentTarget.classList.contains('editing')) {
                    event.preventDefault(); return;
                }
                event.preventDefault();
                currentTaskElement = event.currentTarget;
                if (!currentTaskElement || !contextMenu) return;

                const { clientX: mouseX, clientY: mouseY } = event;
                contextMenu.style.display = 'block';
                const { offsetWidth: menuWidth, offsetHeight: menuHeight } = contextMenu;
                const { innerWidth, innerHeight } = window;
                let top = mouseY, left = mouseX;
                if (mouseY + menuHeight > innerHeight) top = mouseY - menuHeight;
                if (mouseX + menuWidth > innerWidth) left = mouseX - menuWidth;
                if (top < 0) top = 5;
                if (left < 0) left = 5;
                contextMenu.style.top = `${top}px`;
                contextMenu.style.left = `${left}px`;

                setTimeout(() => {
                    document.addEventListener('click', closeContextMenuOnClickOutside, { capture: true, once: true });
                    document.addEventListener('keydown', closeContextMenuOnEscape, { once: true });
                }, 0);
            }
            function closeContextMenu() {
                if (contextMenu) contextMenu.style.display = 'none';
                currentTaskElement = null;
                document.removeEventListener('click', closeContextMenuOnClickOutside, { capture: true });
                document.removeEventListener('keydown', closeContextMenuOnEscape);
            }
            function closeContextMenuOnClickOutside(event) {
                if (currentEditingTask && currentEditingTask.contains(event.target)) {
                    document.addEventListener('click', closeContextMenuOnClickOutside, { capture: true, once: true });
                    return;
                }
                if (contextMenu && !contextMenu.contains(event.target)) {
                    closeContextMenu();
                } else {
                    document.addEventListener('click', closeContextMenuOnClickOutside, { capture: true, once: true });
                }
            }
            function closeContextMenuOnEscape(event) {
                if (event.key === 'Escape') {
                    closeContextMenu();
                } else {
                    document.addEventListener('keydown', closeContextMenuOnEscape, { once: true });
                }
            }
            function handleContextMenuAction(event) {
                const menuItem = event.target.closest('.context-menu-item');
                if (!menuItem || !currentTaskElement) {
                    return;
                }
                const color = menuItem.dataset.color;
                const action = menuItem.dataset.action;
                if (color) {
                    taskColorClasses.forEach(cls => currentTaskElement.classList.remove(cls));
                    currentTaskElement.classList.add(color);
                    saveBoardState();
                } else if (action === 'delete') {
                    const taskDescription = getTaskDataFromElement(currentTaskElement).description || 'esta tarea';
                    if (confirm(`¿Estás seguro de que quieres eliminar la tarea Kanban "${taskDescription}"?`)) {
                        deleteTask(currentTaskElement.id);
                    }
                }
                closeContextMenu();
            }

            function openModal() {
                if (taskForm) taskForm.reset();
                if (taskModal) {
                    taskModal.style.display = 'block';
                    const descInput = document.getElementById('taskDescription');
                    if (descInput) descInput.focus();
                }
            }
            function closeModal() {
                if (taskModal) taskModal.style.display = 'none';
            }
            function handleFormSubmit(event) {
                event.preventDefault();
                if (!taskForm) return;
                const formData = new FormData(taskForm);
                const taskData = {
                    description: formData.get('description').trim(),
                    dueDate: formData.get('dueDate'),
                    assignee: formData.get('assignee').trim(),
                };
                if (!taskData.description) {
                    alert("La descripción de la tarea Kanban no puede estar vacía.");
                    const descInput = document.getElementById('taskDescription');
                    if (descInput) descInput.focus();
                    return;
                }
                addTask(taskData);
                closeModal();
            }

            function saveBoardState() {
                if (currentEditingTask) {
                    console.warn("Guardando estado Kanban con tarea en edición. Cancelando edición...");
                    disableEditMode(currentEditingTask, false);
                }
                const boardState = [];
                if (!columns) return; // Check if columns exist

                columns.forEach(column => {
                    const columnId = column.dataset.columnId;
                    const tasks = column.querySelectorAll('.task-card');
                    tasks.forEach((taskElement, index) => {
                        if (taskElement.classList.contains('editing')) {
                            console.error("Error crítico Kanban: Guardando tarea aún en modo edición:", taskElement.id);
                            return;
                        }
                        let taskColor = taskColorClasses.find(cls => taskElement.classList.contains(cls)) || 'bg-task-default';
                        const taskData = getTaskDataFromElement(taskElement);
                        const subtasks = taskElement._subtasks || [];
                        boardState.push({
                            id: taskElement.id,
                            description: taskData.description,
                            dueDate: taskData.dueDate,
                            assignee: taskData.assignee,
                            color: taskColor,
                            columnId: columnId,
                            order: index,
                            subtasks: subtasks
                        });
                    });
                });
                boardState.sort((a, b) => {
                    const columnOrder = ['todo', 'in-progress', 'done'];
                    const columnAIndex = columnOrder.indexOf(a.columnId);
                    const columnBIndex = columnOrder.indexOf(b.columnId);
                    if (columnAIndex !== columnBIndex) return columnAIndex - columnBIndex;
                    return (a.order || 0) - (b.order || 0);
                });
                try {
                    localStorage.setItem('kanbanBoardState_v3', JSON.stringify(boardState));
                    console.log("Estado del tablero Kanban guardado (v3).");
                } catch (error) {
                    console.error("Error al guardar estado Kanban en localStorage:", error);
                    alert("No se pudo guardar el estado del tablero Kanban.");
                }
            }

            function loadBoardState() {
                let savedState = localStorage.getItem('kanbanBoardState_v3');
                let version = 'v3';

                if (savedState) {
                    try {
                        let boardState = JSON.parse(savedState);
                        boardState.sort((a, b) => {
                            const columnOrder = ['todo', 'in-progress', 'done'];
                            const columnAIndex = columnOrder.indexOf(a.columnId);
                            const columnBIndex = columnOrder.indexOf(b.columnId);
                            if (columnAIndex === -1) return 1;
                            if (columnBIndex === -1) return -1;
                            if (columnAIndex !== columnBIndex) return columnAIndex - columnBIndex;
                            return (a.order || 0) - (b.order || 0);
                        });

                        if (columns) columns.forEach(col => col.innerHTML = ''); // Clear columns before loading

                        boardState.forEach(taskData => {
                            if (!taskData.id) taskData.id = generateId('task');
                            taskData.subtasks = (taskData.subtasks || []).map(st => ({
                                ...st,
                                id: st.id || generateId('sub'),
                                completed: st.completed || false
                            }));
                            addTask(taskData, false); // Add task without triggering another save
                        });
                        console.log(`Estado del tablero Kanban cargado (${version}).`);
                    } catch (error) {
                        console.error(`Error al cargar el estado del tablero Kanban (${version}):`, error);
                        localStorage.removeItem('kanbanBoardState_v3');
                    }
                } else {
                    console.log("No hay estado Kanban guardado (v3), iniciando tablero vacío.");
                }
            }

            // --- Inicialización (Kanban) ---
            function init() {
                console.log("DEBUG: Inicializando KanbanApp...");
                // Query selectors within the init function, after DOM is ready
                columns = document.querySelectorAll('#kanban-section .kanban-tasks');
                contextMenu = document.getElementById('contextMenu');
                taskModal = document.getElementById('taskModal');
                addTaskBtn = document.getElementById('addTaskBtn');
                taskForm = document.getElementById('taskForm');

                if (!columns.length || !contextMenu || !taskModal || !addTaskBtn || !taskForm) {
                    console.error("Error: No se encontraron todos los elementos necesarios para el Kanban.");
                    return;
                }

                columns.forEach(column => {
                    column.addEventListener('dragover', handleDragOver);
                    column.addEventListener('dragenter', handleDragEnter);
                    column.addEventListener('dragleave', handleDragLeave);
                    column.addEventListener('drop', handleDrop);
                });
                contextMenu.addEventListener('click', handleContextMenuAction, true);
                addTaskBtn.addEventListener('click', openModal);
                taskForm.addEventListener('submit', handleFormSubmit);

                // Global listeners specific to Kanban (modal close, escape key)
                window.addEventListener('click', function (event) {
                    if (taskModal && event.target == taskModal) closeModal();
                });
                // Escape key handling is combined in the main script's listener

                loadBoardState(); // Load saved state
                console.log("DEBUG: KanbanApp inicializado.");
            }

            // Public interface
            return {
                init: init,
                closeModal: closeModal, // Expose closeModal for onclick attribute
                toggleSubtaskCompletion: toggleSubtaskCompletion // Expose for onclick attribute
            };
        })();

        // Call Kanban init after main DOMContentLoaded logic
        // KanbanApp.init is now called conditionally within showSection after loading content
        // document.addEventListener('DOMContentLoaded', KanbanApp.init);
        // Auto completado
        document.addEventListener('DOMContentLoaded', function () {


            // Función para configurar autocompletado en un campo
            function setupAutocomplete(input) {
                input.addEventListener('input', function () {
                    const query = input.value.toLowerCase();
                    const ovcs = getOvcsFromStorage();
                    const match = ovcs.find(ovc => ovc.titulo && ovc.titulo.toLowerCase().startsWith(query));

                    if (match) {
                        input.value = match.titulo; // Autocompleta con la primera coincidencia
                    }
                });
            }

            // Configurar autocompletado para los campos existentes
            function initializeAutocomplete() {
                const relacionOvcInputs = document.querySelectorAll('input[name="relacion_ovc[]"]');
                relacionOvcInputs.forEach(input => {
                    // Evitar configurar el autocompletado más de una vez
                    if (!input.dataset.autocompleteInitialized) {
                        setupAutocomplete(input);
                        input.dataset.autocompleteInitialized = true; // Marcar como inicializado
                    }
                });
            }

            // Inicializar autocompletado en los campos existentes al cargar la página
            initializeAutocomplete();

            // Detectar y configurar autocompletado para nuevos campos dinámicos
            const relacionesContainer = document.getElementById('relaciones-container');
            const observer = new MutationObserver(() => {
                initializeAutocomplete(); // Reconfigurar autocompletado para nuevos inputs
            });

            // Observar cambios en el contenedor de relaciones
            observer.observe(relacionesContainer, { childList: true, subtree: true });
        });

        // Rubricas Submenu Toggle
        const rubricasToggle = document.getElementById('rubricas-toggle');
        const rubricasSubmenu = document.getElementById('rubricas-submenu');
        const rubricasToggleIcon = rubricasToggle.querySelector('.submenu-toggle-icon');

        rubricasToggle.addEventListener('click', (event) => {
            event.preventDefault(); // Prevent default link behavior
            const isOpen = rubricasSubmenu.classList.toggle('open');
            rubricasToggleIcon.classList.toggle('open', isOpen);
            rubricasToggleIcon.textContent = isOpen ? '▼' : '▶️'; // Change arrow icon
        });

        // Las funciones renderRizomaGraph y la búsqueda comentada se movieron dentro del listener principal

        // Combined Escape Key Listener
        window.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                // OVC Modals
                if (confirmationModal && !confirmationModal.classList.contains('hidden')) hideConfirmationModal();
                else if (deleteConfirmModal && !deleteConfirmModal.classList.contains('hidden')) hideDeleteConfirmModal();
                else if (summaryModal && !summaryModal.classList.contains('hidden')) hideSummaryModal();
                // Kanban Modals / States
                else if (KanbanApp && typeof KanbanApp.closeModal === 'function' && document.getElementById('taskModal')?.style.display === 'block') KanbanApp.closeModal();
                else if (KanbanApp && typeof KanbanApp.disableEditMode === 'function' && KanbanApp.currentEditingTask) KanbanApp.disableEditMode(KanbanApp.currentEditingTask, false); // Needs currentEditingTask exposed or a public cancel method
                else if (KanbanApp && typeof KanbanApp.closeContextMenu === 'function' && document.getElementById('contextMenu')?.style.display === 'block') KanbanApp.closeContextMenu(); // Needs closeContextMenu exposed or a public cancel method
            }
        });
    </script>
    <!-- Eliminada etiqueta </style> incorrecta -->
</body>

</html>