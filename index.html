<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de OVC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos CSS (sin cambios) */
        .sidebar-link.active {
            background-color: #ec4899;
            color: white;
            font-weight: 600;
        }

        .btn-create-ovc {
            background-color: #343a40;
            color: white;
            transition: background-color 0.3s ease;
        }

        .btn-create-ovc:hover {
            background-color: #495057;
        }

        .btn-create-ovc span:first-child {
            margin-right: 0.5rem;
        }

        .sidebar-link span:first-child {
            display: inline-block;
            width: 24px;
            text-align: center;
            margin-right: 0.75rem;
            font-size: 1.2rem;
        }

        body {
            font-family: 'Inter', sans-serif;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        .logo-placeholder {
            font-weight: bold;
            font-size: 1.1rem;
            text-align: center;
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 1rem;
        }

        .udea-logo {
            max-width: 100px;
            height: auto;
            margin-top: auto;
            margin-bottom: 1rem;
            align-self: center;
        }

        .image-preview {
            width: 200px;
            height: 150px;
            border: 2px dashed #cbd5e1;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8fafc;
            color: #94a3b8;
            font-size: 0.875rem;
            overflow: hidden;
            text-align: center;
        }

        .image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }

        .custom-file-input::-webkit-file-upload-button {
            visibility: hidden;
        }

        .custom-file-input::before {
            content: 'Seleccionar archivo';
            display: inline-block;
            background: linear-gradient(top, #f9f9f9, #e3e3e3);
            border: 1px solid #999;
            border-radius: 3px;
            padding: 5px 8px;
            outline: none;
            white-space: nowrap;
            -webkit-user-select: none;
            cursor: pointer;
            text-shadow: 1px 1px #fff;
            font-weight: 700;
            font-size: 10pt;
            margin-right: 10px;
        }

        .custom-file-input:hover::before {
            border-color: black;
        }

        .custom-file-input:active::before {
            background: -webkit-linear-gradient(top, #e3e3e3, #f9f9f9);
        }

        .btn-add,
        .btn-remove {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            line-height: 1;
        }

        .btn-add span,
        .btn-remove span {
            margin-right: 0.25rem;
        }

        .modal-overlay {
            transition: opacity 0.3s ease-in-out;
        }



        .modal-content {
            transition: transform 0.3s ease-in-out;
        }

        .empty-table-row td {
            text-align: center;
            color: #6b7280;
            font-style: italic;
            padding: 2rem;
        }

        label>span:first-child,
        h2>span:first-child,
        h3>span:first-child {
            margin-right: 0.3em;
        }

        button[title="Salir"] span {
            margin-right: 0;
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            pointer-events: none;
        }

        .action-btn {
            cursor: pointer;
        }

        .hidden {
            display: none;
        }
    </style>
    <script>
    </script>
    <script>
        // Listeners DOMContentLoaded de l√≠neas 171-228 eliminados (redundantes con l√≥gica principal en 846+)
    </script>
</head>

<body class="bg-gray-100 font-sans">
    <div class="flex h-screen bg-gray-100">
        <aside class="w-64 bg-white shadow-md flex flex-col fixed h-full z-10">
            <div class="logo-placeholder text-gray-700">
                <img src="logocd.png" alt="Creaci√≥n Digital" style="max-width: 150px; height: auto;">
            </div>
            <nav class="flex-grow">
                <ul>
                    <li>
                        <a href="#" class="sidebar-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-200"
                            data-section="crear">
                            <span>‚ûï</span> <span>Crear OVC</span>
                        </a>
                    </li>
                    <li>
                        <a href="#"
                            class="sidebar-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-200 active"
                            data-section="listar">
                            <span>üìã</span> <span>Listar OVC</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" class="sidebar-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-200"
                            data-section="rizoma" id="rizoma-link">
                            <span>üå±</span> <span>Ver Rizoma</span>
                        </a>
                    </li>
                </ul>
            </nav>
            <div class="p-4 mt-auto flex justify-center border-t border-gray-200">
                <img src="logoudea.png" alt="Logo Ude@" class="udea-logo">
            </div>
        </aside>

        <div class="flex-1 flex flex-col ml-64 min-h-0"> <!-- Added min-h-0 -->
            <header class="bg-gray-800 shadow-md p-4 flex justify-between items-center">
                <div class="text-white text-xl font-semibold" id="section-title">
                    <span>üìã</span> Mis objetos virtuales creativos
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-white">üë§ Fernando Mora Angel</span>
                    <div
                        class="w-10 h-10 rounded-full bg-pink-500 flex items-center justify-center text-white font-bold">
                        FM
                    </div>
                    <button class="text-gray-300 hover:text-white text-xl" title="Salir">
                        <span>üö™</span> </button>
                </div>
            </header>

            <main class="flex-1 p-6 lg:p-8"> <!-- Removed overflow-y-auto -->
                <div id="content-area" class="flex flex-col flex-1 min-h-0 h-full"> <!-- Added h-full -->
                    <div id="listar-section" class="space-y-6">
                        <div class="flex justify-between items-center mb-6">
            
                            <div class="flex items-center space-x-4">
                                <button id="go-to-create-btn"
                                    class="btn-create-ovc flex items-center px-4 py-2 rounded-lg shadow hover:shadow-md transition duration-300">
                                    <span>‚ûï</span><span>Crear OVC</span> </button>
                                <div class="relative">
                                    <span class="search-icon">üîç</span> <input type="text" placeholder="Buscar..."
                                        id="search-input"
                                        class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-transparent">
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col"
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                T√≠tulo (Recurso)</th>
                                            <th scope="col"
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Autor Principal</th>
                                            <th scope="col"
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Asignaturas</th>
                                            <th scope="col"
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                A√±o-Semestre</th>
                                            <th scope="col"
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Etiquetas</th>
                                            <th scope="col" class="relative px-6 py-3">
                                                <span class="sr-only">Acciones</span>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="ovc-table-body" class="bg-white divide-y divide-gray-200">
                                    </tbody>
                                </table>
                            </div>
                            <div
                                class="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6 mt-4 rounded-b-lg">
                                <div class="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
                                    <div>
                                        <p class="text-sm text-gray-700">
                                            Mostrando <span id="pagination-start">0</span> a <span
                                                id="pagination-end">0</span> de <span id="pagination-total">0</span>
                                            resultados
                                        </p>
                                    </div>
                                    <div>
                                        <nav class="isolate inline-flex -space-x-px rounded-md shadow-sm"
                                            aria-label="Pagination">
                                            <a href="#"
                                                class="relative inline-flex items-center rounded-l-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0">
                                                <span>‚è™</span> </a>
                                            <a href="#"
                                                class="relative inline-flex items-center px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0">
                                                <span>‚¨ÖÔ∏è</span> </a>
                                            <a href="#"
                                                class="relative inline-flex items-center px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0">
                                                <span>‚û°Ô∏è</span> </a>
                                            <a href="#"
                                                class="relative inline-flex items-center rounded-r-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0">
                                                <span>‚è©</span> </a>
                                        </nav>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Eliminado div duplicado con id="rizoma-section" que estaba aqu√≠ -->
                    <div id="crear-section" class="hidden space-y-8">
                        <!-- Eliminado: T√≠tulo duplicado -->
                        
                        <form id="crear-ovc-form" class="space-y-10 bg-white p-8 rounded-lg shadow-lg">
                            <input type="hidden" id="edit-ovc-id" name="edit-ovc-id">
                            <div class="border-b border-gray-200 pb-6">
                                <h2 class="text-xl font-semibold text-gray-700 mb-4"><span>‚ÑπÔ∏è</span> Informaci√≥n B√°sica
                                </h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="ovc-imagen" class="block text-sm font-medium text-gray-700 mb-1">
                                            <span>üñºÔ∏è</span> Imagen de Portada </label>
                                        <input type="file" id="ovc-imagen" name="ovc-imagen" accept="image/*"
                                            class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-pink-50 file:text-pink-700 hover:file:bg-pink-100 custom-file-input">
                                        <div id="image-preview-container" class="image-preview">
                                            <span>Previsualizaci√≥n</span>
                                        </div>
                                        <span id="imagen-filename" class="text-xs text-gray-500 mt-1 block"></span>
                                        <input type="hidden" id="imagen-data-url">
                                    </div>
                                    <div class="space-y-4">
                                        <div>
                                            <label for="ovc-titulo"
                                                class="block text-sm font-medium text-gray-700"><span>üìÑ</span> T√≠tulo
                                                del OVC</label> <input type="text" id="ovc-titulo" name="ovc-titulo"
                                                required
                                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 sm:text-sm">
                                        </div>
                                        <div>
                                            <label for="ovc-descripcion"
                                                class="block text-sm font-medium text-gray-700"><span>üìÑ</span>
                                                Descripci√≥n</label> <textarea id="ovc-descripcion"
                                                name="ovc-descripcion" rows="4" required
                                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 sm:text-sm"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="border-b border-gray-200 pb-6">
                                <div class="flex justify-between items-center mb-3">
                                    <h2 class="text-xl font-semibold text-gray-700"><span>üë•</span> Autores</h2> <button
                                        type="button" id="add-autor"
                                        class="btn-add inline-flex items-center px-3 py-1.5 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                        <span>‚ûï</span> A√±adir Autor </button>
                                </div>
                                <div id="autores-container" class="space-y-4">
                                    <div
                                        class="autor-item grid grid-cols-1 sm:grid-cols-5 gap-4 items-end p-4 border rounded-md bg-gray-50">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-600"><span>üë§</span>
                                                Nombre</label> <input type="text" name="autor_nombre[]"
                                                placeholder="Nombre completo"
                                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 sm:text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-600"><span>üíº</span>
                                                Rol</label> <input type="text" name="autor_rol[]"
                                                placeholder="Ej: Investigador"
                                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 sm:text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-600"><span>@</span>
                                                E-mail</label> <input type="email" name="autor_email[]"
                                                placeholder="correo@ejemplo.com"
                                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 sm:text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-600"><span>%</span>
                                                Participaci√≥n (%)</label> <input type="number"
                                                name="autor_participacion[]" placeholder="Ej: 50" min="0" max="100"
                                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 sm:text-sm">
                                        </div>
                                        <button type="button"
                                            class="btn-remove remove-item self-end inline-flex justify-center items-center px-3 py-1.5 border border-red-300 text-sm font-medium rounded-md shadow-sm text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                            <span>üóëÔ∏è</span> </button>
                                    </div>
                                </div>
                            </div>
                            <div class="border-b border-gray-200 pb-6 grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <h3 class="text-lg font-medium text-gray-700"><span>üè∑Ô∏è</span> Etiquetas</h3>
                                        <button type="button" id="add-etiqueta"
                                            class="btn-add inline-flex items-center px-2 py-1 border border-transparent text-xs font-medium rounded shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                            <span>‚ûï</span> A√±adir </button>
                                    </div>
                                    <div id="etiquetas-container" class="space-y-2">
                                        <div class="etiqueta-item flex items-center gap-2">
                                            <input type="text" name="etiquetas[]" placeholder="Ej: Realidad Aumentada"
                                                class="block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 sm:text-sm">
                                            <button type="button"
                                                class="btn-remove remove-item inline-flex justify-center items-center p-1 border border-red-300 text-xs font-medium rounded text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                                <span>üóëÔ∏è</span> </button>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h3 class="text-lg font-medium text-gray-700 mb-2"><span>‚òëÔ∏è</span> Asignaturas</h3>
                                    <div class="space-y-2">
                                        <div class="flex items-center">
                                            <input id="asig-lab" name="asignaturas[]" type="checkbox"
                                                value="Laboratorio de convergencia"
                                                class="h-4 w-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                                            <label for="asig-lab" class="ml-2 block text-sm text-gray-900">Laboratorio
                                                de convergencia</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input id="asig-cod" name="asignaturas[]" type="checkbox"
                                                value="C√≥digos y lenguajes"
                                                class="h-4 w-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                                            <label for="asig-cod" class="ml-2 block text-sm text-gray-900">C√≥digos y
                                                lenguajes</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input id="asig-hist" name="asignaturas[]" type="checkbox"
                                                value="Historia de las artes electr√≥nicas"
                                                class="h-4 w-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                                            <label for="asig-hist" class="ml-2 block text-sm text-gray-900">Historia de
                                                las artes electr√≥nicas</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input id="asig-mod" name="asignaturas[]" type="checkbox"
                                                value="Modelado 3D"
                                                class="h-4 w-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                                            <label for="asig-mod" class="ml-2 block text-sm text-gray-900">Modelado
                                                3D</label>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label for="ovc-semestre"
                                        class="block text-sm font-medium text-gray-700 mb-1"><span>üìÖ</span>
                                        A√±o-Semestre</label> <select id="ovc-semestre" name="ovc-semestre"
                                        class="mt-1 block w-full rounded-md border-gray-300 py-2 pl-3 pr-10 text-base focus:border-pink-500 focus:outline-none focus:ring-pink-500 sm:text-sm">
                                        <option>2025-2</option>
                                        <option selected>2025-1</option>
                                        <option>2024-2</option>
                                        <option>2024-1</option>
                                        <option>2023-2</option>
                                        <option>2023-1</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="ovc-licencia"
                                        class="block text-sm font-medium text-gray-700 mb-1"><span>¬©Ô∏è</span> Tipo de
                                        Licenciamiento</label> <select id="ovc-licencia" name="ovc-licencia"
                                        class="mt-1 block w-full rounded-md border-gray-300 py-2 pl-3 pr-10 text-base focus:border-pink-500 focus:outline-none focus:ring-pink-500 sm:text-sm">
                                        <option selected value="CC BY">Creative Commons Atribuci√≥n (CC BY)</option>
                                        <option value="CC BY-SA">Creative Commons Atribuci√≥n-CompartirIgual (CC BY-SA)
                                        </option>
                                        <option value="CC BY-NC">Creative Commons Atribuci√≥n-NoComercial (CC BY-NC)
                                        </option>
                                        <option value="CC BY-ND">Creative Commons Atribuci√≥n-SinDerivadas (CC BY-ND)
                                        </option>
                                        <option value="CC BY-NC-SA">Creative Commons
                                            Atribuci√≥n-NoComercial-CompartirIgual (CC BY-NC-SA)</option>
                                        <option value="CC BY-NC-ND">Creative Commons Atribuci√≥n-NoComercial-SinDerivadas
                                            (CC BY-NC-ND)</option>
                                        <option value="CC0">Creative Commons Dominio P√∫blico (CC0)</option>
                                        <option value="Proprietary">Propietario / Todos los derechos reservados</option>
                                    </select>
                                </div>
                            </div>
                            <div class="border-b border-gray-200 pb-6">
                                <div class="flex justify-between items-center mb-3">
                                    <h2 class="text-xl font-semibold text-gray-700"><span>üîó</span> Enlaces Externos
                                    </h2> <button type="button" id="add-enlace"
                                        class="btn-add inline-flex items-center px-3 py-1.5 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                        <span>‚ûï</span> A√±adir Enlace </button>
                                </div>
                                <div id="enlaces-container" class="space-y-4">
                                    <div
                                        class="enlace-item grid grid-cols-1 sm:grid-cols-3 gap-4 items-end p-4 border rounded-md bg-gray-50">
                                        <div class="sm:col-span-1">
                                            <label class="block text-xs font-medium text-gray-600"><span>‚ÑπÔ∏è</span>
                                                Descripci√≥n</label> <input type="text" name="enlace_desc[]"
                                                placeholder="Ej: Repositorio GitHub"
                                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 sm:text-sm">
                                        </div>
                                        <div class="sm:col-span-1">
                                            <label class="block text-xs font-medium text-gray-600"><span>üîó</span>
                                                URL</label> <input type="url" name="enlace_url[]"
                                                placeholder="https://ejemplo.com"
                                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 sm:text-sm">
                                        </div>
                                        <button type="button"
                                            class="btn-remove remove-item self-end inline-flex justify-center items-center px-3 py-1.5 border border-red-300 text-sm font-medium rounded-md shadow-sm text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                            <span>üóëÔ∏è</span> </button>
                                    </div>
                                </div>
                            </div>
                            <div class="border-b border-gray-200 pb-6">
                                <h2 class="text-xl font-semibold text-gray-700 mb-4"><span>üìé</span> Archivo Principal
                                </h2>
                                <div>
                                    <label for="ovc-archivo"
                                        class="block text-sm font-medium text-gray-700 mb-1"><span>‚òÅÔ∏è</span> Subir
                                        archivo del OVC</label> <input type="file" id="ovc-archivo" name="ovc-archivo"
                                        class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-pink-50 file:text-pink-700 hover:file:bg-pink-100 custom-file-input">
                                    <span id="archivo-filename" class="text-xs text-gray-500 mt-1 block"></span>
                                </div>
                            </div>
                            <div class="border-b border-gray-200 pb-6">
                                <div class="flex justify-between items-center mb-3">
                                    <h2 class="text-xl font-semibold text-gray-700"><span>‚ÜîÔ∏è</span> Relaciones con otros
                                        OVC</h2> <button type="button" id="add-relacion"
                                        class="btn-add inline-flex items-center px-3 py-1.5 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                        <span>‚ûï</span> A√±adir Relaci√≥n </button>
                                </div>
                                <div id="relaciones-container" class="space-y-4">
                                    <div
                                        class="relacion-item grid grid-cols-1 sm:grid-cols-4 gap-4 items-end p-4 border rounded-md bg-gray-50">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-600"><span>üîó</span> OVC
                                                Relacionado</label> <input type="text" name="relacion_ovc[]"
                                                placeholder="Buscar o seleccionar OVC..."
                                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 sm:text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-600"><span>üè∑Ô∏è</span>
                                                Etiqueta de Relaci√≥n</label> <input type="text"
                                                name="relacion_etiqueta[]" placeholder="Ej: Se basa en, Contin√∫a"
                                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 sm:text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-600"><span>‚ÜîÔ∏è</span>
                                                Direcci√≥n</label> <select name="relacion_direccion[]"
                                                class="mt-1 block w-full rounded-md border-gray-300 py-2 pl-3 pr-10 text-base focus:border-pink-500 focus:outline-none focus:ring-pink-500 sm:text-sm">
                                                <option value="saliente">Saliente (Este OVC -> Otro)</option>
                                                <option value="entrante">Entrante (Otro OVC -> Este)</option>
                                                <option value="bidireccional">Bidireccional</option>
                                            </select>
                                        </div>
                                        <button type="button"
                                            class="btn-remove remove-item self-end inline-flex justify-center items-center px-3 py-1.5 border border-red-300 text-sm font-medium rounded-md shadow-sm text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                            <span>üóëÔ∏è</span> </button>
                                    </div>
                                </div>
                            </div>

                            <div class="flex justify-end pt-6">
                                <button type="submit" id="form-submit-button"
                                    class="inline-flex items-center justify-center py-2 px-6 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-pink-600 hover:bg-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500">
                                    <span class="mr-2">üíæ</span><span id="form-submit-button-text">Guardar OVC</span>
                                </button>
                            </div>
                        </form>
                    </div>


                    <div id="rizoma-section" class="hidden flex flex-col flex-1 min-h-0 h-full"> <!-- Added h-full -->

                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-2xl font-semibold text-gray-800"><span>üå±</span> Rizoma</h1>
                            <div class="relative">
                                <span class="search-icon">üîç</span>
                                <input type="text" placeholder="Buscar..." id="rizoma-search-input"
                                    class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-transparent">
                            </div>
                        </div>

                        <div
                            class="bg-white rounded-lg shadow flex-1 flex flex-col text-gray-500 min-h-0 h-full"> <!-- Removed min-h-[600px] test class -->
                            <svg id="rizoma-graph" class="w-full h-full"></svg>
                        </div>
                    </div>

                </div>

        </div>


        </main>

    </div>

    </div>

    <div id="confirmation-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden"
        aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div id="modal-overlay" class="absolute inset-0 bg-gray-600 bg-opacity-75 modal-overlay"></div>
        <div class="modal-content bg-white rounded-lg shadow-xl overflow-hidden transform sm:max-w-md sm:w-full mx-4">
            <div class="px-6 py-4">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title"><span>‚úÖ</span> Confirmaci√≥n
                    </h3> <button id="modal-close-button-x" type="button"
                        class="text-gray-400 hover:text-gray-600 text-2xl">
                        <span>‚ùå</span> </button>
                </div>
                <div class="mt-4 text-center">
                    <span class="text-5xl mb-3 inline-block">‚úÖ</span>
                    <p class="text-lg text-gray-700" id="confirmation-modal-text">
                        ¬°El OVC se ha guardado correctamente!
                    </p>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-3 text-right">
                <button id="modal-close-button-ok" type="button"
                    class="inline-flex items-center justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-pink-600 text-base font-medium text-white hover:bg-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500 sm:text-sm">
                    Aceptar
                </button>
            </div>
        </div>
    </div>

    <div id="delete-confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden"
        aria-labelledby="delete-modal-title" role="dialog" aria-modal="true">
        <div id="delete-modal-overlay" class="absolute inset-0 bg-gray-800 bg-opacity-60 modal-overlay"></div>
        <div class="modal-content bg-white rounded-lg shadow-xl overflow-hidden transform sm:max-w-lg sm:w-full mx-4">
            <div class="px-6 py-5">
                <div class="flex items-start">
                    <div
                        class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                        <span class="text-red-600 text-xl">‚ö†Ô∏è</span>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="delete-modal-title">
                            Confirmar Eliminaci√≥n
                        </h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-600">
                                ¬øEst√°s seguro de que quieres eliminar este OVC? Esta acci√≥n no se puede deshacer.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-100 px-6 py-4 sm:flex sm:flex-row-reverse">
                <button id="delete-confirm-button" type="button"
                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Eliminar
                </button>
                <button id="delete-cancel-button" type="button"
                    class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <div id="ovc-summary-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden transition-opacity duration-300"
        aria-labelledby="ovc-summary-modal-title" role="dialog" aria-modal="true">
        <div id="ovc-summary-modal-overlay" class="absolute inset-0 bg-gray-600 bg-opacity-75"></div>
        <div class="modal-content bg-white rounded-lg shadow-xl overflow-hidden transform sm:max-w-lg sm:w-full mx-4">
            <div class="px-6 py-4">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="ovc-summary-modal-title"><span></span></h3>
                    <button id="ovc-summary-modal-close" type="button" class="text-gray-400 hover:text-gray-600 text-2xl">
                    </button>
                </div>
                <div class="mt-4">
                    <div id="ovc-summary-modal-content" class="flex flex-col space-y-4 items-start">
                        <!-- Aqu√≠ se llenar√° el contenido din√°micamente -->
                        <div class="flex-1">
                            <h4 class="text-md font-semibold text-gray-700">Detalles</h4>
                            <p class="text-sm text-gray-600">Aqu√≠ se mostrar√°n los detalles principales del OVC.</p>
                        </div>
                        <div class="flex-1">
                            <h4 class="text-md font-semibold text-gray-700">Autores</h4>
                            <ul class="list-disc list-inside text-sm text-gray-600">
                                <li>Autor 1</li>
                                <li>Autor 2</li>
                            </ul>
                        </div>
                        <div class="flex-1">
                            <h4 class="text-md font-semibold text-gray-700">Etiquetas</h4>
                            <span class="inline-block bg-gray-200 text-gray-700 text-xs font-medium px-2 py-1 rounded">Etiqueta 1</span>
                            <span class="inline-block bg-gray-200 text-gray-700 text-xs font-medium px-2 py-1 rounded">Etiqueta 2</span>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-6 py-3 text-right">
                    <button id="ovc-summary-modal-ok" type="button"
                        class="inline-flex items-center justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-pink-600 text-base font-medium text-white hover:bg-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500 sm:text-sm">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="rizoma.js"></script>
    <script>
        /**
         * ADVERTENCIA IMPORTANTE SOBRE LOCALSTORAGE Y ARCHIVOS:
         * Guardar im√°genes (o archivos grandes) como Base64 en localStorage
         * NO es recomendable para aplicaciones reales. localStorage tiene l√≠mites
         * de tama√±o estrictos (5-10MB) que se alcanzan r√°pidamente.
         * La soluci√≥n est√°ndar es subir los archivos a un servidor y guardar
         * solo la URL en localStorage o en una base de datos.
         * Esta implementaci√≥n con Base64 es solo para fines de DEMOSTRACI√ìN
         * en este entorno limitado.
         */
        // Funci√≥n para obtener OVCs desde localStorage
        function getOvcsFromStorage() {
            const ovcsJson = localStorage.getItem('ovcData');
            try {
                return ovcsJson ? JSON.parse(ovcsJson) : [];
            } catch (e) {
                console.error("Error al analizar los datos de OVC:", e);
                return [];
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const summaryModal = document.getElementById('ovc-summary-modal');
            const summaryModalOverlay = document.getElementById('ovc-summary-modal-overlay');
            const summaryModalClose = document.getElementById('ovc-summary-modal-close');
            const summaryModalOk = document.getElementById('ovc-summary-modal-ok');
            const summaryModalContent = document.getElementById('ovc-summary-modal-content');

            // Funci√≥n para mostrar el modal con el resumen del OVC
            window.showSummaryModal = function(ovcId) { // Hacer la funci√≥n global
                const ovcs = getOvcsFromStorage();
                const ovc = ovcs.find(ovc => ovc.id === Number(ovcId));

                if (!ovc) {
                    console.error(`Error: No se encontr√≥ el OVC con ID ${ovcId}`);
                    return;
                }

                // Generar contenido del resumen
                summaryModalContent.innerHTML = `
            <div class="p-4 bg-white rounded-lg shadow-lg space-y-4">
                <div>
                    ${ovc.imagen && ovc.imagen.dataUrl ? `<img src="${ovc.imagen.dataUrl}" alt="Imagen de Portada" class="w-full h-auto rounded-md">` : '<span>No disponible</span>'}
                </div>
                <div>
                    <strong>T√≠tulo:</strong> ${ovc.titulo || 'N/A'}
                </div>
                <div>
                    <strong>Descripci√≥n:</strong> ${ovc.descripcion || 'N/A'}
                </div>
                <div>
                    <strong>Autores:</strong> ${ovc.autores.map(a => `${a.nombre} (${a.rol})`).join(', ') || 'N/A'}
                </div>
                <div>
                    <strong>Semestre:</strong> ${ovc.semestre || 'N/A'}
                </div>
                <div>
                    <strong>Etiquetas:</strong> ${ovc.etiquetas.join(', ') || 'N/A'}
                </div>
                <div>
                    <strong>Relaciones:</strong> ${ovc.relaciones.map(r => `${r.ovc} (${r.etiqueta})`).join(', ') || 'N/A'}
                </div>
                <div>
                    <strong>Enlaces Externos:</strong><br>
                    ${ovc.enlaces.map(e => `<a href="${e.url}" target="_blank" class="text-blue-600 underline">${e.descripcion}</a>`).join('<br>') || 'N/A'}
                </div>
            </div>
        `;

                // Mostrar el modal con animaci√≥n
                summaryModal.classList.remove('hidden');
                summaryModal.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                setTimeout(() => {
                    summaryModal.classList.remove('opacity-0');
                }, 10);
            }

            // Funci√≥n para ocultar el modal
            function hideSummaryModal() {
                summaryModal.classList.add('hidden');
            }

            // Listeners para cerrar el modal
            summaryModalOverlay.addEventListener('click', hideSummaryModal);
            summaryModalClose.addEventListener('click', hideSummaryModal);
            summaryModalOk.addEventListener('click', hideSummaryModal);

            // Listener para el bot√≥n "Ver"
            const ovcTableBody = document.getElementById('ovc-table-body');
            if (ovcTableBody) {
                ovcTableBody.addEventListener('click', function (event) {
                    const viewButton = event.target.closest('.view-ovc-btn');
                    if (viewButton) {
                        event.preventDefault();
                        const ovcId = viewButton.getAttribute('data-id');
                        showSummaryModal(ovcId);
                    }
                });
            }
        });
        document.addEventListener('DOMContentLoaded', function () {
            // --- Selecci√≥n de Elementos ---
            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            const contentArea = document.getElementById('content-area');
            const sectionTitle = document.getElementById('section-title');
            const ovcTableBody = document.getElementById('ovc-table-body');
            const goToCreateBtn = document.getElementById('go-to-create-btn');
            const crearOvcForm = document.getElementById('crear-ovc-form');
            const formSubmitButton = document.getElementById('form-submit-button');
            const formSubmitButtonText = document.getElementById('form-submit-button-text');
            const editOvcIdInput = document.getElementById('edit-ovc-id');
            const imagenInput = document.getElementById('ovc-imagen');
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const imagenFilenameSpan = document.getElementById('imagen-filename');
            const imagenDataUrlInput = document.getElementById('imagen-data-url'); // Input oculto para DataURL
            const archivoInput = document.getElementById('ovc-archivo');
            const archivoFilenameSpan = document.getElementById('archivo-filename');
            const confirmationModal = document.getElementById('confirmation-modal');
            const confirmationModalText = document.getElementById('confirmation-modal-text');
            const modalOverlay = document.getElementById('modal-overlay');
            const modalCloseButtonX = document.getElementById('modal-close-button-x');
            const modalCloseButtonOk = document.getElementById('modal-close-button-ok');
            const deleteConfirmModal = document.getElementById('delete-confirm-modal');
            const deleteModalOverlay = document.getElementById('delete-modal-overlay');
            const deleteConfirmButton = document.getElementById('delete-confirm-button');
            const deleteCancelButton = document.getElementById('delete-cancel-button');

            const sections = {
                crear: document.getElementById('crear-section'),
                listar: document.getElementById('listar-section'),
                rizoma: document.getElementById('rizoma-section')
            };
            const sectionTitles = {
                crear: '<span>‚ûï</span> Crear Nuevo Objeto Virtual Creativo',
                listar: '<span>üìã</span> Mis objetos virtuales creativos',
                rizoma: '<span>üå±</span> Visualizaci√≥n del Rizoma'
            };
            const OVC_STORAGE_KEY = 'ovcData';

            // --- Estado de Edici√≥n ---
            let isEditMode = false;
            let currentEditOvcId = null;
            let ovcIdToDeleteConfirm = null;

            // --- Navegaci√≥n ---
            function showSection(sectionId) {
                // console.log(`DEBUG: Mostrando secci√≥n: ${sectionId}`); // Menos verboso
                Object.values(sections).forEach(section => {
                    if (section) section.classList.add('hidden');
                });
                sidebarLinks.forEach(link => link.classList.remove('active'));

                const activeSection = sections[sectionId];
                if (activeSection) activeSection.classList.remove('hidden');

                if (sectionId !== 'crear' && isEditMode) {
                    resetFormToCreateMode();
                }

                if (sectionTitles[sectionId]) {
                    sectionTitle.innerHTML = sectionTitles[sectionId];
                }

                const activeLink = document.querySelector(`.sidebar-link[data-section="${sectionId}"]`);
                if (activeLink) activeLink.classList.add('active');

                if (sectionId === 'listar') {
                    renderOvcTable();
                } else if (sectionId === 'crear' && !isEditMode) {
                    resetFormToCreateMode();
                } else if (sectionId === 'rizoma') {
                    // Retrasar ligeramente la renderizaci√≥n para dar tiempo al layout
                    setTimeout(() => {
                        console.log("DEBUG: Llamando a renderRizomaGraph desde showSection (retrasado)");
                        renderRizomaGraph(); // Renderizar el grafo
                    }, 50); // Un retraso corto deber√≠a ser suficiente
                }
            }

            sidebarLinks.forEach(link => { /* ... */
                link.addEventListener('click', function (event) {
                    event.preventDefault();
                    const sectionId = this.getAttribute('data-section');
                    showSection(sectionId);
                });
            });
            if (goToCreateBtn) { /* ... */
                goToCreateBtn.addEventListener('click', () => {
                    resetFormToCreateMode();
                    showSection('crear');
                });
            }

            // --- LocalStorage y Renderizado Tabla ---

            function saveOvcsToStorage(ovcs) {
                try {
                    if (!Array.isArray(ovcs)) { console.error("Error: Not an array:", ovcs); return; }
                    const dataToSave = JSON.stringify(ovcs);
                    // console.log(`DEBUG: Guardando en localStorage (${OVC_STORAGE_KEY}):`, dataToSave); // Opcional: muy verboso con Base64
                    localStorage.setItem(OVC_STORAGE_KEY, dataToSave);
                    console.log("DEBUG: Guardado/Actualizado exitoso en localStorage.");
                } catch (e) {
                    console.error("Error saving OVC data to localStorage:", e);
                    // Podr√≠a ser un error de cuota si las im√°genes son muy grandes
                    if (e.name === 'QuotaExceededError') {
                        alert('Error: No se pudo guardar. El almacenamiento local est√° lleno.\n(Guardar im√°genes directamente tiene l√≠mites).');
                    } else {
                        alert('Error inesperado al guardar los datos.');
                    }
                }
            }
            function renderOvcTable() { /* ... c√≥digo sin cambios ... */
                if (!ovcTableBody) return;
                const ovcs = getOvcsFromStorage();
                ovcTableBody.innerHTML = '';
                const paginationStart = document.getElementById('pagination-start');
                const paginationEnd = document.getElementById('pagination-end');
                const paginationTotal = document.getElementById('pagination-total');
                if (paginationStart && paginationEnd && paginationTotal) {
                    paginationStart.textContent = ovcs.length > 0 ? '1' : '0';
                    paginationEnd.textContent = ovcs.length;
                    paginationTotal.textContent = ovcs.length;
                }
                if (ovcs.length === 0) {
                    ovcTableBody.innerHTML = `<tr class="empty-table-row"><td colspan="6">No hay OVCs guardados.</td></tr>`;
                } else {
                    ovcs.forEach((ovc) => {
                        const row = document.createElement('tr');
                        const truncate = (str, num) => str && str.length > num ? str.slice(0, num) + "..." : str;
                        const displayAutores = (autores) => {
                            if (!autores || !Array.isArray(autores) || autores.length === 0) return 'N/A';
                            const firstAuthor = autores[0].nombre || 'Autor Desconocido';
                            const remainingCount = autores.length - 1;
                            return `${firstAuthor}${remainingCount > 0 ? ` (+${remainingCount})` : ''}`;
                        };
                        const asignaturasStr = Array.isArray(ovc.asignaturas) ? ovc.asignaturas.join(', ') : '';
                        const etiquetasStr = Array.isArray(ovc.etiquetas) ? ovc.etiquetas.join(', ') : '';
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${ovc.titulo || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${displayAutores(ovc.autores)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${truncate(asignaturasStr, 30) || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ovc.semestre || 'N/A'}</td>
                            <td class="px-6 py-4 text-sm text-gray-500 break-words">${truncate(etiquetasStr, 40) || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <a href="#" class="text-indigo-600 hover:text-indigo-900 action-btn edit-ovc-btn" title="Editar" data-id="${ovc.id}">‚úèÔ∏è</a>
                                <a href="#" class="text-blue-600 hover:text-blue-900 ml-4 action-btn view-ovc-btn" title="Ver" data-id="${ovc.id}">üîç</a>
                                <a href="#" class="text-red-600 hover:text-red-900 ml-4 action-btn delete-ovc-btn" title="Eliminar" data-id="${ovc.id}">üóëÔ∏è</a>
                            </td>
                        `;
                        ovcTableBody.appendChild(row);
                    });
                }
            }

            // --- Funcionalidad Formulario Crear/Editar OVC ---

            // Previsualizaci√≥n de Imagen (con Base64)
            if (imagenInput && imagePreviewContainer && imagenFilenameSpan && imagenDataUrlInput) {
                imagenInput.addEventListener('change', function (event) {
                    console.log("DEBUG: Evento 'change' detectado en input de imagen.");
                    const file = event.target.files[0];
                    imagenDataUrlInput.value = ''; // Limpiar DataURL anterior
                    imagenFilenameSpan.dataset.originalName = ''; // Limpiar nombre anterior

                    if (file && file.type.startsWith('image/')) {
                        imagenFilenameSpan.textContent = `Procesando: ${file.name}...`; // Mensaje mientras carga
                        imagePreviewContainer.innerHTML = '<span>Cargando...</span>';
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            const dataUrl = e.target.result;
                            console.log("DEBUG: FileReader carg√≥ la imagen como DataURL (tama√±o aprox:", Math.round(dataUrl.length / 1024), "KB)");
                            if (dataUrl.length > 5 * 1024 * 1024) { // Advertencia si > 5MB (aproximado)
                                console.warn("ADVERTENCIA: La imagen es muy grande, podr√≠a llenar localStorage.");
                                alert("Advertencia: La imagen seleccionada es muy grande y podr√≠a causar problemas de almacenamiento.");
                            }
                            imagePreviewContainer.innerHTML = `<img src="${dataUrl}" alt="Previsualizaci√≥n">`;
                            imagenDataUrlInput.value = dataUrl; // Guardar DataURL temporalmente
                            imagenFilenameSpan.dataset.originalName = file.name; // Guardar nombre original
                            imagenFilenameSpan.textContent = `Nuevo archivo: ${file.name}`; // Actualizar span
                        }
                        reader.onerror = function (e) { /* ... error handling ... */
                            console.error("DEBUG: Error de FileReader:", e);
                            imagenFilenameSpan.textContent = 'Error al leer archivo';
                            imagePreviewContainer.innerHTML = '<span>Error</span>';
                        }
                        reader.readAsDataURL(file);
                    } else if (file) { /* ... archivo no imagen ... */
                        console.warn("DEBUG: Tipo de archivo no soportado:", file.type);
                        imagenFilenameSpan.textContent = `Archivo ${file.name} no es una imagen.`;
                        imagePreviewContainer.innerHTML = '<span>No es imagen</span>';
                        imagenInput.value = '';
                    } else { /* ... no se seleccion√≥ archivo ... */
                        console.log("DEBUG: No se seleccion√≥ archivo.");
                        imagenFilenameSpan.textContent = isEditMode ? imagenFilenameSpan.textContent : '';
                        imagePreviewContainer.innerHTML = isEditMode ? imagePreviewContainer.innerHTML : '<span>Previsualizaci√≥n</span>';
                    }
                });
            } else { console.warn("DEBUG: Faltan elementos para previsualizaci√≥n."); }

            // Nombre archivo principal (sin cambios)
            if (archivoInput && archivoFilenameSpan) { /* ... */
                archivoInput.addEventListener('change', function (event) {
                    const file = event.target.files[0];
                    if (file) { archivoFilenameSpan.textContent = `Archivo seleccionado: ${file.name}`; }
                    else { if (!isEditMode) { archivoFilenameSpan.textContent = ''; } }
                });
            }

            // Listas din√°micas (sin cambios)
            function setupDynamicList(containerId, addButtonId, itemSelector) { /* ... */
                const container = document.getElementById(containerId);
                const addButton = document.getElementById(addButtonId);
                if (!container || !addButton) return;
                const template = container.querySelector(itemSelector);
                if (!template) return;
                const templateHTML = template.cloneNode(true);
                addButton.addEventListener('click', () => { /* ... */
                    const newItem = templateHTML.cloneNode(true);
                    newItem.querySelectorAll('input, select, textarea').forEach(input => {
                        if (input.type === 'checkbox' || input.type === 'radio') input.checked = false;
                        else input.value = '';
                    });
                    container.appendChild(newItem);
                });
                container.addEventListener('click', (event) => { /* ... */
                    const removeButton = event.target.closest('.remove-item');
                    if (removeButton) {
                        const itemToRemove = removeButton.closest(itemSelector);
                        if (container.querySelectorAll(itemSelector).length > 1) {
                            if (itemToRemove) itemToRemove.remove();
                        } else {
                            itemToRemove.querySelectorAll('input, select, textarea').forEach(input => {
                                if (input.type === 'checkbox' || input.type === 'radio') input.checked = false;
                                else input.value = '';
                            });
                        }
                    }
                });
            }
            setupDynamicList('autores-container', 'add-autor', '.autor-item');
            setupDynamicList('etiquetas-container', 'add-etiqueta', '.etiqueta-item');
            setupDynamicList('enlaces-container', 'add-enlace', '.enlace-item');
            setupDynamicList('relaciones-container', 'add-relacion', '.relacion-item');

            // --- L√≥gica de Edici√≥n ---
            function populateFormForEdit(ovcId) {
                console.log(`DEBUG: Iniciando populateFormForEdit para ID: ${ovcId}`);
                const ovcs = getOvcsFromStorage();
                const ovcData = ovcs.find(ovc => ovc.id === Number(ovcId));

                if (!ovcData) { /* ... error handling ... */
                    console.error(`Error: No se encontr√≥ OVC con ID ${ovcId} para editar.`);
                    resetFormToCreateMode(); return;
                }

                // console.log("DEBUG: Datos del OVC a editar:", ovcData); // Opcional: puede ser muy verboso con Base64
                isEditMode = true;
                currentEditOvcId = ovcData.id;
                editOvcIdInput.value = ovcData.id;
                // El t√≠tulo de la secci√≥n 'crear' se actualiza en showSection
                // Ya no se necesita manipular #crear-title aqu√≠.
                formSubmitButtonText.textContent = 'Actualizar OVC';

                // Rellenar campos simples
                document.getElementById('ovc-titulo').value = ovcData.titulo || '';
                document.getElementById('ovc-descripcion').value = ovcData.descripcion || '';
                document.getElementById('ovc-semestre').value = ovcData.semestre || '2025-1';
                document.getElementById('ovc-licencia').value = ovcData.licencia || 'CC BY';

                // --- Manejo de Imagen Guardada (Base64) ---
                imagenInput.value = ''; // Limpiar input file
                imagenDataUrlInput.value = ''; // Limpiar DataURL temporal
                if (ovcData.imagen && ovcData.imagen.dataUrl && typeof ovcData.imagen.dataUrl === 'string' && ovcData.imagen.dataUrl.startsWith('data:image')) {
                    console.log("DEBUG: Mostrando imagen guardada (Base64)");
                    imagePreviewContainer.innerHTML = `<img src="${ovcData.imagen.dataUrl}" alt="Previsualizaci√≥n guardada">`;
                    imagenFilenameSpan.textContent = `Archivo actual: ${ovcData.imagen.filename || 'Desconocido'}`;
                    // Guardar nombre original en data attribute por si no se cambia la imagen
                    imagenFilenameSpan.dataset.originalName = ovcData.imagen.filename || '';
                } else {
                    console.log("DEBUG: No hay imagen guardada o dataUrl inv√°lido.");
                    imagePreviewContainer.innerHTML = '<span>No hay imagen guardada</span>';
                    imagenFilenameSpan.textContent = '';
                    imagenFilenameSpan.dataset.originalName = '';
                }

                // Archivo principal (solo nombre)
                archivoFilenameSpan.textContent = ovcData.archivo ? `Archivo actual: ${ovcData.archivo.replace('Archivo seleccionado: ', '')}` : '';
                archivoInput.value = '';

                // Rellenar checkboxes y listas din√°micas (sin cambios)
                document.querySelectorAll('input[name="asignaturas[]"]').forEach(checkbox => { /* ... */
                    checkbox.checked = ovcData.asignaturas?.includes(checkbox.value) || false;
                });
                populateDynamicListField('autores-container', '.autor-item', ovcData.autores || [], (item, data) => { /* ... */
                    item.querySelector('input[name="autor_nombre[]"]').value = data.nombre || '';
                    item.querySelector('input[name="autor_rol[]"]').value = data.rol || '';
                    item.querySelector('input[name="autor_email[]"]').value = data.email || '';
                    item.querySelector('input[name="autor_participacion[]"]').value = data.participacion || '';
                });
                populateDynamicListField('etiquetas-container', '.etiqueta-item', ovcData.etiquetas || [], (item, data) => { /* ... */
                    item.querySelector('input[name="etiquetas[]"]').value = data || '';
                });
                populateDynamicListField('enlaces-container', '.enlace-item', ovcData.enlaces || [], (item, data) => { /* ... */
                    item.querySelector('input[name="enlace_desc[]"]').value = data.descripcion || '';
                    item.querySelector('input[name="enlace_url[]"]').value = data.url || '';
                });
                populateDynamicListField('relaciones-container', '.relacion-item', ovcData.relaciones || [], (item, data) => { /* ... */
                    item.querySelector('input[name="relacion_ovc[]"]').value = data.ovc || '';
                    item.querySelector('input[name="relacion_etiqueta[]"]').value = data.etiqueta || '';
                    item.querySelector('select[name="relacion_direccion[]"]').value = data.direccion || 'saliente';
                });

                console.log("DEBUG: Formulario poblado para edici√≥n.");
            }

            // Helper para poblar listas din√°micas (sin cambios)
            function populateDynamicListField(containerId, itemSelector, dataArray, fillFunction) { /* ... c√≥digo sin cambios ... */
                const container = document.getElementById(containerId);
                if (!container) return;
                const template = container.querySelector(itemSelector);
                if (!template) return;
                container.querySelectorAll(`${itemSelector}:not(:first-child)`).forEach(el => el.remove());
                const firstItem = container.querySelector(itemSelector);
                if (!Array.isArray(dataArray) || dataArray.length === 0) {
                    firstItem.querySelectorAll('input, select, textarea').forEach(input => {
                        if (input.type === 'checkbox' || input.type === 'radio') input.checked = false;
                        else input.value = '';
                    });
                } else {
                    dataArray.forEach((data, index) => {
                        let currentItem = (index === 0) ? firstItem : template.cloneNode(true);
                        if (index > 0) container.appendChild(currentItem);
                        fillFunction(currentItem, data);
                    });
                }
            }

            // Funci√≥n para resetear el formulario a modo creaci√≥n (actualizada para DataURL)
            function resetFormToCreateMode() {
                console.log("DEBUG: Reseteando formulario a modo creaci√≥n.");
                isEditMode = false;
                currentEditOvcId = null;
                editOvcIdInput.value = '';
                // crearTitle.innerHTML = '<span>‚ûï</span> Crear Nuevo Objeto Virtual Creativo'; // Eliminado: T√≠tulo gestionado por showSection
                formSubmitButtonText.textContent = 'Guardar OVC';
                crearOvcForm.reset();
                if (imagePreviewContainer) imagePreviewContainer.innerHTML = '<span>Previsualizaci√≥n</span>';
                if (imagenFilenameSpan) {
                    imagenFilenameSpan.textContent = '';
                    imagenFilenameSpan.dataset.originalName = ''; // Limpiar data attribute
                }
                if (archivoFilenameSpan) archivoFilenameSpan.textContent = '';
                if (imagenDataUrlInput) imagenDataUrlInput.value = ''; // Limpiar DataURL oculto
                // Limpiar listas din√°micas
                ['autores-container', 'etiquetas-container', 'enlaces-container', 'relaciones-container'].forEach(containerId => { /* ... */
                    const container = document.getElementById(containerId);
                    if (!container) return;
                    const itemSelector = `#${containerId} > div`;
                    container.querySelectorAll(`${itemSelector}:not(:first-child)`).forEach(el => el.remove());
                    const firstItem = container.querySelector(itemSelector);
                    if (firstItem) {
                        firstItem.querySelectorAll('input, select, textarea').forEach(input => {
                            if (input.type === 'checkbox' || input.type === 'radio') input.checked = false;
                            else input.value = '';
                        });
                    }
                });
                console.log("DEBUG: Formulario reseteado.");
            }


            // --- Guardado (Crear y Actualizar) y Modal Confirmaci√≥n ---
            function showConfirmationModal(isUpdate = false) { /* ... c√≥digo sin cambios ... */
                if (confirmationModal) {
                    confirmationModalText.textContent = isUpdate ? '¬°El OVC se ha actualizado correctamente!' : '¬°El OVC se ha guardado correctamente!';
                    confirmationModal.classList.remove('hidden');
                    modalOverlay.classList.add('opacity-100');
                    confirmationModal.querySelector('.modal-content').classList.add('scale-100');
                }
            }
            function hideConfirmationModal() { /* ... c√≥digo sin cambios ... */
                if (confirmationModal) {
                    modalOverlay.classList.remove('opacity-100');
                    confirmationModal.querySelector('.modal-content').classList.remove('scale-100');
                    setTimeout(() => { confirmationModal.classList.add('hidden'); }, 300);
                }
            }

            // Submit del formulario (Maneja Crear y Actualizar con Base64)
            if (crearOvcForm) {
                crearOvcForm.addEventListener('submit', function (event) {
                    event.preventDefault();
                    console.log(`DEBUG: Formulario enviado. Modo Edici√≥n: ${isEditMode}`);

                    const ovcs = getOvcsFromStorage();
                    let originalOvc = null;
                    if (isEditMode && currentEditOvcId) {
                        originalOvc = ovcs.find(ovc => ovc.id === Number(currentEditOvcId));
                    }

                    // --- Recolectar Imagen (Base64) ---
                    let imagenData = null;
                    const newDataUrl = imagenDataUrlInput.value; // Obtener DataURL del input oculto
                    const newFilename = imagenFilenameSpan.dataset.originalName; // Obtener nombre original del data attribute

                    if (newDataUrl && newFilename) {
                        imagenData = { dataUrl: newDataUrl, filename: newFilename };
                        console.log("DEBUG: Usando nueva imagen Base64.");
                    } else if (isEditMode && originalOvc && originalOvc.imagen) {
                        imagenData = originalOvc.imagen;
                        console.log("DEBUG: Conservando imagen Base64 original.");
                    } else {
                        console.log("DEBUG: No hay imagen nueva ni original.");
                    }

                    // 1. Recolectar datos
                    const formData = {
                        id: isEditMode ? Number(currentEditOvcId) : Date.now(),
                        titulo: document.getElementById('ovc-titulo')?.value || '',
                        descripcion: document.getElementById('ovc-descripcion')?.value || '',
                        imagen: imagenData, // Guardar objeto {dataUrl, filename} o null
                        autores: [],
                        etiquetas: [],
                        asignaturas: [],
                        semestre: document.getElementById('ovc-semestre')?.value || '',
                        licencia: document.getElementById('ovc-licencia')?.value || '',
                        enlaces: [],
                        archivo: archivoInput.files.length > 0 ? `Archivo seleccionado: ${archivoInput.files[0].name}` : (originalOvc ? originalOvc.archivo : ''),
                        relaciones: [],
                        fechaCreacion: isEditMode && originalOvc ? originalOvc.fechaCreacion : new Date().toISOString()
                    };
                    // ... (recolecci√≥n de autores, etiquetas, etc. - sin cambios) ...
                    document.querySelectorAll('#autores-container .autor-item').forEach(item => { /* ... */
                        const nombre = item.querySelector('input[name="autor_nombre[]"]')?.value || '';
                        if (nombre.trim() !== '') {
                            formData.autores.push({
                                nombre: nombre,
                                rol: item.querySelector('input[name="autor_rol[]"]')?.value || '',
                                email: item.querySelector('input[name="autor_email[]"]')?.value || '',
                                participacion: item.querySelector('input[name="autor_participacion[]"]')?.value || ''
                            });
                        }
                    });
                    document.querySelectorAll('#etiquetas-container .etiqueta-item input').forEach(input => { /* ... */
                        if (input.value.trim()) formData.etiquetas.push(input.value.trim());
                    });
                    document.querySelectorAll('input[name="asignaturas[]"]:checked').forEach(checkbox => { /* ... */
                        formData.asignaturas.push(checkbox.value);
                    });
                    document.querySelectorAll('#enlaces-container .enlace-item').forEach(item => { /* ... */
                        const desc = item.querySelector('input[name="enlace_desc[]"]')?.value || '';
                        const url = item.querySelector('input[name="enlace_url[]"]')?.value || '';
                        if (desc.trim() && url.trim()) { formData.enlaces.push({ descripcion: desc, url: url }); }
                    });
                    document.querySelectorAll('#relaciones-container .relacion-item').forEach(item => { /* ... */
                        const ovcRel = item.querySelector('input[name="relacion_ovc[]"]')?.value || '';
                        const etiquetaRel = item.querySelector('input[name="relacion_etiqueta[]"]')?.value || '';
                        const direccionRel = item.querySelector('select[name="relacion_direccion[]"]')?.value || '';
                        if (ovcRel.trim() && etiquetaRel.trim()) { formData.relaciones.push({ ovc: ovcRel, etiqueta: etiquetaRel, direccion: direccionRel }); }
                    });

                    console.log("DEBUG: Datos recolectados finales:", formData);

                    // 2. Guardar o Actualizar en localStorage
                    if (isEditMode) {
                        const index = ovcs.findIndex(ovc => ovc.id === formData.id);
                        if (index !== -1) {
                            console.log(`DEBUG: Actualizando OVC en √≠ndice ${index}`);
                            ovcs[index] = formData;
                            saveOvcsToStorage(ovcs);
                            showConfirmationModal(true);
                            resetFormToCreateMode();
                            showSection('listar');
                        } else { /* ... error handling ... */
                            console.error(`Error: No se encontr√≥ OVC con ID ${formData.id} para actualizar.`);
                            alert("Error al actualizar el OVC. No se encontr√≥ el original.");
                            resetFormToCreateMode();
                        }
                    } else {
                        console.log("DEBUG: Creando nuevo OVC.");
                        ovcs.push(formData);
                        saveOvcsToStorage(ovcs);
                        showConfirmationModal(false);
                        resetFormToCreateMode();
                    }
                });
            }

            // Cerrar modal de confirmaci√≥n
            if (modalOverlay) modalOverlay.addEventListener('click', hideConfirmationModal);
            if (modalCloseButtonX) modalCloseButtonX.addEventListener('click', hideConfirmationModal);
            if (modalCloseButtonOk) modalCloseButtonOk.addEventListener('click', hideConfirmationModal);

            // --- Funcionalidad de Borrado (con Modal) ---
            function showDeleteConfirmModal(ovcId) { /* ... c√≥digo sin cambios ... */
                ovcIdToDeleteConfirm = ovcId;
                if (deleteConfirmModal) {
                    console.log(`DEBUG: Mostrando modal de confirmaci√≥n de borrado para ID: ${ovcId}`);
                    deleteConfirmModal.classList.remove('hidden');
                }
            }
            function hideDeleteConfirmModal() { /* ... c√≥digo sin cambios ... */
                ovcIdToDeleteConfirm = null;
                if (deleteConfirmModal) {
                    console.log("DEBUG: Ocultando modal de confirmaci√≥n de borrado.");
                    deleteConfirmModal.classList.add('hidden');
                }
            }

            // Listener para botones dentro del modal de borrado
            if (deleteCancelButton) deleteCancelButton.addEventListener('click', hideDeleteConfirmModal);
            if (deleteModalOverlay) deleteModalOverlay.addEventListener('click', hideDeleteConfirmModal);

            if (deleteConfirmButton) { /* ... c√≥digo sin cambios ... */
                deleteConfirmButton.addEventListener('click', () => {
                    if (ovcIdToDeleteConfirm) {
                        console.log(`DEBUG: Confirmado borrado para ID: ${ovcIdToDeleteConfirm}`);
                        const ovcs = getOvcsFromStorage();
                        const updatedOvcs = ovcs.filter(ovc => ovc.id !== Number(ovcIdToDeleteConfirm));
                        if (ovcs.length === updatedOvcs.length) {
                            console.warn(`DEBUG: No se encontr√≥ OVC con ID ${ovcIdToDeleteConfirm} para borrar.`);
                        } else {
                            saveOvcsToStorage(updatedOvcs);
                            console.log("DEBUG: OVC eliminado. Renderizando tabla de nuevo...");
                            renderOvcTable();
                        }
                    } else { console.error("Error: No se encontr√≥ ID para borrar al confirmar."); }
                    hideDeleteConfirmModal();
                });
            }

            // Listener para clics en la tabla (Editar y Borrar)
            if (ovcTableBody) { /* ... c√≥digo sin cambios ... */
                ovcTableBody.addEventListener('click', function (event) {
                    const editButton = event.target.closest('.edit-ovc-btn');
                    const deleteButton = event.target.closest('.delete-ovc-btn');

                    if (editButton) {
                        event.preventDefault();
                        const ovcIdToEdit = editButton.getAttribute('data-id');
                        console.log(`DEBUG: Clic en Editar para ID: ${ovcIdToEdit}`);
                        if (ovcIdToEdit) {
                            populateFormForEdit(ovcIdToEdit);
                            showSection('crear');
                        }
                    } else if (deleteButton) {
                        event.preventDefault();
                        const ovcIdToDelete = deleteButton.getAttribute('data-id');
                        console.log(`DEBUG: Clic en Borrar para ID: ${ovcIdToDelete}`);
                        if (ovcIdToDelete) {
                            showDeleteConfirmModal(ovcIdToDelete);
                        }
                    }
                });
            } else { console.error("Error: Elemento #ovc-table-body no encontrado."); }


            // --- Inicializaci√≥n ---
            const initialActiveLink = document.querySelector('.sidebar-link.active');
            if (initialActiveLink) {
                showSection(initialActiveLink.getAttribute('data-section'));
            } else {
                showSection('listar'); // Mostrar lista por defecto
            }
            console.log("DEBUG: Script inicializado.");

            // Mover aqu√≠ la definici√≥n de renderRizomaGraph para que est√© en el scope correcto
            /**
             * Llama a la funci√≥n verRizoma para renderizar el grafo D3.
             */
            function renderRizomaGraph() {
                console.log("DEBUG: Llamando a verRizoma para renderizar el grafo.");
                const containerId = '#rizoma-graph'; // ID del elemento SVG
                const containerElement = document.querySelector(containerId);

                if (containerElement) {
                     // Asegurarse de que los datos est√©n en localStorage antes de llamar
                     if (localStorage.getItem('ovcData')) {
                        // Llamar a la funci√≥n as√≠ncrona verRizoma
                        verRizoma(containerId)
                            .then(() => {
                                console.log("DEBUG: Grafo rizoma renderizado exitosamente.");
                            })
                            .catch(error => {
                                console.error("Error al renderizar el grafo rizoma:", error);
                                // Opcionalmente mostrar error en la UI
                                containerElement.innerHTML = `<text x="50%" y="50%" text-anchor="middle" fill="red">Error al cargar grafo: ${error.message}</text>`;
                            });
                     } else {
                         console.warn("DEBUG: No hay 'ovcData' en localStorage. No se puede renderizar el grafo.");
                         containerElement.innerHTML = `<text x="50%" y="50%" text-anchor="middle">No hay datos OVC en localStorage para mostrar el grafo.</text>`;
                     }
                } else {
                    console.error(`Error: Contenedor SVG con ID '${containerId}' no encontrado.`);
                }
            }

             // --- B√∫squeda en Rizoma (Adaptar si es necesario para D3) ---
            // La l√≥gica actual de b√∫squeda manipula display, lo cual puede no funcionar
            // bien con D3 que controla las posiciones. Se necesitar√≠a una l√≥gica
            // diferente para resaltar o filtrar nodos/enlaces en D3.
            // Por ahora, comentamos la l√≥gica de b√∫squeda espec√≠fica del rizoma
            // para evitar conflictos con D3.
            /*
            const rizomaSearchInput = document.getElementById('rizoma-search-input');
            if (rizomaSearchInput) {
                rizomaSearchInput.addEventListener('input', () => {
                    const query = rizomaSearchInput.value.trim().toLowerCase();
                    console.log("B√∫squeda en Rizoma (l√≥gica pendiente de adaptar para D3):", query);
                    // Aqu√≠ ir√≠a la l√≥gica de filtrado/resaltado para D3
                    // Ejemplo: filtrar datos y volver a renderizar, o aplicar clases CSS
                });
            }
            */

        }); // Fin del listener DOMContentLoaded principal
        // Auto completado
        document.addEventListener('DOMContentLoaded', function () {


            // Funci√≥n para configurar autocompletado en un campo
            function setupAutocomplete(input) {
                input.addEventListener('input', function () {
                    const query = input.value.toLowerCase();
                    const ovcs = getOvcsFromStorage();
                    const match = ovcs.find(ovc => ovc.titulo && ovc.titulo.toLowerCase().startsWith(query));

                    if (match) {
                        input.value = match.titulo; // Autocompleta con la primera coincidencia
                    }
                });
            }

            // Configurar autocompletado para los campos existentes
            function initializeAutocomplete() {
                const relacionOvcInputs = document.querySelectorAll('input[name="relacion_ovc[]"]');
                relacionOvcInputs.forEach(input => {
                    // Evitar configurar el autocompletado m√°s de una vez
                    if (!input.dataset.autocompleteInitialized) {
                        setupAutocomplete(input);
                        input.dataset.autocompleteInitialized = true; // Marcar como inicializado
                    }
                });
            }

            // Inicializar autocompletado en los campos existentes al cargar la p√°gina
            initializeAutocomplete();

            // Detectar y configurar autocompletado para nuevos campos din√°micos
            const relacionesContainer = document.getElementById('relaciones-container');
            const observer = new MutationObserver(() => {
                initializeAutocomplete(); // Reconfigurar autocompletado para nuevos inputs
            });

            // Observar cambios en el contenedor de relaciones
            observer.observe(relacionesContainer, { childList: true, subtree: true });
        });
        // Las funciones renderRizomaGraph y la b√∫squeda comentada se movieron dentro del listener principal

    </script>
    <!-- Eliminada etiqueta </style> incorrecta -->
</body>

</html>