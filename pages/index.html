<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de OVC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../css/main.css">
    <!-- Cargar D3.js para la visualizaci√≥n del rizoma y biblioteca D3.js para visualizaci√≥n de grafos -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="../js/navigation.js"></script>
    <script src="../js/ovcStorage.js" defer></script>
    <script src="../js/ovcDisplay.js" defer></script>
    <script src="../js/ovcForm.js" defer></script>
    <script src="../js/utils.js" defer></script>
    <!-- Scripts espec√≠ficos para Rizoma y Kanban -->
    <script src="../js/rizoma-simple.js"></script>
    <script src="../js/kanban-simple.js"></script>
    <script>
    // Definir la funci√≥n showSection directamente en el HTML para asegurar que est√© disponible
    window.showSection = function(sectionId, contextId = null, contextTitle = null) {
        console.log(`DEBUG: Mostrando secci√≥n desde window.showSection en HTML: ${sectionId}`, contextId ? `(Context ID: ${contextId}, Title: ${contextTitle})` : '');
        
        // Verificar si existe la implementaci√≥n en navigation.js y usarla si est√° disponible
        if (window.navigationShowSection && typeof window.navigationShowSection === 'function') {
            console.log('DEBUG: Delegando a la implementaci√≥n en navigation.js');
            return window.navigationShowSection(sectionId, contextId, contextTitle);
        }
        
        // Implementaci√≥n de respaldo si navigation.js no est√° cargado a√∫n
        const sections = {
            crear: document.getElementById('crear-section'),
            listar: document.getElementById('listar-section'),
            rizoma: document.getElementById('rizoma-section'),
            kanban: document.getElementById('kanban-section')
        };
        
        // Ocultar todas las secciones
        Object.values(sections).forEach(section => {
            if (section) section.classList.add('hidden');
        });
        
        // Mostrar la secci√≥n seleccionada
        if (sections[sectionId]) {
            sections[sectionId].classList.remove('hidden');
            
            // Si es la secci√≥n de rizoma, intentar renderizar el grafo
            if (sectionId === 'rizoma' && typeof window.renderRizomaGraph === 'function') {
                console.log('DEBUG: Renderizando rizoma desde la implementaci√≥n HTML de showSection');
                setTimeout(() => window.renderRizomaGraph(), 100);
            }
        }
    };
    </script>
    <script>
        // Listeners DOMContentLoaded de l√≠neas 171-228 eliminados (redundantes con l√≥gica principal en 846+)
    </script>
    <!-- SortableJS for drag-and-drop subtasks -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <!-- Duplicate SortableJS removed -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
</head>

<body class="bg-gray-100 font-sans">
    <div class="flex h-screen bg-gray-100">
        <aside class="w-64 bg-white shadow-md flex flex-col fixed h-full z-10">
            <div class="logo-placeholder text-gray-700">
                <img src="../images/logocd.png" alt="Creaci√≥n Digital" style="max-width: 150px; height: auto;">
            </div>
            <nav class="flex-grow">
                <ul>
                    <li>
                        <a href="#" class="sidebar-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-200"
                            data-section="crear">
                            <span>‚ûï</span> <span>Crear OVC</span>
                        </a>
                    </li>
                    <li>
                        <a href="#"
                            class="sidebar-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-200 active"
                            data-section="listar">
                            <span>üìã</span> <span>Listar OVC</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" class="sidebar-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-200"
                            data-section="rizoma" id="rizoma-link">
                            <span>üå±</span> <span>Ver Rizoma</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" class="sidebar-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-200"
                            data-section="kanban">
                            <span>üìã</span> <span>Tablero Kanban</span>
                        </a>
                    </li>
                    </li>
                    <li>
                        <a href="#" class="sidebar-link flex items-center px-6 py-3 text-gray-700 hover:bg-gray-200"
                            id="rubricas-toggle">
                            <span>üìä</span> <span>R√∫bricas</span>
                            <span class="submenu-toggle-icon">‚ñ∂Ô∏è</span>
                        </a>
                        <ul class="submenu" id="rubricas-submenu">
                            <li>
                                <a href="disenar_rubrica.html"
                                    class="sidebar-link submenu-link flex items-center px-6 py-2 text-gray-600 hover:bg-gray-200">
                                    <span>‚úèÔ∏è</span> <span>Dise√±ar R√∫brica</span>
                                </a>
                            </li>
                            <li>
                                <a href="evaluar_ovc.html"
                                    class="sidebar-link submenu-link flex items-center px-6 py-2 text-gray-600 hover:bg-gray-200">
                                    <span>‚úîÔ∏è</span> <span>Evaluar OVC</span>
                                </a>
                            </li>
                            <li>
                                <a href="ver_promedios.html"
                                    class="sidebar-link submenu-link flex items-center px-6 py-2 text-gray-600 hover:bg-gray-200">
                                    <span>üìà</span> <span>Ver Promedios</span>
                                </a>
                            </li>
                            <li>
                                <a href="resumen_rubricas.html"
                                    class="sidebar-link submenu-link flex items-center px-6 py-2 text-gray-600 hover:bg-gray-200">
                                    <span>üìë</span> <span>Resumen R√∫bricas</span>
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </nav>
            <div class="p-4 mt-auto flex justify-center border-t border-gray-200">
                <img src="../images/logoudea.png" alt="Logo Ude@" class="udea-logo">
            </div>
        </aside>

        <div class="flex-1 flex flex-col ml-64 min-h-0"> <!-- Added min-h-0 -->
            <header class="bg-gray-800 shadow-md p-4 flex justify-between items-center">
                <div class="text-white text-xl font-semibold" id="section-title">
                    <span>üìã</span> Mis objetos virtuales creativos
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-white">üë§ Fernando Mora Angel</span>
                    <div
                        class="w-10 h-10 rounded-full bg-pink-500 flex items-center justify-center text-white font-bold">
                        FM
                    </div>
                    <button class="text-gray-300 hover:text-white text-xl" title="Salir">
                        <span>üö™</span> </button>
                </div>
            </header>

            <main class="flex-1 p-6 lg:p-8"> <!-- Removed overflow-y-auto -->
                <div id="content-area" class="flex flex-col flex-1 min-h-0 h-full"> <!-- Added h-full -->
                    <!-- La secciu00f3n para crear OVC se encuentra mu00e1s abajo -->

                    <!-- Secciu00f3n para listar OVCs -->
                    <div id="listar-section" class="space-y-6">
                        <div class="flex justify-between items-center mb-6">

                            <div class="flex items-center space-x-4">
                                <button id="go-to-create-btn"
                                    class="btn-create-ovc flex items-center px-4 py-2 rounded-lg shadow hover:shadow-md transition duration-300">
                                    <span>‚ûï</span><span>Crear OVC</span> </button>
                                <div class="relative">
                                    <span class="search-icon">üîç</span> <input type="text" placeholder="Buscar..."
                                        id="search-input"
                                        class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-transparent">
                                </div>
                                <button id="advanced-search-trigger" title="B√∫squeda Avanzada" class="ml-2 p-2 border border-gray-300 rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-pink-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3zm3.707 4.707A1 1 0 017 7h6a1 1 0 01.707.293l-2.828 2.828A1 1 0 0110 10.586v3.828l-1-1V10.586a1 1 0 01-.293-.707L6.707 7.707z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col"
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                T√≠tulo (Recurso)</th>
                                            <th scope="col"
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Autor Principal</th>
                                            <th scope="col"
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Asignaturas</th>
                                            <th scope="col"
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                A√±o-Semestre</th>
                                            <th scope="col"
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Etiquetas</th>
                                            <th scope="col" class="relative px-6 py-3">
                                                <span class="sr-only">Acciones</span>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="ovc-table-body" class="bg-white divide-y divide-gray-200">
                                    </tbody>
                                </table>
                            </div>
                            <div
                                class="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6 mt-4 rounded-b-lg">
                                <div class="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
                                    <div>
                                        <p class="text-sm text-gray-700">
                                            Mostrando <span id="pagination-start">0</span> a <span
                                                id="pagination-end">0</span> de <span id="pagination-total">0</span>
                                            resultados
                                        </p>
                                    </div>
                                    <div>
                                        <nav class="isolate inline-flex -space-x-px rounded-md shadow-sm"
                                            aria-label="Pagination">
                                            <a href="#"
                                                class="relative inline-flex items-center rounded-l-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0">
                                                <span>‚è™</span> </a>
                                            <a href="#"
                                                class="relative inline-flex items-center px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0">
                                                <span>‚¨ÖÔ∏è</span> </a>
                                            <a href="#"
                                                class="relative inline-flex items-center px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0">
                                                <span>‚û°Ô∏è</span> </a>
                                            <a href="#"
                                                class="relative inline-flex items-center rounded-r-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0">
                                                <span>‚è©</span> </a>
                                        </nav>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Secci√≥n para visualizar el rizoma eliminada para evitar duplicidad de IDs -->

                    <!-- Secci√≥n para el tablero Kanban -->
                    <div id="kanban-section" class="hidden space-y-6">
                        <!-- El contenido se cargar√° din√°micamente desde kanban.html mediante un iframe -->
                    </div>

                    <!-- Eliminado div duplicado con id="rizoma-section" que estaba aqu√≠ -->
                    <div id="crear-section" class="hidden space-y-8">
                        <!-- Eliminado: T√≠tulo duplicado -->

                        <form id="crear-ovc-form" class="space-y-10 bg-white p-8 rounded-lg shadow-lg">
                            <input type="hidden" id="edit-ovc-id" name="edit-ovc-id">
                            <div class="border-b border-gray-200 pb-6">
                                <h2 class="text-xl font-semibold text-gray-700 mb-4"><span>‚ÑπÔ∏è</span> Informaci√≥n B√°sica
                                </h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="ovc-imagen" class="block text-sm font-medium text-gray-700 mb-1">
                                            <span>üñºÔ∏è</span> Imagen de Portada </label>
                                        <input type="file" id="ovc-imagen" name="ovc-imagen" accept="image/*"
                                            class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-pink-50 file:text-pink-700 hover:file:bg-pink-100 custom-file-input">
                                        <div id="image-preview-container" class="image-preview">
                                            <span>Previsualizaci√≥n</span>
                                        </div>
                                        <span id="imagen-filename" class="text-xs text-gray-500 mt-1 block"></span>
                                        <input type="hidden" id="imagen-data-url">
                                    </div>
                                    <div class="space-y-4">
                                        <div>
                                            <label for="ovc-titulo"
                                                class="block text-sm font-medium text-gray-700"><span>üìÑ</span> T√≠tulo
                                                del OVC</label> <input type="text" id="ovc-titulo" name="ovc-titulo"
                                                required
                                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 sm:text-sm">
                                        </div>
                                        <div>
                                            <label for="ovc-descripcion"
                                                class="block text-sm font-medium text-gray-700"><span>üìÑ</span>
                                                Descripci√≥n</label> <textarea id="ovc-descripcion"
                                                name="ovc-descripcion" rows="4" required
                                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 sm:text-sm"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="border-b border-gray-200 pb-6">
                                <div class="flex justify-between items-center mb-3">
                                    <h2 class="text-xl font-semibold text-gray-700"><span>üë•</span> Autores</h2> <button
                                        type="button" id="add-autor"
                                        class="btn-add inline-flex items-center px-3 py-1.5 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                        <span>‚ûï</span> A√±adir Autor </button>
                                </div>
                                <div id="autores-container" class="space-y-4">
                                    <div
                                        class="autor-item grid grid-cols-1 sm:grid-cols-5 gap-4 items-end p-4 border rounded-md bg-gray-50">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-600"><span>üë§</span>
                                                Nombre</label> <input type="text" name="autor_nombre[]"
                                                placeholder="Nombre completo"
                                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 sm:text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-600"><span>üíº</span>
                                                Rol</label> <input type="text" name="autor_rol[]"
                                                placeholder="Ej: Investigador"
                                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 sm:text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-600"><span>@</span>
                                                E-mail</label> <input type="email" name="autor_email[]"
                                                placeholder="correo@ejemplo.com"
                                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 sm:text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-600"><span>%</span>
                                                Participaci√≥n (%)</label> <input type="number"
                                                name="autor_participacion[]" placeholder="Ej: 50" min="0" max="100"
                                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 sm:text-sm">
                                        </div>
                                        <button type="button"
                                            class="btn-remove remove-item self-end inline-flex justify-center items-center px-3 py-1.5 border border-red-300 text-sm font-medium rounded-md shadow-sm text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                            <span>üóëÔ∏è</span> </button>
                                    </div>
                                </div>
                            </div>
                            <div class="border-b border-gray-200 pb-6 grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <h3 class="text-lg font-medium text-gray-700"><span>üè∑Ô∏è</span> Etiquetas</h3>
                                        <button type="button" id="add-etiqueta"
                                            class="btn-add inline-flex items-center px-2 py-1 border border-transparent text-xs font-medium rounded shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                            <span>‚ûï</span> A√±adir </button>
                                    </div>
                                    <div id="etiquetas-container" class="space-y-2">
                                        <div class="etiqueta-item flex items-center gap-2">
                                            <input type="text" name="etiquetas[]" placeholder="Ej: Realidad Aumentada"
                                                class="block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 sm:text-sm">
                                            <button type="button"
                                                class="btn-remove remove-item inline-flex justify-center items-center p-1 border border-red-300 text-xs font-medium rounded text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                                <span>üóëÔ∏è</span> </button>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h3 class="text-lg font-medium text-gray-700 mb-2"><span>‚òëÔ∏è</span> Asignaturas</h3>
                                    <div class="space-y-2">
                                        <div class="flex items-center">
                                            <input id="asig-lab" name="asignaturas[]" type="checkbox"
                                                value="Laboratorio de convergencia"
                                                class="h-4 w-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                                            <label for="asig-lab" class="ml-2 block text-sm text-gray-900">Laboratorio
                                                de convergencia</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input id="asig-cod" name="asignaturas[]" type="checkbox"
                                                value="C√≥digos y lenguajes"
                                                class="h-4 w-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                                            <label for="asig-cod" class="ml-2 block text-sm text-gray-900">C√≥digos y
                                                lenguajes</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input id="asig-hist" name="asignaturas[]" type="checkbox"
                                                value="Historia de las artes electr√≥nicas"
                                                class="h-4 w-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                                            <label for="asig-hist" class="ml-2 block text-sm text-gray-900">Historia de
                                                las artes electr√≥nicas</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input id="asig-mod" name="asignaturas[]" type="checkbox"
                                                value="Modelado 3D"
                                                class="h-4 w-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                                            <label for="asig-mod" class="ml-2 block text-sm text-gray-900">Modelado
                                                3D</label>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label for="ovc-semestre"
                                        class="block text-sm font-medium text-gray-700 mb-1"><span>üìÖ</span>
                                        A√±o-Semestre</label> <select id="ovc-semestre" name="ovc-semestre"
                                        class="mt-1 block w-full rounded-md border-gray-300 py-2 pl-3 pr-10 text-base focus:border-pink-500 focus:outline-none focus:ring-pink-500 sm:text-sm">
                                        <option>2025-2</option>
                                        <option selected>2025-1</option>
                                        <option>2024-2</option>
                                        <option>2024-1</option>
                                        <option>2023-2</option>
                                        <option>2023-1</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="ovc-licencia"
                                        class="block text-sm font-medium text-gray-700 mb-1"><span>¬©Ô∏è</span> Tipo de
                                        Licenciamiento</label> <select id="ovc-licencia" name="ovc-licencia"
                                        class="mt-1 block w-full rounded-md border-gray-300 py-2 pl-3 pr-10 text-base focus:border-pink-500 focus:outline-none focus:ring-pink-500 sm:text-sm">
                                        <option selected value="CC BY">Creative Commons Atribuci√≥n (CC BY)</option>
                                        <option value="CC BY-SA">Creative Commons Atribuci√≥n-CompartirIgual (CC BY-SA)
                                        </option>
                                        <option value="CC BY-NC">Creative Commons Atribuci√≥n-NoComercial (CC BY-NC)
                                        </option>
                                        <option value="CC BY-ND">Creative Commons Atribuci√≥n-SinDerivadas (CC BY-ND)
                                        </option>
                                        <option value="CC BY-NC-SA">Creative Commons
                                            Atribuci√≥n-NoComercial-CompartirIgual (CC BY-NC-SA)</option>
                                        <option value="CC BY-NC-ND">Creative Commons Atribuci√≥n-NoComercial-SinDerivadas
                                            (CC BY-NC-ND)</option>
                                        <option value="CC0">Creative Commons Dominio P√∫blico (CC0)</option>
                                        <option value="Proprietary">Propietario / Todos los derechos reservados</option>
                                    </select>
                                </div>
                            </div>
                            <div class="border-b border-gray-200 pb-6">
                                <div class="flex justify-between items-center mb-3">
                                    <h2 class="text-xl font-semibold text-gray-700"><span>üîó</span> Enlaces Externos
                                    </h2> <button type="button" id="add-enlace"
                                        class="btn-add inline-flex items-center px-3 py-1.5 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                        <span>‚ûï</span> A√±adir Enlace </button>
                                </div>
                                <div id="enlaces-container" class="space-y-4">
                                    <div
                                        class="enlace-item grid grid-cols-1 sm:grid-cols-3 gap-4 items-end p-4 border rounded-md bg-gray-50">
                                        <div class="sm:col-span-1">
                                            <label class="block text-xs font-medium text-gray-600"><span>‚ÑπÔ∏è</span>
                                                Descripci√≥n</label> <input type="text" name="enlace_desc[]"
                                                placeholder="Ej: Repositorio GitHub"
                                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 sm:text-sm">
                                        </div>
                                        <div class="sm:col-span-1">
                                            <label class="block text-xs font-medium text-gray-600"><span>üîó</span>
                                                URL</label> <input type="url" name="enlace_url[]"
                                                placeholder="https://ejemplo.com"
                                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 sm:text-sm">
                                        </div>
                                        <button type="button"
                                            class="btn-remove remove-item self-end inline-flex justify-center items-center px-3 py-1.5 border border-red-300 text-sm font-medium rounded-md shadow-sm text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                            <span>üóëÔ∏è</span> </button>
                                    </div>
                                </div>
                            </div>
                            <div class="border-b border-gray-200 pb-6">
                                <h2 class="text-xl font-semibold text-gray-700 mb-4"><span>üìé</span> Archivo Principal
                                </h2>
                                <div>
                                    <label for="ovc-archivo"
                                        class="block text-sm font-medium text-gray-700 mb-1"><span>‚òÅÔ∏è</span> Subir
                                        archivo del OVC</label> <input type="file" id="ovc-archivo" name="ovc-archivo"
                                        class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-pink-50 file:text-pink-700 hover:file:bg-pink-100 custom-file-input">
                                    <span id="archivo-filename" class="text-xs text-gray-500 mt-1 block"></span>
                                </div>
                            </div>
                            <div class="border-b border-gray-200 pb-6">
                                <div class="flex justify-between items-center mb-3">
                                    <h2 class="text-xl font-semibold text-gray-700"><span>‚ÜîÔ∏è</span> Relaciones con otros
                                        OVC</h2> <button type="button" id="add-relacion"
                                        class="btn-add inline-flex items-center px-3 py-1.5 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                        <span>‚ûï</span> A√±adir Relaci√≥n </button>
                                </div>
                                <div id="relaciones-container" class="space-y-4">
                                    <div
                                        class="relacion-item grid grid-cols-1 sm:grid-cols-4 gap-4 items-end p-4 border rounded-md bg-gray-50">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-600"><span>üîó</span> OVC
                                                Relacionado</label> <input type="text" name="relacion_ovc[]"
                                                placeholder="Buscar o seleccionar OVC..."
                                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 sm:text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-600"><span>üè∑Ô∏è</span>
                                                Etiqueta de Relaci√≥n</label> <input type="text"
                                                name="relacion_etiqueta[]" placeholder="Ej: Se basa en, Contin√∫a"
                                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 sm:text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-600"><span>‚ÜîÔ∏è</span>
                                                Direcci√≥n</label> <select name="relacion_direccion[]"
                                                class="mt-1 block w-full rounded-md border-gray-300 py-2 pl-3 pr-10 text-base focus:border-pink-500 focus:outline-none focus:ring-pink-500 sm:text-sm">
                                                <option value="saliente">Saliente (Este OVC -> Otro)</option>
                                                <option value="entrante">Entrante (Otro OVC -> Este)</option>
                                                <option value="bidireccional">Bidireccional</option>
                                            </select>
                                        </div>
                                        <button type="button"
                                            class="btn-remove remove-item self-end inline-flex justify-center items-center px-3 py-1.5 border border-red-300 text-sm font-medium rounded-md shadow-sm text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                            <span>üóëÔ∏è</span> </button>
                                    </div>
                                </div>
                            </div>

                            <div class="flex justify-end pt-6">
                                <button type="submit" id="form-submit-button"
                                    class="inline-flex items-center justify-center py-2 px-6 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-pink-600 hover:bg-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500">
                                    <span class="mr-2">üíæ</span><span id="form-submit-button-text">Guardar OVC</span>
                                </button>
                            </div>
                        </form>
                    </div>


                    <div id="rizoma-section" class="hidden flex flex-col flex-1 min-h-0 h-full"> 

                        <div class="flex justify-end mb-4">

                            <div class="flex items-center space-x-4">
                                <button id="rizoma-create-ovc-btn" onclick="window.showSection('crear')"
                                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-pink-600 hover:bg-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500">
                                    <span class="mr-2">‚ûï</span> Crear OVC
                                </button>
                                <div class="relative">
                                    <span class="search-icon">üîç</span>
                                    <input type="text" placeholder="Buscar..." id="rizoma-search-input"
                                        class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-transparent">
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-lg shadow flex-1 flex flex-col text-gray-500 min-h-0 h-full p-4">

                            <div class="flex-1 min-h-0">
                                <svg id="rizoma-graph" class="w-full h-full border border-gray-200 rounded"></svg>
                            </div>
                        </div>
                    </div>

                    <!-- Placeholder for Kanban Board eliminado para evitar duplicidad de IDs -->

                </div>

        </div>


        </main>

    </div>

    </div>

    <div id="confirmation-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden"
        aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div id="modal-overlay" class="absolute inset-0 bg-gray-600 bg-opacity-75 modal-overlay"></div>
        <div class="modal-content bg-white rounded-lg shadow-xl overflow-hidden transform sm:max-w-md sm:w-full mx-4">
            <div class="px-6 py-4">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title"><span>‚úÖ</span> Confirmaci√≥n
                    </h3> <button id="modal-close-button-x" type="button"
                        class="text-gray-400 hover:text-gray-600 text-2xl">
                        <span>‚ùå</span> </button>
                </div>
                <div class="mt-4 text-center">
                    <span class="text-5xl mb-3 inline-block">‚úÖ</span>
                    <p class="text-lg text-gray-700" id="confirmation-modal-text">
                        ¬°El OVC se ha guardado correctamente!
                    </p>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-3 text-right">
                <button id="modal-close-button-ok" type="button"
                    class="inline-flex items-center justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-pink-600 text-base font-medium text-white hover:bg-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500 sm:text-sm">
                    Aceptar
                </button>
            </div>
        </div>
    </div>

    <div id="delete-confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden"
        aria-labelledby="delete-modal-title" role="dialog" aria-modal="true">
        <div id="delete-modal-overlay" class="absolute inset-0 bg-gray-800 bg-opacity-60 modal-overlay"></div>
        <div class="modal-content bg-white rounded-lg shadow-xl overflow-hidden transform sm:max-w-lg sm:w-full mx-4">
            <div class="px-6 py-5">
                <div class="flex items-start">
                    <div
                        class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                        <span class="text-red-600 text-xl">‚ö†Ô∏è</span>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="delete-modal-title">
                            Confirmar Eliminaci√≥n
                        </h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-600">
                                ¬øEst√°s seguro de que quieres eliminar este OVC? Esta acci√≥n no se puede deshacer.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-100 px-6 py-4 sm:flex sm:flex-row-reverse">
                <button id="delete-confirm-button" type="button"
                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Eliminar
                </button>
                <button id="delete-cancel-button" type="button"
                    class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <div id="ovc-summary-modal"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden transition-opacity duration-300"
        aria-labelledby="ovc-summary-modal-title" role="dialog" aria-modal="true">
        <div id="ovc-summary-modal-overlay" class="absolute inset-0 bg-gray-600 bg-opacity-75"></div>
        <div class="modal-content bg-white rounded-lg shadow-xl overflow-hidden transform sm:max-w-lg sm:w-full mx-4">
            <div class="px-6 py-4">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="ovc-summary-modal-title"><span></span>
                    </h3>
                    <button id="ovc-summary-modal-close" type="button"
                        class="text-gray-400 hover:text-gray-600 text-2xl">
                    </button>
                </div>
                <div class="mt-4">
                    <div id="ovc-summary-modal-content" class="flex flex-col space-y-4 items-start">
                        <!-- Aqu√≠ se llenar√° el contenido din√°micamente -->
                        <div class="flex-1">
                            <h4 class="text-md font-semibold text-gray-700">Detalles</h4>
                            <p class="text-sm text-gray-600">Aqu√≠ se mostrar√°n los detalles principales del OVC.</p>
                        </div>
                        <div class="flex-1">
                            <h4 class="text-md font-semibold text-gray-700">Autores</h4>
                            <ul class="list-disc list-inside text-sm text-gray-600">
                                <li>Autor 1</li>
                                <li>Autor 2</li>
                            </ul>
                        </div>
                        <div class="flex-1">
                            <h4 class="text-md font-semibold text-gray-700">Etiquetas</h4>
                            <span
                                class="inline-block bg-gray-200 text-gray-700 text-xs font-medium px-2 py-1 rounded">Etiqueta
                                1</span>
                            <span
                                class="inline-block bg-gray-200 text-gray-700 text-xs font-medium px-2 py-1 rounded">Etiqueta
                                2</span>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-6 py-3 text-right">
                    <button id="ovc-summary-modal-ok" type="button"
                        class="inline-flex items-center justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-pink-600 text-base font-medium text-white hover:bg-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500 sm:text-sm">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Search Modal -->
    <div id="advanced-search-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden" aria-labelledby="advanced-search-modal-title" role="dialog" aria-modal="true">
        <div id="advanced-search-modal-overlay" class="absolute inset-0 bg-gray-800 bg-opacity-60 modal-overlay"></div>
        <div class="modal-content bg-white rounded-lg shadow-xl overflow-hidden transform sm:max-w-lg sm:w-full mx-4">
            <div class="px-6 py-4">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="advanced-search-modal-title">
                        <span>‚öôÔ∏è</span> B√∫squeda Avanzada
                    </h3>
                    <button id="advanced-search-modal-close-x" type="button" class="text-gray-400 hover:text-gray-600 text-2xl">
                        <span>‚ùå</span>
                    </button>
                </div>
                <div class="mt-4 space-y-4">
                    <!-- Campo para B√∫squeda Descriptiva (IA) -->
                    <div>
                        <label for="ai-search-prompt" class="block text-sm font-medium text-gray-700">B√∫squeda Descriptiva (IA)</label>
                        <textarea id="ai-search-prompt" name="ai-search-prompt" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 sm:text-sm" placeholder="Describa qu√© OVC busca..."></textarea>
                    </div>

                    <!-- Filtros por Campos Espec√≠ficos -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Filtrar por Campos:</label>
                        <div class="mt-2 space-y-2">
                            <div class="flex items-center">
                                <input id="filter-titulo" name="filter-fields" type="checkbox" value="titulo" class="h-4 w-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                                <label for="filter-titulo" class="ml-2 block text-sm text-gray-900">T√≠tulo</label>
                            </div>
                            <div class="flex items-center">
                                <input id="filter-descripcion" name="filter-fields" type="checkbox" value="descripcion" class="h-4 w-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                                <label for="filter-descripcion" class="ml-2 block text-sm text-gray-900">Descripci√≥n</label>
                            </div>
                            <div class="flex items-center">
                                <input id="filter-palabras-clave" name="filter-fields" type="checkbox" value="palabrasClave" class="h-4 w-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                                <label for="filter-palabras-clave" class="ml-2 block text-sm text-gray-900">Palabras Clave</label>
                            </div>
                        </div>
                    </div>

                    <!-- Checkbox para Fuzzy Search -->
                    <div class="flex items-center">
                        <input id="fuzzy-search-checkbox" name="fuzzy-search" type="checkbox" class="h-4 w-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                        <label for="fuzzy-search-checkbox" class="ml-2 block text-sm text-gray-900">Incluir resultados aproximados (Fuzzy Search)</label>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-3 sm:flex sm:flex-row-reverse">
                <button id="apply-advanced-search-button" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-pink-600 text-base font-medium text-white hover:bg-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Aplicar B√∫squeda Avanzada
                </button>
                <button id="advanced-search-modal-close-cancel" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const summaryModal = document.getElementById('ovc-summary-modal');
            const summaryModalOverlay = document.getElementById('ovc-summary-modal-overlay');
            const summaryModalClose = document.getElementById('ovc-summary-modal-close');
            const summaryModalOk = document.getElementById('ovc-summary-modal-ok');
            const summaryModalContent = document.getElementById('ovc-summary-modal-content');





            // Listeners para cerrar el modal
            summaryModalOverlay.addEventListener('click', hideSummaryModal);
            summaryModalClose.addEventListener('click', hideSummaryModal);
            summaryModalOk.addEventListener('click', hideSummaryModal);

            // Listener para el bot√≥n "Ver"
            const ovcTableBody = document.getElementById('ovc-table-body');
            if (ovcTableBody) {
                ovcTableBody.addEventListener('click', function (event) {
                    const viewButton = event.target.closest('.view-ovc-btn');
                    if (viewButton) {
                        event.preventDefault();
                        const ovcId = viewButton.getAttribute('data-id');
                        showSummaryModal(ovcId);
                    }
                });
            }
        });
        document.addEventListener('DOMContentLoaded', function () {
            // --- Selecci√≥n de Elementos ---
            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            const contentArea = document.getElementById('content-area');
            const sectionTitle = document.getElementById('section-title');
            const ovcTableBody = document.getElementById('ovc-table-body');
            const goToCreateBtn = document.getElementById('go-to-create-btn');
            const crearOvcForm = document.getElementById('crear-ovc-form');
            const formSubmitButton = document.getElementById('form-submit-button');
            const formSubmitButtonText = document.getElementById('form-submit-button-text');
            const editOvcIdInput = document.getElementById('edit-ovc-id');
            const imagenInput = document.getElementById('ovc-imagen');
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const imagenFilenameSpan = document.getElementById('imagen-filename');
            const imagenDataUrlInput = document.getElementById('imagen-data-url'); // Input oculto para DataURL
            const archivoInput = document.getElementById('ovc-archivo');
            const archivoFilenameSpan = document.getElementById('archivo-filename');
            const confirmationModal = document.getElementById('confirmation-modal');
            const confirmationModalText = document.getElementById('confirmation-modal-text');
            const modalOverlay = document.getElementById('modal-overlay');
            const modalCloseButtonX = document.getElementById('modal-close-button-x');
            const modalCloseButtonOk = document.getElementById('modal-close-button-ok');
            const deleteConfirmModal = document.getElementById('delete-confirm-modal');
            const deleteModalOverlay = document.getElementById('delete-modal-overlay');
            const deleteConfirmButton = document.getElementById('delete-confirm-button');
            const deleteCancelButton = document.getElementById('delete-cancel-button');
        
            // Elementos para B√∫squeda Avanzada
            const searchInput = document.getElementById('search-input'); // Ya existe, pero lo referenciamos aqu√≠
            const advancedSearchTriggerBtn = document.getElementById('advanced-search-trigger');
            const advancedSearchModal = document.getElementById('advanced-search-modal');
            const advancedSearchModalOverlay = document.getElementById('advanced-search-modal-overlay');
            const advancedSearchModalCloseXBtn = document.getElementById('advanced-search-modal-close-x');
            const advancedSearchModalCloseCancelBtn = document.getElementById('advanced-search-modal-close-cancel');
            const applyAdvancedSearchBtn = document.getElementById('apply-advanced-search-button');
            const aiSearchPromptInput = document.getElementById('ai-search-prompt');
            const fuzzySearchCheckbox = document.getElementById('fuzzy-search-checkbox');
            const filterFieldCheckboxes = document.querySelectorAll('#advanced-search-modal input[name="filter-fields"]');
        
        
            const sections = {
                crear: document.getElementById('crear-section'),
                listar: document.getElementById('listar-section'),
                rizoma: document.getElementById('rizoma-section'),
                kanban: document.getElementById('kanban-section') // Added Kanban section
                // Rubric sections are handled differently (iframe)
            };
            const sectionTitles = {
                crear: '<span>‚ûï</span> Crear Nuevo Objeto Virtual Creativo',
                listar: '<span>üìã</span> Mis objetos virtuales creativos',
                rizoma: '<span>üå±</span> Visualizaci√≥n del Rizoma',
                kanban: '<span>üìã</span> Tablero Kanban', // Added Kanban title
                // Titles for rubric pages will be set dynamically
            };
            // OVC_STORAGE_KEY se define en ovcStorage.js
            const GOOGLE_API_KEY = 'AIzaSyA5rWKqgBArqtg5aZiQiQFMRpZWcOsHwT0'; // TODO: Replace if needed & secure for production
            const AI_MODEL_NAME = 'gemini-1.5-flash-latest';
            const DEFAULT_SEARCH_FIELDS = [
                'titulo',
                'descripcion',
                'etiquetas',
                'autores.nombre',
                'autores.rol',
                'asignaturas',
                'semestre',
                'licencia',
                'enlaces.descripcion',
                'archivo', // Contiene el nombre del archivo
                'relaciones.ovc',
                'relaciones.etiqueta'
            ];

            // --- Estado de Edici√≥n ---
            // Las variables isEditMode, currentEditOvcId y ovcIdToDeleteConfirm se han movido a js/ovcForm.js

            // --- Navegaci√≥n --- (La funci√≥n showSection se movi√≥ a js/navigation.js)
            sidebarLinks.forEach(link => {
                link.addEventListener('click', function (event) {
                    const sectionId = this.getAttribute('data-section');
                    const isSubmenuLink = this.classList.contains('submenu-link');
                    const targetUrl = this.getAttribute('href');

                    if (sectionId) {
                        // Handle regular section toggle
                        event.preventDefault();
                        window.showSection(sectionId);
                        // Ensure submenu is closed if a main section is clicked
                        if (!this.closest('.submenu') && rubricasSubmenu.classList.contains('open')) {
                            rubricasToggle.click(); // Simulate click to close
                        }
                    } else if (isSubmenuLink && targetUrl && targetUrl !== '#') {
                        // Handle rubric submenu link click (load in iframe)
                        event.preventDefault();
                        loadPageInContentArea(targetUrl, this);
                    }
                    // Allow default behavior for other links (like the main Rubricas toggle)
                });
            });
            if (goToCreateBtn) { /* ... */
                goToCreateBtn.addEventListener('click', () => {
                    window.resetFormToCreateMode();
                    window.showSection('crear');
                });
            }

            // --- LocalStorage y Renderizado Tabla ---




            // --- Funcionalidad Formulario Crear/Editar OVC ---

            // Previsualizaci√≥n de Imagen (con Base64)
            if (imagenInput && imagePreviewContainer && imagenFilenameSpan && imagenDataUrlInput) {
                imagenInput.addEventListener('change', function (event) {
                    console.log("DEBUG: Evento 'change' detectado en input de imagen.");
                    const file = event.target.files[0];
                    imagenDataUrlInput.value = ''; // Limpiar DataURL anterior
                    imagenFilenameSpan.dataset.originalName = ''; // Limpiar nombre anterior

                    if (file && file.type.startsWith('image/')) {
                        imagenFilenameSpan.textContent = `Procesando: ${file.name}...`; // Mensaje mientras carga
                        imagePreviewContainer.innerHTML = '<span>Cargando...</span>';
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            const dataUrl = e.target.result;
                            console.log("DEBUG: FileReader carg√≥ la imagen como DataURL (tama√±o aprox:", Math.round(dataUrl.length / 1024), "KB)");
                            if (dataUrl.length > 5 * 1024 * 1024) { // Advertencia si > 5MB (aproximado)
                                console.warn("ADVERTENCIA: La imagen es muy grande, podr√≠a llenar localStorage.");
                                alert("Advertencia: La imagen seleccionada es muy grande y podr√≠a causar problemas de almacenamiento.");
                            }
                            imagePreviewContainer.innerHTML = `<img src="${dataUrl}" alt="Previsualizaci√≥n">`;
                            imagenDataUrlInput.value = dataUrl; // Guardar DataURL temporalmente
                            imagenFilenameSpan.dataset.originalName = file.name; // Guardar nombre original
                            imagenFilenameSpan.textContent = `Nuevo archivo: ${file.name}`; // Actualizar span
                        }
                        reader.onerror = function (e) { /* ... error handling ... */
                            console.error("DEBUG: Error de FileReader:", e);
                            imagenFilenameSpan.textContent = 'Error al leer archivo';
                            imagePreviewContainer.innerHTML = '<span>Error</span>';
                        }
                        reader.readAsDataURL(file);
                    } else if (file) { /* ... archivo no imagen ... */
                        console.warn("DEBUG: Tipo de archivo no soportado:", file.type);
                        imagenFilenameSpan.textContent = `Archivo ${file.name} no es una imagen.`;
                        imagePreviewContainer.innerHTML = '<span>No es imagen</span>';
                        imagenInput.value = '';
                    } else { /* ... no se seleccion√≥ archivo ... */
                        console.log("DEBUG: No se seleccion√≥ archivo.");
                        imagenFilenameSpan.textContent = isEditMode ? imagenFilenameSpan.textContent : '';
                        imagePreviewContainer.innerHTML = isEditMode ? imagePreviewContainer.innerHTML : '<span>Previsualizaci√≥n</span>';
                    }
                });
            } else { console.warn("DEBUG: Faltan elementos para previsualizaci√≥n."); }

            // Nombre archivo principal (sin cambios)
            if (archivoInput && archivoFilenameSpan) { /* ... */
                archivoInput.addEventListener('change', function (event) {
                    const file = event.target.files[0];
                    if (file) { archivoFilenameSpan.textContent = `Archivo seleccionado: ${file.name}`; }
                    else { if (!isEditMode) { archivoFilenameSpan.textContent = ''; } }
                });
            }

            // Listas din√°micas (funciones movidas a js/utils.js)
            // setupDynamicList('autores-container', 'add-autor', '.autor-item');
            // setupDynamicList('etiquetas-container', 'add-etiqueta', '.etiqueta-item');
            // setupDynamicList('enlaces-container', 'add-enlace', '.enlace-item');
            // setupDynamicList('relaciones-container', 'add-relacion', '.relacion-item');
            setupDynamicList('autores-container', 'add-autor', '.autor-item');
            setupDynamicList('etiquetas-container', 'add-etiqueta', '.etiqueta-item');
            setupDynamicList('enlaces-container', 'add-enlace', '.enlace-item');
            setupDynamicList('relaciones-container', 'add-relacion', '.relacion-item');

            // --- L√≥gica de Edici√≥n ---
            // La funci√≥n populateFormForEdit se ha movido a js/ovcForm.js

            <!-- Helper para poblar listas din√°micas (funci√≥n movida a js/utils.js) -->

            // La funci√≥n resetFormToCreateMode se ha movido a js/ovcForm.js


            // --- Guardado (Crear y Actualizar) y Modal Confirmaci√≥n ---
            // Las funciones showConfirmationModal y hideConfirmationModal se han movido a js/ovcForm.js

            // Submit del formulario (Maneja Crear y Actualizar con Base64)
            if (crearOvcForm) {
                crearOvcForm.addEventListener('submit', function (event) {
                    event.preventDefault();
                    const isEditMode = window.getIsEditMode();
                    const currentEditOvcId = window.getCurrentEditOvcId();
                    console.log(`DEBUG: Formulario enviado. Modo Edici√≥n: ${isEditMode}`);

                    const ovcs = window.getOvcsFromStorage();
                    let originalOvc = null;
                    if (isEditMode && currentEditOvcId) {
                        originalOvc = ovcs.find(ovc => ovc.id === Number(currentEditOvcId));
                    }

                    // --- Recolectar Imagen (Base64) ---
                    let imagenData = null;
                    const newDataUrl = imagenDataUrlInput.value; // Obtener DataURL del input oculto
                    const newFilename = imagenFilenameSpan.dataset.originalName; // Obtener nombre original del data attribute

                    if (newDataUrl && newFilename) {
                        imagenData = { dataUrl: newDataUrl, filename: newFilename };
                        console.log("DEBUG: Usando nueva imagen Base64.");
                    } else if (isEditMode && originalOvc && originalOvc.imagen) {
                        imagenData = originalOvc.imagen;
                        console.log("DEBUG: Conservando imagen Base64 original.");
                    } else {
                        console.log("DEBUG: No hay imagen nueva ni original.");
                    }

                    // 1. Recolectar datos
                    const formData = {
                        id: isEditMode ? Number(currentEditOvcId) : Date.now(),
                        titulo: document.getElementById('ovc-titulo')?.value || '',
                        descripcion: document.getElementById('ovc-descripcion')?.value || '',
                        imagen: imagenData, // Guardar objeto {dataUrl, filename} o null
                        autores: [],
                        etiquetas: [],
                        asignaturas: [],
                        semestre: document.getElementById('ovc-semestre')?.value || '',
                        licencia: document.getElementById('ovc-licencia')?.value || '',
                        enlaces: [],
                        archivo: archivoInput.files.length > 0 ? `Archivo seleccionado: ${archivoInput.files[0].name}` : (originalOvc ? originalOvc.archivo : ''),
                        relaciones: [],
                        fechaCreacion: isEditMode && originalOvc ? originalOvc.fechaCreacion : new Date().toISOString()
                    };
                    // ... (recolecci√≥n de autores, etiquetas, etc. - sin cambios) ...
                    document.querySelectorAll('#autores-container .autor-item').forEach(item => { /* ... */
                        const nombre = item.querySelector('input[name="autor_nombre[]"]')?.value || '';
                        if (nombre.trim() !== '') {
                            formData.autores.push({
                                nombre: nombre,
                                rol: item.querySelector('input[name="autor_rol[]"]')?.value || '',
                                email: item.querySelector('input[name="autor_email[]"]')?.value || '',
                                participacion: item.querySelector('input[name="autor_participacion[]"]')?.value || ''
                            });
                        }
                    });
                    document.querySelectorAll('#etiquetas-container .etiqueta-item input').forEach(input => { /* ... */
                        if (input.value.trim()) formData.etiquetas.push(input.value.trim());
                    });
                    document.querySelectorAll('input[name="asignaturas[]"]:checked').forEach(checkbox => { /* ... */
                        formData.asignaturas.push(checkbox.value);
                    });
                    document.querySelectorAll('#enlaces-container .enlace-item').forEach(item => { /* ... */
                        const desc = item.querySelector('input[name="enlace_desc[]"]')?.value || '';
                        const url = item.querySelector('input[name="enlace_url[]"]')?.value || '';
                        if (desc.trim() && url.trim()) { formData.enlaces.push({ descripcion: desc, url: url }); }
                    });
                    document.querySelectorAll('#relaciones-container .relacion-item').forEach(item => { /* ... */
                        const ovcRel = item.querySelector('input[name="relacion_ovc[]"]')?.value || '';
                        const etiquetaRel = item.querySelector('input[name="relacion_etiqueta[]"]')?.value || '';
                        const direccionRel = item.querySelector('select[name="relacion_direccion[]"]')?.value || '';
                        if (ovcRel.trim() && etiquetaRel.trim()) { formData.relaciones.push({ ovc: ovcRel, etiqueta: etiquetaRel, direccion: direccionRel }); }
                    });

                    console.log("DEBUG: Datos recolectados finales:", formData);

                    // 2. Guardar o Actualizar en localStorage
                    if (isEditMode) {
                        const index = ovcs.findIndex(ovc => ovc.id === formData.id);
                        if (index !== -1) {
                            console.log(`DEBUG: Actualizando OVC en √≠ndice ${index}`);
                            ovcs[index] = formData;
                            window.saveOvcsToStorage(ovcs);
                            window.showConfirmationModal(true);
                            window.resetFormToCreateMode();
                            window.showSection('listar');
                        } else { /* ... error handling ... */
                            console.error(`Error: No se encontr√≥ OVC con ID ${formData.id} para actualizar.`);
                            alert("Error al actualizar el OVC. No se encontr√≥ el original.");
                            window.resetFormToCreateMode();
                        }
                    } else {
                        console.log("DEBUG: Creando nuevo OVC.");
                        ovcs.push(formData);
                        window.saveOvcsToStorage(ovcs);
                        window.showConfirmationModal(false);
                        window.resetFormToCreateMode();
                    }
                });
            }

            // Cerrar modal de confirmaci√≥n
            if (modalOverlay) modalOverlay.addEventListener('click', window.hideConfirmationModal);
            if (modalCloseButtonX) modalCloseButtonX.addEventListener('click', window.hideConfirmationModal);
            if (modalCloseButtonOk) modalCloseButtonOk.addEventListener('click', window.hideConfirmationModal);

            // --- Funcionalidad de Borrado (con Modal) ---
            // Las funciones showDeleteConfirmModal y hideDeleteConfirmModal se han movido a js/ovcForm.js

            // Listener para botones dentro del modal de borrado
            if (deleteCancelButton) deleteCancelButton.addEventListener('click', window.hideDeleteConfirmModal);
            if (deleteModalOverlay) deleteModalOverlay.addEventListener('click', window.hideDeleteConfirmModal);

            if (deleteConfirmButton) { /* ... c√≥digo sin cambios ... */
                deleteConfirmButton.addEventListener('click', () => {
                    const ovcIdToDeleteConfirm = window.getOvcIdToDeleteConfirm();
                    if (ovcIdToDeleteConfirm) {
                        console.log(`DEBUG: Confirmado borrado para ID: ${ovcIdToDeleteConfirm}`);
                        const ovcs = window.getOvcsFromStorage();
                        const updatedOvcs = ovcs.filter(ovc => ovc.id !== Number(ovcIdToDeleteConfirm));
                        if (ovcs.length === updatedOvcs.length) {
                            console.warn(`DEBUG: No se encontr√≥ OVC con ID ${ovcIdToDeleteConfirm} para borrar.`);
                        } else {
                            window.saveOvcsToStorage(updatedOvcs);
                            console.log("DEBUG: OVC eliminado. Renderizando tabla de nuevo...");
                            window.renderOvcTable();
                        }
                    } else { console.error("Error: No se encontr√≥ ID para borrar al confirmar."); }
                    window.hideDeleteConfirmModal();
                });
            }

            // Listener para clics en la tabla (Editar y Borrar)
            if (ovcTableBody) { /* ... c√≥digo sin cambios ... */
                ovcTableBody.addEventListener('click', function (event) {
                    const editButton = event.target.closest('.edit-ovc-btn');
                    const deleteButton = event.target.closest('.delete-ovc-btn');
                    const kanbanButton = event.target.closest('.kanban-ovc-btn'); // Added Kanban button selector

                    if (editButton) {
                        event.preventDefault();
                        const ovcIdToEdit = editButton.getAttribute('data-id');
                        console.log(`DEBUG: Clic en Editar para ID: ${ovcIdToEdit}`);
                        if (ovcIdToEdit) {
                            window.populateFormForEdit(ovcIdToEdit);
                            window.showSection('crear');
                        }
                    } else if (deleteButton) {
                        event.preventDefault();
                        const ovcIdToDelete = deleteButton.getAttribute('data-id');
                        console.log(`DEBUG: Clic en Borrar para ID: ${ovcIdToDelete}`);
                        if (ovcIdToDelete) {
                            window.showDeleteConfirmModal(ovcIdToDelete);
                        }
                    } else if (kanbanButton) { // Handle Kanban button click
                        event.preventDefault();
                        const ovcIdForKanban = kanbanButton.getAttribute('data-id');
                        const ovcTitleForKanban = kanbanButton.getAttribute('data-title');
                        console.log(`DEBUG: Clic en Kanban para ID: ${ovcIdForKanban}, T√≠tulo: ${ovcTitleForKanban}`);
                        if (ovcIdForKanban && ovcTitleForKanban) {
                            // Call showSection with Kanban context
                            window.showSection('kanban', ovcIdForKanban, ovcTitleForKanban);
                        } else {
                            console.error("Error: Missing data-id or data-title on Kanban button.");
                        }
                    }
                });
            } else { console.error("Error: Elemento #ovc-table-body no encontrado."); }


            // --- Inicializaci√≥n ---
            let loadedFromUrlParams = false; // Flag to track if content was loaded based on URL
            const urlParams = new URLSearchParams(window.location.search);
            const initialTab = urlParams.get('initialTab');
            const editIndex = urlParams.get('editIndex');

            // Check specifically for the designer tab parameter
            if (initialTab === 'designer') {
                const designerLink = document.querySelector('a.sidebar-link[href="disenar_rubrica.html"]');
                if (designerLink) {
                    let targetUrl = 'disenar_rubrica.html';
                    if (editIndex !== null && !isNaN(parseInt(editIndex))) {
                        targetUrl += `?editIndex=${encodeURIComponent(editIndex)}`;
                        console.log(`DEBUG: URL Params indicate loading designer with editIndex: ${editIndex}`);
                    } else {
                        console.log("DEBUG: URL Params indicate loading designer (no editIndex).");
                    }
                    // Load the iframe content
                    loadPageInContentArea(targetUrl, designerLink);
                    loadedFromUrlParams = true; // Mark that we loaded based on params
                } else {
                    console.warn("DEBUG: initialTab=designer specified, but designer link not found.");
                }
            }
            // Add more 'else if' blocks here for other potential initialTab values if needed

            // If no specific URL parameters were handled, load the default section
            if (!loadedFromUrlParams) {
                console.log("DEBUG: No relevant URL parameters found or processed, loading default section.");
                const initialActiveLink = document.querySelector('.sidebar-link.active[data-section]'); // Find active section link
                if (initialActiveLink) {
                    window.showSection(initialActiveLink.getAttribute('data-section'));
                } else {
                    window.showSection('listar'); // Fallback to 'listar' if no active link found
                }
            }

            // Always clear URL parameters after initial load to prevent re-triggering on refresh
            if (window.history.replaceState) {
                const cleanUrl = window.location.pathname; // Get path without query string
                window.history.replaceState({ path: cleanUrl }, '', cleanUrl);
                console.log("DEBUG: Cleared URL parameters.");
            }
            console.log("DEBUG: Script inicializado.");

            // --- L√≥gica para Modal de B√∫squeda Avanzada ---
            function showAdvancedSearchModal() {
                if (advancedSearchModal) {
                    advancedSearchModal.classList.remove('hidden');
                    // Aqu√≠ podr√≠as a√±adir l√≥gica para animaciones si es necesario
                }
            }

            function hideAdvancedSearchModal() {
                if (advancedSearchModal) {
                    advancedSearchModal.classList.add('hidden');
                }
            }

            if (advancedSearchTriggerBtn) {
                advancedSearchTriggerBtn.addEventListener('click', showAdvancedSearchModal);
            }
            if (advancedSearchModalOverlay) {
                advancedSearchModalOverlay.addEventListener('click', hideAdvancedSearchModal);
            }
            if (advancedSearchModalCloseXBtn) {
                advancedSearchModalCloseXBtn.addEventListener('click', hideAdvancedSearchModal);
            }
            if (advancedSearchModalCloseCancelBtn) {
                advancedSearchModalCloseCancelBtn.addEventListener('click', hideAdvancedSearchModal);
            }

            if (applyAdvancedSearchBtn) {
                applyAdvancedSearchBtn.addEventListener('click', function() {
                    // L√≥gica para aplicar b√∫squeda avanzada se implementar√° aqu√≠
                    console.log("Aplicar b√∫squeda avanzada clickeado");
                    const aiPrompt = aiSearchPromptInput.value.trim();
                    const useFuzzy = fuzzySearchCheckbox.checked;
                    const selectedFields = Array.from(filterFieldCheckboxes)
                                                .filter(cb => cb.checked)
                                                .map(cb => cb.value);

                    console.log("AI Prompt:", aiPrompt);
                    console.log("Usar Fuzzy:", useFuzzy);
                    console.log("Campos seleccionados:", selectedFields);
                    
                    // Aqu√≠ se llamar√≠a a la funci√≥n principal de b√∫squeda con estos criterios
                    // performFullSearch({ query: searchInput.value, advanced: { aiPrompt, useFuzzy, fields: selectedFields } });
                    hideAdvancedSearchModal();
                });
            }

const DEBUG_SIMPLE_SEARCH = true; // Forzando a true para asegurar logs

function performSimpleSearch_DEBUG(query, ovcs, fieldsToSearch = DEFAULT_SEARCH_FIELDS) {
    console.log(`[SS_DEBUG_ENTRY] Called with query: "${query}"`); // Log incondicional al entrar
    if (!query) return ovcs;
    const lowerCaseQuery = query.toLowerCase();
    if (DEBUG_SIMPLE_SEARCH) console.log(`[SS_DEBUG] Effective Query: "${lowerCaseQuery}", OVCs count: ${ovcs.length}, Fields:`, fieldsToSearch);

    return ovcs.filter(ovc => {
        if (DEBUG_SIMPLE_SEARCH) console.log(`[SS_DEBUG] --- Checking OVC ID: ${ovc.id} (Titulo: ${ovc.titulo}) ---`);
        
        return fieldsToSearch.some(fieldPath => {
            if (DEBUG_SIMPLE_SEARCH) console.log(`[SS_DEBUG]   FieldPath: ${fieldPath}`);
            const parts = fieldPath.split('.');
            let valueToTest; // Puede ser un valor √∫nico o un array de valores a testear

            if (parts.length === 1) { // Campo simple o array de strings en el nivel ra√≠z
                const fieldName = parts[0];
                if (ovc.hasOwnProperty(fieldName)) {
                    valueToTest = ovc[fieldName];
                }
            } else if (parts.length === 2) { // Campo anidado de un nivel, ej: "autores.nombre"
                const arrayName = parts[0];
                const propertyName = parts[1];
                if (ovc.hasOwnProperty(arrayName) && Array.isArray(ovc[arrayName])) {
                    const baseArray = ovc[arrayName];
                    // Recolectar todos los valores anidados relevantes
                    valueToTest = baseArray.map(item => {
                        if (item && typeof item === 'object' && item.hasOwnProperty(propertyName)) {
                            return item[propertyName];
                        }
                        return undefined;
                    }).filter(val => val !== undefined && val !== null);
                    // valueToTest es ahora un array de los valores de la propiedad anidada (ej. todos los nombres de autores)
                    // Si est√° vac√≠o, significa que no se encontraron valores o la propiedad no exist√≠a en los items.
                }
            }
            // Se podr√≠an a√±adir m√°s 'else if' para mayor profundidad de anidamiento si fuera necesario

            if (valueToTest === undefined || valueToTest === null || (Array.isArray(valueToTest) && valueToTest.length === 0) ) {
                if (DEBUG_SIMPLE_SEARCH) console.log(`[SS_DEBUG]     No value or empty array for "${fieldPath}"`);
                return false;
            }
            
            let matchThisField = false;
            // Asegurar que valueToTest sea un array para la l√≥gica .some()
            const valuesArray = Array.isArray(valueToTest) ? valueToTest : [valueToTest];

            matchThisField = valuesArray.some(val => {
                if (val === null || val === undefined) return false;
                return val.toString().toLowerCase().includes(lowerCaseQuery);
            });
            
            if (DEBUG_SIMPLE_SEARCH) {
                if (matchThisField) console.log(`[SS_DEBUG]     MATCH in "${fieldPath}" for query "${lowerCaseQuery}" (Values tested: ${JSON.stringify(valuesArray)})`);
                // else console.log(`[SS_DEBUG]     No match in "${fieldPath}" for query "${lowerCaseQuery}" (Values tested: ${JSON.stringify(valuesArray)})`);
            }
            return matchThisField;
        });
    });
}
            // --- L√≥gica de B√∫squeda ---
            function performSimpleSearch(query, ovcs, fieldsToSearch = DEFAULT_SEARCH_FIELDS) {
                if (!query) return ovcs;
                const lowerCaseQuery = query.toLowerCase();

                return ovcs.filter(ovc => {
                    return fieldsToSearch.some(fieldPath => {
                        const parts = fieldPath.split('.'); // e.g., "autores.nombre" or "titulo"
                        let currentContext = ovc;

                        // Navigate to the parent object/array if path is nested
                        // For "autores.nombre", loop runs for "autores". currentContext becomes ovc.autores (array)
                        // For "titulo", loop doesn't run. currentContext remains ovc.
                        for (let i = 0; i < parts.length - 1; i++) {
                            const part = parts[i];
                            if (currentContext && typeof currentContext === 'object' && currentContext.hasOwnProperty(part)) {
                                currentContext = currentContext[part];
                            } else {
                                return false; // Invalid path part before the end
                            }
                        }

                        if (currentContext === null || currentContext === undefined) return false;

                        const finalPropertyKey = parts[parts.length - 1];

                        // Case 1: currentContext is an array (e.g., ovc.autores, ovc.enlaces, ovc.relaciones, or ovc.etiquetas, ovc.asignaturas)
                        if (Array.isArray(currentContext)) {
                            return currentContext.some(item => {
                                if (item && typeof item === 'object' && item.hasOwnProperty(finalPropertyKey)) {
                                    // This handles 'autores.nombre', 'enlaces.descripcion', etc.
                                    // 'item' is an author object, 'finalPropertyKey' is 'nombre'.
                                    const val = item[finalPropertyKey];
                                    return val && val.toString().toLowerCase().includes(lowerCaseQuery);
                                } else if (typeof item === 'string' && parts.length === 1 && finalPropertyKey === fieldPath) {
                                    // This handles 'etiquetas', 'asignaturas' where fieldPath is just the array name (e.g. "etiquetas")
                                    // 'item' is a string from the array. finalPropertyKey is, for example, "etiquetas"
                                    return item.toString().toLowerCase().includes(lowerCaseQuery);
                                }
                                return false;
                            });
                        }
                        // Case 2: currentContext is an object (or the OVC itself for non-nested paths like "titulo", "semestre")
                        else if (typeof currentContext === 'object' && currentContext.hasOwnProperty(finalPropertyKey)) {
                            const val = currentContext[finalPropertyKey];
                             // This handles 'titulo', 'descripcion', 'semestre', 'licencia', 'archivo'
                            if (Array.isArray(val)) {
                                // This case handles if a direct property of an object is an array of strings (e.g. ovc.etiquetas if fieldPath was 'etiquetas')
                                return val.some(s => s && s.toString().toLowerCase().includes(lowerCaseQuery));
                            }
                            return val && val.toString().toLowerCase().includes(lowerCaseQuery);
                        }
                        return false;
                    });
                });
            }

            function performBooleanSearch(queryString, ovcs, fieldsToSearch = DEFAULT_SEARCH_FIELDS) {
                // Implementaci√≥n simplificada de operadores booleanos.
                // Prioridad impl√≠cita: NOT > AND > OR (debido al orden de procesamiento)
                console.log("Boolean search for:", queryString, "in fields:", fieldsToSearch);
                let results = ovcs;
                const originalQuery = queryString;

                // 1. Manejo de NOT
                // Dividir la query por "NOT" (insensible a may√∫sculas)
                // Ejemplo: "terminoA AND terminoB NOT terminoC OR terminoD NOT terminoE"
                // notParts = ["terminoA AND terminoB ", " terminoC OR terminoD ", " terminoE"]
                const notSplitRegex = /\s+NOT\s+/i;
                const notParts = originalQuery.split(notSplitRegex);
                let currentResults = ovcs; // Empezar con todos los OVCs para la primera parte positiva

                if (notParts.length > 0 && notParts[0].trim() !== "") {
                     // Procesar la primera parte (antes del primer NOT, o toda la query si no hay NOT) para AND/OR
                    currentResults = processAndOr(notParts[0].trim(), ovcs, fieldsToSearch);
                } else if (originalQuery.toUpperCase().startsWith("NOT ")) {
                    // Caso especial: la query empieza con NOT, ej "NOT algo"
                    // notParts[0] ser√° ""
                    // notParts[1] ser√° "algo"
                    if (notParts.length > 1 && notParts[1].trim() !== "") {
                        const termToExclude = notParts[1].trim().toLowerCase();
                        currentResults = ovcs.filter(ovc => !performSimpleSearch(termToExclude, [ovc], fieldsToSearch).length);
                        // El resto de notParts (desde el √≠ndice 2) se procesar√°n como exclusiones adicionales si existen
                        for (let i = 2; i < notParts.length; i++) {
                            const termToExcludeFurther = notParts[i].trim().toLowerCase();
                            if (termToExcludeFurther) {
                                currentResults = currentResults.filter(ovc => !performSimpleSearch_DEBUG(termToExcludeFurther, [ovc], fieldsToSearch).length);
                            }
                        }
                        return currentResults;
                    } else { // Query es solo "NOT" o "NOT "
                        return ovcs; // No hay nada que excluir
                    }
                }


                // Procesar las partes subsiguientes de NOT (exclusiones)
                for (let i = 1; i < notParts.length; i++) {
                    const termToExcludeString = notParts[i].trim();
                    if (termToExcludeString) {
                        // Lo que sigue a un NOT podr√≠a ser un t√©rmino simple o una subexpresi√≥n AND/OR
                        // Para simplificar, trataremos lo que sigue a NOT como t√©rminos simples a excluir.
                        // Una implementaci√≥n m√°s avanzada parsear√≠a la subexpresi√≥n.
                        const exclusionTerms = termToExcludeString.toLowerCase().split(/\s+/).filter(t => t); // Dividir por si acaso
                        exclusionTerms.forEach(exTerm => {
                            if (exTerm) {
                                currentResults = currentResults.filter(ovc => !performSimpleSearch(exTerm, [ovc], fieldsToSearch).length);
                            }
                        });
                    }
                }
                return currentResults;
            }

            // Funci√≥n auxiliar para procesar AND y OR dentro de una sub-cadena (ej., antes de un NOT, o la query completa)
            function processAndOr(subQuery, ovcs, fieldsToSearch) {
                let currentResults = ovcs;
                const andSplitRegex = /\s+AND\s+/i;

                if (subQuery.toUpperCase().includes(" AND ")) {
                    const andTerms = subQuery.split(andSplitRegex);
                    if (andTerms.length > 0 && andTerms[0].trim() !== "") {
                        currentResults = performSimpleSearch_DEBUG(andTerms[0].trim(), ovcs, fieldsToSearch);
                    } else if (andTerms.length > 1 && andTerms[0].trim() === "") {
                        // Caso como " AND t√©rmino" (inv√°lido, pero para no romper)
                        // o si la query era solo "AND"
                        currentResults = performSimpleSearch_DEBUG(andTerms[1].trim(), ovcs, fieldsToSearch);
                        andTerms.splice(0,1); // Remover el primer "AND" o el vac√≠o
                    }


                    for (let i = 1; i < andTerms.length; i++) {
                        const term = andTerms[i].trim();
                        if (term === "") continue;
                        const termResults = performSimpleSearch_DEBUG(term, ovcs, fieldsToSearch);
                        currentResults = currentResults.filter(ovc => termResults.includes(ovc));
                    }
                    return currentResults;

                } else if (subQuery.toUpperCase().includes(" OR ")) {
                    const orSplitRegex = /\s+OR\s+/i;
                    const orTerms = subQuery.split(orSplitRegex);
                    const resultSet = new Set();
                    orTerms.forEach(term => {
                        const termToSearch = term.trim();
                        if (termToSearch) {
                            performSimpleSearch_DEBUG(termToSearch, ovcs, fieldsToSearch).forEach(ovc => resultSet.add(ovc));
                        }
                    });
                    return Array.from(resultSet);
                }
                return performSimpleSearch_DEBUG(subQuery, ovcs, fieldsToSearch);
            }


            async function searchWithAI(aiPrompt, ovcsToSearchIn, fieldsToSearch = DEFAULT_SEARCH_FIELDS) {
                if (!aiPrompt) return ovcsToSearchIn;
                if (!GOOGLE_API_KEY || GOOGLE_API_KEY === 'YOUR_API_KEY_HERE' || GOOGLE_API_KEY.includes("YOUR_API_KEY") || GOOGLE_API_KEY.length < 30) {
                    console.warn("B√∫squeda con IA deshabilitada: GOOGLE_API_KEY no est√° configurada correctamente, es un placeholder evidente o es demasiado corta.");
                    return ovcsToSearchIn;
                }

                console.log("Iniciando b√∫squeda con IA para prompt:", aiPrompt);
                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${AI_MODEL_NAME}:generateContent?key=${GOOGLE_API_KEY}`;
                
                const requestBody = {
                    contents: [{
                        parts: [{
                            text: `Dada la siguiente consulta de un usuario que busca Objetos Virtuales Creativos (OVCs): "${aiPrompt}". Extrae y devuelve una lista concisa de 3 a 5 palabras clave o conceptos de b√∫squeda principales y relevantes, separados por comas. Estas palabras clave se usar√°n para filtrar una base de datos de OVCs. Prioriza los t√©rminos m√°s distintivos y √∫tiles para la b√∫squeda. Si la consulta es muy vaga o no parece una b√∫squeda, devuelve una lista vac√≠a o la palabra 'N/A'.`
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.3,
                        maxOutputTokens: 60
                    }
                };

                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        console.error(`Error en API de Gemini: ${response.status} ${response.statusText}`, errorBody);
                        // alert(`Error al contactar la IA: ${response.statusText}. Se mostrar√°n resultados sin filtro de IA.`);
                        return ovcsToSearchIn; // Devuelve los OVCs sin filtrar en caso de error de API
                    }

                    const data = await response.json();
                    
                    if (data.candidates && data.candidates.length > 0 && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts.length > 0) {
                        const rawKeywordsText = data.candidates[0].content.parts[0].text;
                        console.log("Texto de palabras clave de IA:", rawKeywordsText);
                        if (rawKeywordsText.trim().toUpperCase() === 'N/A' || rawKeywordsText.trim() === '') {
                            console.log("IA no devolvi√≥ palabras clave √∫tiles.");
                            return ovcsToSearchIn; // O podr√≠a ser un array vac√≠o si la IA es el √∫nico criterio
                        }
                        const keywords = rawKeywordsText.split(',').map(kw => kw.trim().toLowerCase()).filter(kw => kw.length > 1);
                        
                        if (keywords.length === 0) {
                             console.log("No se extrajeron palabras clave v√°lidas de la respuesta de la IA.");
                             return ovcsToSearchIn;
                        }
                        console.log("Palabras clave procesadas de IA:", keywords);

                        // Filtrar OVCs que contengan AL MENOS UNA de las palabras clave en los campos especificados
                        const matchedOvcs = ovcsToSearchIn.filter(ovc => {
                            return keywords.some(keyword => {
                                if (fieldsToSearch.includes('titulo') && ovc.titulo && ovc.titulo.toLowerCase().includes(keyword)) return true;
                                if (fieldsToSearch.includes('descripcion') && ovc.descripcion && ovc.descripcion.toLowerCase().includes(keyword)) return true;
                                if (fieldsToSearch.includes('etiquetas') && ovc.etiquetas && ovc.etiquetas.some(et => et.toLowerCase().includes(keyword))) return true;
                                return false;
                            });
                        });
                        console.log("OVCs coincidentes con IA:", matchedOvcs.length);
                        return matchedOvcs;
                    } else {
                        console.warn("Respuesta de IA no conten√≠a palabras clave esperadas:", data);
                        return ovcsToSearchIn;
                    }
                } catch (error) {
                    console.error("Error durante la llamada fetch a la API de Gemini:", error);
                    // alert("Error de conexi√≥n con el servicio de IA. Se mostrar√°n resultados sin filtro de IA.");
                    return ovcsToSearchIn; // Devuelve los OVCs sin filtrar en caso de error de red/fetch
                }
            }

            async function performFullSearch(criteria) { // Convertida a async
                console.log("Performing full search with criteria:", criteria);
                let allOvcs = window.getOvcsFromStorage();
                let filteredOvcs = allOvcs;
                const rawMainQuery = criteria.query ? criteria.query.trim() : ""; // Mantener may√∫sculas para operadores

                let fieldsForMainQuery = DEFAULT_SEARCH_FIELDS; // Usar la lista expandida por defecto

                if (criteria.advanced) {
                    console.log("Criterios avanzados recibidos:", criteria.advanced);
                    const adv = criteria.advanced;

                    // 1. Filtro por campos espec√≠ficos (si se seleccionaron en el modal)
                    if (adv.fields && adv.fields.length > 0) {
                        fieldsForMainQuery = adv.fields;
                        console.log("Buscando query principal solo en campos:", fieldsForMainQuery);
                    }
                    
                    // 2. B√∫squeda con IA (si hay prompt)
                    // Si se usa IA, esta podr√≠a ser la fuente principal de resultados o refinar la query.
                    // Por ahora, si hay aiPrompt, este filtrar√° los OVCs.
                    // Los filtros de texto (rawMainQuery, fuzzy) se aplicar√°n DESPU√âS o sobre estos resultados.
                    if (adv.aiPrompt) {
                        console.log("Aplicando b√∫squeda con AI Prompt:", adv.aiPrompt);
                        filteredOvcs = await searchWithAI(adv.aiPrompt, filteredOvcs, fieldsForMainQuery);
                        // Despu√©s de la IA, si hay un rawMainQuery, podr√≠a usarse para refinar a√∫n m√°s los resultados de la IA.
                        // O, el rawMainQuery podr√≠a ignorarse si la IA es la b√∫squeda principal.
                        // Decisi√≥n de dise√±o: Por ahora, si hay AI prompt, el rawMainQuery refina los resultados de la IA.
                    }

                    // 3. Aplicar b√∫squeda principal (fuzzy, booleana o simple) sobre los OVCs (posiblemente ya filtrados por IA)
                    if (rawMainQuery) {
                        if (adv.useFuzzy) {
                            console.log("Aplicando Fuzzy Search para query principal:", rawMainQuery, "en campos:", fieldsForMainQuery);
                            filteredOvcs = performFuzzySearch(rawMainQuery, filteredOvcs, fieldsForMainQuery);
                        } else if (rawMainQuery.includes(" AND ") || rawMainQuery.includes(" OR ") || rawMainQuery.toUpperCase().includes(" NOT ")) {
                            console.log("Detectada query booleana en input principal:", rawMainQuery, "en campos:", fieldsForMainQuery);
                            filteredOvcs = performBooleanSearch(rawMainQuery, filteredOvcs, fieldsForMainQuery);
                        } else {
                            console.log("Aplicando b√∫squeda simple para query principal:", rawMainQuery, "en campos:", fieldsForMainQuery);
                            filteredOvcs = performSimpleSearch(rawMainQuery, filteredOvcs, fieldsForMainQuery);
                        }
                    } else if (adv.useFuzzy) {
                        // Si no hay query principal pero fuzzy est√° activo en el modal, no tiene efecto por s√≠ solo.
                        // Fuzzy necesita un t√©rmino de b√∫squeda para operar sobre la query principal.
                        console.log("Fuzzy search activado en modal pero no hay query principal en el input.");
                    }
                    // Nota: La l√≥gica de AI se aplicar√≠a aqu√≠ tambi√©n, potencialmente modificando 'filteredOvcs'.


                } else if (rawMainQuery) {
                    // Solo b√∫squeda desde el input principal (simple o booleana)
                    if (rawMainQuery.includes(" AND ") || rawMainQuery.includes(" OR ") || rawMainQuery.toUpperCase().includes(" NOT ")) {
                        console.log("Detectada query booleana en input principal.");
                        filteredOvcs = performBooleanSearch(rawMainQuery, filteredOvcs, fieldsForMainQuery); // Esta llamada ya usa performSimpleSearch_DEBUG indirectamente
                    } else {
                        filteredOvcs = performSimpleSearch_DEBUG(rawMainQuery, filteredOvcs, fieldsForMainQuery);
                    }
                } else {
                    // Sin query y sin criterios avanzados, mostrar todos.
                    filteredOvcs = allOvcs;
                }
                
                window.renderOvcTable(filteredOvcs);
            }

            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const query = searchInput.value; // No convertir a lowercase aqu√≠, se hace en las funciones de b√∫squeda
                    performFullSearch({ query: query });
                });
            }

            if (applyAdvancedSearchBtn) {
                applyAdvancedSearchBtn.addEventListener('click', function() {
                    const aiPrompt = aiSearchPromptInput.value.trim();
                    const useFuzzy = fuzzySearchCheckbox.checked;
                    const selectedFields = Array.from(filterFieldCheckboxes)
                                                .filter(cb => cb.checked)
                                                .map(cb => cb.value);

                    const mainQueryFromInput = searchInput.value.trim();

                    console.log("Aplicando b√∫squeda avanzada con:");
                    console.log("Query Principal:", mainQueryFromInput);
                    console.log("AI Prompt:", aiPrompt);
                    console.log("Usar Fuzzy:", useFuzzy);
                    console.log("Campos seleccionados:", selectedFields);
                    
                    performFullSearch({
                        query: mainQueryFromInput, // Usar el query del input principal tambi√©n
                        advanced: {
                            aiPrompt: aiPrompt,
                            useFuzzy: useFuzzy,
                            fields: selectedFields
                        }
                    });
                    hideAdvancedSearchModal();
                });
            }

            // --- Function to Load Rubric Pages into Content Area ---
            function loadPageInContentArea(url, clickedLink) {
                console.log(`DEBUG: Cargando contenido de ${url} en iframe.`);
                const contentArea = document.getElementById('content-area');

                // Hide all other sections first
                Object.values(sections).forEach(section => {
                    if (section) section.classList.add('hidden');
                });

                // Clear previous content (including any old iframe)
                contentArea.innerHTML = '';

                // Create and configure iframe
                const iframe = document.createElement('iframe');
                iframe.setAttribute('src', url);
                iframe.setAttribute('frameborder', '0');
                iframe.style.width = '100%';
                iframe.style.height = '100%'; // Make iframe fill the container
                iframe.style.border = 'none';

                // Append iframe
                contentArea.appendChild(iframe);

                // Update title (use text content of the clicked link)
                const linkText = clickedLink.textContent.trim().replace(/^[^\w]+/, ''); // Clean up emoji/prefix
                sectionTitle.innerHTML = `<span>üìä</span> R√∫bricas: ${linkText}`;

                // Update active link state
                sidebarLinks.forEach(link => link.classList.remove('active'));
                if (clickedLink) {
                    clickedLink.classList.add('active');
                }
                // Also mark the main "R√∫bricas" toggle as active visually
                rubricasToggle.classList.add('active');

                // Ensure the submenu stays open visually
                if (!rubricasSubmenu.classList.contains('open')) {
                    rubricasSubmenu.classList.add('open');
                    rubricasToggleIcon.classList.add('open');
                    rubricasToggleIcon.textContent = '‚ñº';
                }
            }


            // COMENTADO: Esta funci√≥n ha sido reemplazada por la versi√≥n en rizoma.js
            /*
             * Llama a la funci√≥n verRizoma para renderizar el grafo D3.
             */
            /*
            function renderRizomaGraph() {
                console.log("DEBUG: Llamando a verRizoma para renderizar el grafo.");
                const containerId = '#rizoma-graph'; // ID del elemento SVG
                const containerElement = document.querySelector(containerId);

                if (containerElement) {
                    // Asegurarse de que los datos est√©n en localStorage antes de llamar
                    if (localStorage.getItem('ovcData')) {
                        // Llamar a la funci√≥n as√≠ncrona verRizoma
                        verRizoma(containerId)
                            .then(() => {
                                console.log("DEBUG: Grafo rizoma renderizado exitosamente.");
                            })
                            .catch(error => {
                                console.error("Error al renderizar el grafo rizoma:", error);
                                // Opcionalmente mostrar error en la UI
                                containerElement.innerHTML = `<text x="50%" y="50%" text-anchor="middle" fill="red">Error al cargar grafo: ${error.message}</text>`;
                            });
                    } else {
                        console.warn("DEBUG: No hay 'ovcData' en localStorage. No se puede renderizar el grafo.");
                        containerElement.innerHTML = `<text x="50%" y="50%" text-anchor="middle">No hay datos OVC en localStorage para mostrar el grafo.</text>`;
                    }
                } else {
                    console.error(`Error: Contenedor SVG con ID '${containerId}' no encontrado.`);
                }
            }
            */

            /* // --- B√∫squeda en Rizoma (Adaptar si es necesario para D3) ---
            // La l√≥gica actual de b√∫squeda manipula display, lo cual puede no funcionar
            // bien con D3 que controla las posiciones. Se necesitar√≠a una l√≥gica
            // diferente para resaltar o filtrar nodos/enlaces en D3.
            // Por ahora, comentamos la l√≥gica de b√∫squeda espec√≠fica del rizoma
            // para evitar conflictos con D3.
            /*
            const rizomaSearchInput = document.getElementById('rizoma-search-input');
            if (rizomaSearchInput) {
                rizomaSearchInput.addEventListener('input', () => {
                    const query = rizomaSearchInput.value.trim().toLowerCase();
                    console.log("B√∫squeda en Rizoma (l√≥gica pendiente de adaptar para D3):", query);
                    // Aqu√≠ ir√≠a la l√≥gica de filtrado/resaltado para D3
                    // Ejemplo: filtrar datos y volver a renderizar, o aplicar clases CSS
                });
            }
            */

        }); // Fin del listener DOMContentLoaded principal


        // =====================================================================
        // ======================= KANBAN BOARD LOGIC ==========================
        // =====================================================================
        const KanbanApp = (() => {
            // --- Elementos del DOM (Kanban) ---
            let columns = null;
            let contextMenu = null;
            let taskModal = null;
            let addTaskBtn = null;
            let taskForm = null;
            let draggedTask = null;
            let currentTaskElement = null; // For context menu target
            let currentEditingTask = null; // For inline editing target

            // --- Colores disponibles (Kanban) ---
            const taskColorClasses = [
                'bg-task-default', 'bg-task-red', 'bg-task-blue',
                'bg-task-green', 'bg-task-yellow', 'bg-task-purple'
            ];

            // --- Funciones (Kanban) ---

            function generateId(prefix = 'task') {
                return `${prefix}-` + Date.now() + '-' + Math.floor(Math.random() * 1000);
            }

            function getTaskDataFromElement(taskElement) {
                const description = taskElement.querySelector('p.font-medium')?.textContent || '';
                const dueDateText = taskElement.querySelector('.details p:first-child')?.textContent || '';
                const assigneeText = taskElement.querySelector('.details p:last-child:not(:first-child)')?.textContent || '';
                const dueDate = dueDateText.includes(' ') ? dueDateText.substring(dueDateText.indexOf(' ') + 1).trim() : '';
                const assignee = assigneeText.includes(' ') ? assigneeText.substring(assigneeText.indexOf(' ') + 1).trim() : '';
                return { description, dueDate, assignee };
            }

            function renderTaskViewContent(taskData) {
                const subtasks = taskData.subtasks || [];
                const completedSubtasks = subtasks.filter(st => st.completed).length;
                const totalSubtasks = subtasks.length;
                const subtasksExist = totalSubtasks > 0;

                return `
                    <p class="font-medium text-gray-800">${taskData.description || 'Sin descripci√≥n'}</p>
                    <div class="details mt-2 text-xs">
                        ${taskData.dueDate ? `<p class="flex items-center gap-1"><span class="emoji">üìÖ</span> ${taskData.dueDate}</p>` : ''}
                        ${taskData.assignee ? `<p class="flex items-center gap-1 mt-1"><span class="emoji">üë§</span> ${taskData.assignee}</p>` : ''}
                    </div>
                    ${subtasksExist ? `
                    <button class="view-subtasks-btn" aria-expanded="false">
                        <span class="arrow mr-1">‚ñ∂</span><span class="emoji">üìë</span> Subtareas (${completedSubtasks}/${totalSubtasks})
                    </button>
                    <div class="subtasks-list-view" style="display: none;">
                        ${renderSubtasksView(subtasks, taskData.id)}
                    </div>
                    ` : ''}
                `;
            }

            function renderSubtasksView(subtasks, taskId) {
                if (!subtasks || subtasks.length === 0) return '<p class="text-xs text-gray-500 italic ml-1">No hay subtareas.</p>';
                return `
                    <ul>
                        ${subtasks.map(subtask => `
                            <li class="subtask-item-view" data-subtask-id="${subtask.id}">
                                <input type="checkbox" ${subtask.completed ? 'checked' : ''} onchange="KanbanApp.toggleSubtaskCompletion(event, '${taskId}', '${subtask.id}')" aria-label="Marcar subtarea ${subtask.description} como completada">
                                <span class="${subtask.completed ? 'completed' : ''}">${subtask.description}</span>
                            </li>
                        `).join('')}
                    </ul>
                `;
            }

            function createTaskElement(taskData) {
                const taskElement = document.createElement('div');
                taskElement.id = taskData.id;
                taskElement.classList.add('task-card');
                taskElement.draggable = true;

                const colorClass = (taskData.color && taskColorClasses.includes(taskData.color)) ? taskData.color : 'bg-task-default';
                taskElement.classList.add(colorClass);

                taskElement._subtasks = taskData.subtasks || []; // Store subtasks data

                taskElement.innerHTML = renderTaskViewContent(taskData);

                taskElement.addEventListener('click', handleTaskClick);
                taskElement.addEventListener('dragstart', handleDragStart);
                taskElement.addEventListener('dragend', handleDragEnd);
                taskElement.addEventListener('contextmenu', handleContextMenu);

                taskElement.addEventListener('click', (event) => {
                    if (event.target.classList.contains('view-subtasks-btn') || event.target.closest('.view-subtasks-btn')) {
                        const button = event.target.classList.contains('view-subtasks-btn') ? event.target : event.target.closest('.view-subtasks-btn');
                        toggleSubtasksView(button);
                        event.stopPropagation();
                    }
                    if (event.target.matches('.subtask-item-view input[type="checkbox"]')) {
                        event.stopPropagation();
                    }
                });

                return taskElement;
            }

            function addTask(taskData, save = true) {
                if (!taskData.id) taskData.id = generateId('task');
                if (!taskData.columnId) taskData.columnId = 'todo';
                if (!taskData.color) taskData.color = 'bg-task-default';
                if (!taskData.subtasks) taskData.subtasks = [];

                const taskElement = createTaskElement(taskData);
                const targetColumn = document.querySelector(`.kanban-tasks[data-column-id="${taskData.columnId}"]`);

                if (targetColumn) {
                    targetColumn.appendChild(taskElement);
                    if (save) saveBoardState();
                } else {
                    console.error(`Columna Kanban con ID "${taskData.columnId}" no encontrada.`);
                    const todoColumn = document.querySelector('.kanban-tasks[data-column-id="todo"]');
                    if (todoColumn) {
                        todoColumn.appendChild(taskElement);
                        taskData.columnId = 'todo';
                        if (save) saveBoardState();
                    } else {
                        console.error("Columna Kanban 'todo' tampoco encontrada.");
                    }
                }
            }

            function deleteTask(taskId) {
                const taskElement = document.getElementById(taskId);
                if (taskElement) {
                    if (currentEditingTask && currentEditingTask.id === taskId) {
                        disableEditMode(currentEditingTask, false);
                    }
                    taskElement.remove();
                    saveBoardState();
                    console.log(`Tarea Kanban ${taskId} eliminada.`);
                } else {
                    console.warn(`No se encontr√≥ la tarea Kanban con ID ${taskId} para eliminar.`);
                }
            }

            function handleTaskClick(event) {
                const taskCard = event.currentTarget;
                if (event.target.closest('.view-subtasks-btn') || event.target.closest('.subtasks-list-view')) {
                    return;
                }
                if (currentEditingTask || taskCard.classList.contains('editing') || event.target.closest('.edit-actions') || event.button === 2) {
                    return;
                }
                enableEditMode(taskCard);
            }

            function enableEditMode(taskElement) {
                if (currentEditingTask && currentEditingTask !== taskElement) {
                    disableEditMode(currentEditingTask, false);
                }

                currentEditingTask = taskElement;
                taskElement.classList.add('editing');
                taskElement.draggable = false;

                const originalData = getTaskDataFromElement(taskElement);
                const originalSubtasks = JSON.parse(JSON.stringify(taskElement._subtasks || []));
                taskElement.dataset.originalDescription = originalData.description;
                taskElement.dataset.originalDueDate = originalData.dueDate;
                taskElement.dataset.originalAssignee = originalData.assignee;
                taskElement._originalSubtasks = originalSubtasks;

                taskElement.innerHTML = `
                    <textarea class="edit-input edit-textarea" placeholder="Descripci√≥n..." aria-label="Descripci√≥n de la tarea">${originalData.description}</textarea>
                    <input type="date" class="edit-input" value="${originalData.dueDate}" aria-label="Fecha de vencimiento">
                    <input type="text" class="edit-input" placeholder="Responsable..." value="${originalData.assignee}" aria-label="Responsable">
                    <div class="subtasks-section">
                        <h4 class="text-sm font-medium text-gray-600 mb-2">Subtareas</h4>
                        <ul class="subtasks-list-edit mb-3" aria-label="Lista de subtareas editables">
                            ${renderSubtasksEdit(originalSubtasks)}
                        </ul>
                        <div class="add-subtask-container">
                            <input type="text" class="add-subtask-input" placeholder="A√±adir nueva subtarea..." aria-label="Nueva subtarea">
                            <button type="button" class="edit-button add-subtask-btn bg-gray-200 hover:bg-gray-300 text-gray-700 border-gray-300" aria-label="A√±adir subtarea">‚ûï A√±adir</button>
                        </div>
                    </div>
                    <div class="edit-actions">
                        <button class="edit-button cancel-button"><span class="emoji">‚ùå</span>Cancelar</button>
                        <button class="edit-button save-button"><span class="emoji">üíæ</span>Guardar</button>
                    </div>
                `;

                const subtaskListElement = taskElement.querySelector('.subtasks-list-edit');
                const addSubtaskInput = taskElement.querySelector('.add-subtask-input');
                const addSubtaskBtn = taskElement.querySelector('.add-subtask-btn');

                taskElement.querySelector('.save-button').addEventListener('click', () => disableEditMode(taskElement, true));
                taskElement.querySelector('.cancel-button').addEventListener('click', () => disableEditMode(taskElement, false));

                addSubtaskBtn.addEventListener('click', () => {
                    const description = addSubtaskInput.value.trim();
                    if (description) {
                        addSubtaskToEditList(subtaskListElement, description);
                        addSubtaskInput.value = '';
                        addSubtaskInput.focus();
                    }
                });
                addSubtaskInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addSubtaskBtn.click();
                    }
                });

                subtaskListElement.addEventListener('click', (e) => {
                    if (e.target.classList.contains('subtask-delete-btn')) {
                        deleteSubtaskFromEditList(e.target.closest('.subtask-item-edit'));
                    }
                });

                // Initialize SortableJS only if Sortable is defined
                if (typeof Sortable !== 'undefined') {
                    Sortable.create(subtaskListElement, {
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        handle: '.subtask-drag-handle',
                        forceFallback: true,
                        fallbackOnBody: true,
                        swapThreshold: 0.65
                    });
                } else {
                    console.warn("SortableJS no est√° definido. La funci√≥n de arrastrar subtareas no funcionar√°.");
                }


                taskElement.querySelector('textarea').focus();
                document.addEventListener('click', handleClickOutsideEdit, true);
            }

            function disableEditMode(taskElement, saveData) {
                if (!taskElement || !taskElement.classList.contains('editing')) return;

                let updatedData = {};

                if (saveData) {
                    const newDescription = taskElement.querySelector('textarea').value.trim();
                    const newDueDate = taskElement.querySelector('input[type="date"]').value;
                    const newAssignee = taskElement.querySelector('input[type="text"]').value.trim();
                    if (!newDescription) {
                        alert("La descripci√≥n no puede estar vac√≠a.");
                        taskElement.querySelector('textarea').focus();
                        return;
                    }
                    updatedData = {
                        description: newDescription,
                        dueDate: newDueDate,
                        assignee: newAssignee,
                        subtasks: getSubtasksFromEditList(taskElement.querySelector('.subtasks-list-edit'))
                    };
                    taskElement._subtasks = updatedData.subtasks;
                } else {
                    updatedData = {
                        description: taskElement.dataset.originalDescription,
                        dueDate: taskElement.dataset.originalDueDate,
                        assignee: taskElement.dataset.originalAssignee,
                        subtasks: taskElement._originalSubtasks || []
                    };
                    taskElement._subtasks = updatedData.subtasks;
                }

                taskElement.innerHTML = renderTaskViewContent(updatedData);
                taskElement.classList.remove('editing');
                taskElement.draggable = true;

                delete taskElement.dataset.originalDescription;
                delete taskElement.dataset.originalDueDate;
                delete taskElement.dataset.originalAssignee;
                delete taskElement._originalSubtasks;

                taskElement.addEventListener('click', handleTaskClick);
                taskElement.addEventListener('dragstart', handleDragStart);
                taskElement.addEventListener('dragend', handleDragEnd);
                taskElement.addEventListener('contextmenu', handleContextMenu);

                currentEditingTask = null;
                document.removeEventListener('click', handleClickOutsideEdit, true);

                if (saveData) {
                    saveBoardState();
                }
            }

            function handleClickOutsideEdit(event) {
                if (contextMenu && contextMenu.contains(event.target) || (currentEditingTask && currentEditingTask.contains(event.target))) {
                    return;
                }
                if (currentEditingTask) {
                    if (event.target.closest('.sortable-fallback') || event.target.closest('.sortable-ghost')) {
                        return;
                    }
                    disableEditMode(currentEditingTask, false);
                }
            }

            function renderSubtasksEdit(subtasks) {
                if (!subtasks || subtasks.length === 0) return '<p class="text-xs text-gray-500 italic px-1">No hay subtareas a√±adidas.</p>';
                return subtasks.map(subtask => `
                    <li class="subtask-item-edit" data-subtask-id="${subtask.id}" data-completed="${subtask.completed}">
                        <span class="subtask-drag-handle" title="Arrastrar para reordenar">‚†ø</span>
                        <input type="text" value="${subtask.description}" placeholder="Descripci√≥n subtarea..." aria-label="Descripci√≥n de la subtarea ${subtask.description}">
                        <button type="button" class="subtask-delete-btn" title="Eliminar subtarea">‚úñ</button>
                    </li>
                `).join('');
            }

            function addSubtaskToEditList(listElement, description) {
                const noSubtasksMsg = listElement.querySelector('p');
                if (noSubtasksMsg) noSubtasksMsg.remove();

                const newSubtaskId = generateId('sub');
                const newSubtask = { id: newSubtaskId, description: description, completed: false };
                const li = document.createElement('li');
                li.className = 'subtask-item-edit';
                li.dataset.subtaskId = newSubtask.id;
                li.dataset.completed = 'false';
                li.innerHTML = `
                    <span class="subtask-drag-handle" title="Arrastrar para reordenar">‚†ø</span>
                    <input type="text" value="${newSubtask.description}" placeholder="Descripci√≥n subtarea..." aria-label="Descripci√≥n de la subtarea ${newSubtask.description}">
                    <button type="button" class="subtask-delete-btn" title="Eliminar subtarea">‚úñ</button>
                `;
                listElement.appendChild(li);
            }

            function deleteSubtaskFromEditList(subtaskItemElement) {
                const listElement = subtaskItemElement.parentElement;
                subtaskItemElement.remove();
                if (listElement && !listElement.querySelector('.subtask-item-edit')) {
                    listElement.innerHTML = '<p class="text-xs text-gray-500 italic px-1">No hay subtareas a√±adidas.</p>';
                }
            }

            function getSubtasksFromEditList(listElement) {
                const subtaskItems = listElement.querySelectorAll('.subtask-item-edit');
                const subtasks = [];
                subtaskItems.forEach(item => {
                    const input = item.querySelector('input[type="text"]');
                    const description = input ? input.value.trim() : '';
                    if (description) {
                        subtasks.push({
                            id: item.dataset.subtaskId,
                            description: description,
                            completed: item.dataset.completed === 'true'
                        });
                    } else {
                        console.warn("Subtarea Kanban vac√≠a encontrada y omitida al guardar:", item.dataset.subtaskId);
                    }
                });
                return subtasks;
            }

            function toggleSubtasksView(button) {
                const subtaskList = button.nextElementSibling;
                const isExpanded = button.getAttribute('aria-expanded') === 'true';
                const arrow = button.querySelector('.arrow');
                if (subtaskList) {
                    subtaskList.style.display = isExpanded ? 'none' : 'block';
                    button.setAttribute('aria-expanded', !isExpanded);
                    if (arrow) {
                        arrow.style.transform = isExpanded ? 'rotate(0deg)' : 'rotate(90deg)';
                    }
                }
            }

            function toggleSubtaskCompletion(event, taskId, subtaskId) {
                const isChecked = event.target.checked;
                const taskElement = document.getElementById(taskId);
                if (taskElement && taskElement._subtasks) {
                    const subtaskIndex = taskElement._subtasks.findIndex(st => st.id === subtaskId);
                    if (subtaskIndex !== -1) {
                        taskElement._subtasks[subtaskIndex].completed = isChecked;

                        const subtaskSpan = event.target.nextElementSibling;
                        if (subtaskSpan) {
                            subtaskSpan.classList.toggle('completed', isChecked);
                        }
                        const viewButton = taskElement.querySelector('.view-subtasks-btn');
                        if (viewButton) {
                            const completedCount = taskElement._subtasks.filter(st => st.completed).length;
                            const totalCount = taskElement._subtasks.length;
                            viewButton.innerHTML = `<span class="arrow mr-1" style="transform: ${viewButton.getAttribute('aria-expanded') === 'true' ? 'rotate(90deg)' : 'rotate(0deg)'};">‚ñ∂</span><span class="emoji">üìë</span> Subtareas (${completedCount}/${totalCount})`;
                        }
                        saveBoardState();
                    } else {
                        console.error("Subtask Kanban no encontrada en datos internos:", subtaskId, "para tarea:", taskId);
                    }
                } else {
                    console.error("Elemento de tarea Kanban o datos internos de subtarea no encontrados:", taskId);
                }
            }

            function handleDragStart(event) {
                if (event.target.classList.contains('editing')) {
                    event.preventDefault(); return;
                }
                if (event.target.classList.contains('task-card')) {
                    draggedTask = event.target;
                    event.dataTransfer.setData('text/plain', event.target.id);
                    event.dataTransfer.effectAllowed = 'move';
                    setTimeout(() => { if (draggedTask) draggedTask.classList.add('dragging'); }, 0);
                } else {
                    event.preventDefault();
                }
            }
            function handleDragEnd(event) {
                if (draggedTask) draggedTask.classList.remove('dragging');
                if (columns) columns.forEach(col => col.classList.remove('drag-over'));
                draggedTask = null;
            }
            function handleDragOver(event) {
                event.preventDefault();
                event.dataTransfer.dropEffect = 'move';
                const targetColumn = event.target.closest('.kanban-tasks');
                if (targetColumn && (!draggedTask || !targetColumn.contains(draggedTask))) {
                    if (columns) columns.forEach(col => col !== targetColumn && col.classList.remove('drag-over'));
                    targetColumn.classList.add('drag-over');
                }
            }
            function handleDragEnter(event) {
                event.preventDefault();
                const targetColumn = event.target.closest('.kanban-tasks');
                if (targetColumn && (!draggedTask || !targetColumn.contains(draggedTask))) {
                    targetColumn.classList.add('drag-over');
                }
            }
            function handleDragLeave(event) {
                const targetColumn = event.target.closest('.kanban-tasks');
                if (targetColumn && !targetColumn.contains(event.relatedTarget)) {
                    targetColumn.classList.remove('drag-over');
                }
                if (!event.relatedTarget || !event.relatedTarget.closest('.kanban-tasks')) {
                    if (columns) columns.forEach(col => col.classList.remove('drag-over'));
                }
            }
            function handleDrop(event) {
                event.preventDefault();
                const targetColumn = event.target.closest('.kanban-tasks');
                if (targetColumn && draggedTask && targetColumn !== draggedTask.parentElement) {
                    targetColumn.appendChild(draggedTask);
                    saveBoardState();
                }
                if (targetColumn) targetColumn.classList.remove('drag-over');
            }

            function handleContextMenu(event) {
                if (event.currentTarget.classList.contains('editing')) {
                    event.preventDefault(); return;
                }
                event.preventDefault();
                currentTaskElement = event.currentTarget;
                if (!currentTaskElement || !contextMenu) return;

                const { clientX: mouseX, clientY: mouseY } = event;
                contextMenu.style.display = 'block';
                const { offsetWidth: menuWidth, offsetHeight: menuHeight } = contextMenu;
                const { innerWidth, innerHeight } = window;
                let top = mouseY, left = mouseX;
                if (mouseY + menuHeight > innerHeight) top = mouseY - menuHeight;
                if (mouseX + menuWidth > innerWidth) left = mouseX - menuWidth;
                if (top < 0) top = 5;
                if (left < 0) left = 5;
                contextMenu.style.top = `${top}px`;
                contextMenu.style.left = `${left}px`;

                setTimeout(() => {
                    document.addEventListener('click', closeContextMenuOnClickOutside, { capture: true, once: true });
                    document.addEventListener('keydown', closeContextMenuOnEscape, { once: true });
                }, 0);
            }
            function closeContextMenu() {
                if (contextMenu) contextMenu.style.display = 'none';
                currentTaskElement = null;
                document.removeEventListener('click', closeContextMenuOnClickOutside, { capture: true });
                document.removeEventListener('keydown', closeContextMenuOnEscape);
            }
            function closeContextMenuOnClickOutside(event) {
                if (currentEditingTask && currentEditingTask.contains(event.target)) {
                    document.addEventListener('click', closeContextMenuOnClickOutside, { capture: true, once: true });
                    return;
                }
                if (contextMenu && !contextMenu.contains(event.target)) {
                    closeContextMenu();
                } else {
                    document.addEventListener('click', closeContextMenuOnClickOutside, { capture: true, once: true });
                }
            }
            function closeContextMenuOnEscape(event) {
                if (event.key === 'Escape') {
                    closeContextMenu();
                } else {
                    document.addEventListener('keydown', closeContextMenuOnEscape, { once: true });
                }
            }
            function handleContextMenuAction(event) {
                const menuItem = event.target.closest('.context-menu-item');
                if (!menuItem || !currentTaskElement) {
                    return;
                }
                const color = menuItem.dataset.color;
                const action = menuItem.dataset.action;
                if (color) {
                    taskColorClasses.forEach(cls => currentTaskElement.classList.remove(cls));
                    currentTaskElement.classList.add(color);
                    saveBoardState();
                } else if (action === 'delete') {
                    const taskDescription = getTaskDataFromElement(currentTaskElement).description || 'esta tarea';
                    if (confirm(`¬øEst√°s seguro de que quieres eliminar la tarea Kanban "${taskDescription}"?`)) {
                        deleteTask(currentTaskElement.id);
                    }
                }
                closeContextMenu();
            }

            function openModal() {
                if (taskForm) taskForm.reset();
                if (taskModal) {
                    taskModal.style.display = 'block';
                    const descInput = document.getElementById('taskDescription');
                    if (descInput) descInput.focus();
                }
            }
            function closeModal() {
                if (taskModal) taskModal.style.display = 'none';
            }
            function handleFormSubmit(event) {
                event.preventDefault();
                if (!taskForm) return;
                const formData = new FormData(taskForm);
                const taskData = {
                    description: formData.get('description').trim(),
                    dueDate: formData.get('dueDate'),
                    assignee: formData.get('assignee').trim(),
                };
                if (!taskData.description) {
                    alert("La descripci√≥n de la tarea Kanban no puede estar vac√≠a.");
                    const descInput = document.getElementById('taskDescription');
                    if (descInput) descInput.focus();
                    return;
                }
                addTask(taskData);
                closeModal();
            }

            function saveBoardState() {
                if (currentEditingTask) {
                    console.warn("Guardando estado Kanban con tarea en edici√≥n. Cancelando edici√≥n...");
                    disableEditMode(currentEditingTask, false);
                }
                const boardState = [];
                if (!columns) return; // Check if columns exist

                columns.forEach(column => {
                    const columnId = column.dataset.columnId;
                    const tasks = column.querySelectorAll('.task-card');
                    tasks.forEach((taskElement, index) => {
                        if (taskElement.classList.contains('editing')) {
                            console.error("Error cr√≠tico Kanban: Guardando tarea a√∫n en modo edici√≥n:", taskElement.id);
                            return;
                        }
                        let taskColor = taskColorClasses.find(cls => taskElement.classList.contains(cls)) || 'bg-task-default';
                        const taskData = getTaskDataFromElement(taskElement);
                        const subtasks = taskElement._subtasks || [];
                        boardState.push({
                            id: taskElement.id,
                            description: taskData.description,
                            dueDate: taskData.dueDate,
                            assignee: taskData.assignee,
                            color: taskColor,
                            columnId: columnId,
                            order: index,
                            subtasks: subtasks
                        });
                    });
                });
                boardState.sort((a, b) => {
                    const columnOrder = ['todo', 'in-progress', 'done'];
                    const columnAIndex = columnOrder.indexOf(a.columnId);
                    const columnBIndex = columnOrder.indexOf(b.columnId);
                    if (columnAIndex !== columnBIndex) return columnAIndex - columnBIndex;
                    return (a.order || 0) - (b.order || 0);
                });
                try {
                    localStorage.setItem('kanbanBoardState_v3', JSON.stringify(boardState));
                    console.log("Estado del tablero Kanban guardado (v3).");
                } catch (error) {
                    console.error("Error al guardar estado Kanban en localStorage:", error);
                    alert("No se pudo guardar el estado del tablero Kanban.");
                }
            }

            function loadBoardState() {
                let savedState = localStorage.getItem('kanbanBoardState_v3');
                let version = 'v3';

                if (savedState) {
                    try {
                        let boardState = JSON.parse(savedState);
                        boardState.sort((a, b) => {
                            const columnOrder = ['todo', 'in-progress', 'done'];
                            const columnAIndex = columnOrder.indexOf(a.columnId);
                            const columnBIndex = columnOrder.indexOf(b.columnId);
                            if (columnAIndex === -1) return 1;
                            if (columnBIndex === -1) return -1;
                            if (columnAIndex !== columnBIndex) return columnAIndex - columnBIndex;
                            return (a.order || 0) - (b.order || 0);
                        });

                        if (columns) columns.forEach(col => col.innerHTML = ''); // Clear columns before loading

                        boardState.forEach(taskData => {
                            if (!taskData.id) taskData.id = generateId('task');
                            taskData.subtasks = (taskData.subtasks || []).map(st => ({
                                ...st,
                                id: st.id || generateId('sub'),
                                completed: st.completed || false
                            }));
                            addTask(taskData, false); // Add task without triggering another save
                        });
                        console.log(`Estado del tablero Kanban cargado (${version}).`);
                    } catch (error) {
                        console.error(`Error al cargar el estado del tablero Kanban (${version}):`, error);
                        localStorage.removeItem('kanbanBoardState_v3');
                    }
                } else {
                    console.log("No hay estado Kanban guardado (v3), iniciando tablero vac√≠o.");
                }
            }

            // --- Inicializaci√≥n (Kanban) ---
            function init() {
                console.log("DEBUG: Inicializando KanbanApp...");
                // Query selectors within the init function, after DOM is ready
                columns = document.querySelectorAll('#kanban-section .kanban-tasks');
                contextMenu = document.getElementById('contextMenu');
                taskModal = document.getElementById('taskModal');
                addTaskBtn = document.getElementById('addTaskBtn');
                taskForm = document.getElementById('taskForm');

                if (!columns.length || !contextMenu || !taskModal || !addTaskBtn || !taskForm) {
                    console.error("Error: No se encontraron todos los elementos necesarios para el Kanban.");
                    return;
                }

                columns.forEach(column => {
                    column.addEventListener('dragover', handleDragOver);
                    column.addEventListener('dragenter', handleDragEnter);
                    column.addEventListener('dragleave', handleDragLeave);
                    column.addEventListener('drop', handleDrop);
                });
                contextMenu.addEventListener('click', handleContextMenuAction, true);
                addTaskBtn.addEventListener('click', openModal);
                taskForm.addEventListener('submit', handleFormSubmit);

                // Global listeners specific to Kanban (modal close, escape key)
                window.addEventListener('click', function (event) {
                    if (taskModal && event.target == taskModal) closeModal();
                });
                // Escape key handling is combined in the main script's listener

                loadBoardState(); // Load saved state
                console.log("DEBUG: KanbanApp inicializado.");
            }

            // Public interface
            return {
                init: init,
                closeModal: closeModal, // Expose closeModal for onclick attribute
                toggleSubtaskCompletion: toggleSubtaskCompletion // Expose for onclick attribute
            };
        })();

        // Call Kanban init after main DOMContentLoaded logic
        // KanbanApp.init is now called conditionally within showSection after loading content
        // document.addEventListener('DOMContentLoaded', KanbanApp.init);
        // Auto completado
        document.addEventListener('DOMContentLoaded', function () {


            // Funci√≥n para configurar autocompletado en un campo
            function setupAutocomplete(input) {
                input.addEventListener('input', function () {
                    const query = input.value.toLowerCase();
                    const ovcs = window.getOvcsFromStorage();
                    const match = ovcs.find(ovc => ovc.titulo && ovc.titulo.toLowerCase().startsWith(query));

                    if (match) {
                        input.value = match.titulo; // Autocompleta con la primera coincidencia
                    }
                });
            }

            // Configurar autocompletado para los campos existentes
            function initializeAutocomplete() {
                const relacionOvcInputs = document.querySelectorAll('input[name="relacion_ovc[]"]');
                relacionOvcInputs.forEach(input => {
                    // Evitar configurar el autocompletado m√°s de una vez
                    if (!input.dataset.autocompleteInitialized) {
                        setupAutocomplete(input);
                        input.dataset.autocompleteInitialized = true; // Marcar como inicializado
                    }
                });
            }

            // Inicializar autocompletado en los campos existentes al cargar la p√°gina
            initializeAutocomplete();

            // Detectar y configurar autocompletado para nuevos campos din√°micos
            const relacionesContainer = document.getElementById('relaciones-container');
            const observer = new MutationObserver(() => {
                initializeAutocomplete(); // Reconfigurar autocompletado para nuevos inputs
            });

            // Observar cambios en el contenedor de relaciones
            observer.observe(relacionesContainer, { childList: true, subtree: true });
        });

        // Rubricas Submenu Toggle se maneja en navigation.js
        // El cu00f3digo para manejar el toggle se ha movido a navigation.js

        // Las funciones renderRizomaGraph y la b√∫squeda comentada se movieron dentro del listener principal

        // Asegurarse de que la tabla de OVCs se renderice al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Renderizando tabla de OVCs al cargar la p√°gina...');
            window.renderOvcTable();
        });

        // Combined Escape Key Listener
        window.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                // OVC Modals
                if (confirmationModal && !confirmationModal.classList.contains('hidden')) window.hideConfirmationModal();
                else if (deleteConfirmModal && !deleteConfirmModal.classList.contains('hidden')) window.hideDeleteConfirmModal();
                else if (summaryModal && !summaryModal.classList.contains('hidden')) window.hideSummaryModal();
                // Kanban Modals / States
                else if (KanbanApp && typeof KanbanApp.closeModal === 'function' && document.getElementById('taskModal')?.style.display === 'block') KanbanApp.closeModal();
                else if (KanbanApp && typeof KanbanApp.disableEditMode === 'function' && KanbanApp.currentEditingTask) KanbanApp.disableEditMode(KanbanApp.currentEditingTask, false); // Needs currentEditingTask exposed or a public cancel method
                else if (KanbanApp && typeof KanbanApp.closeContextMenu === 'function' && document.getElementById('contextMenu')?.style.display === 'block') KanbanApp.closeContextMenu(); // Needs closeContextMenu exposed or a public cancel method
            }
        });
    </script>
    <!-- Eliminada etiqueta </style> incorrecta -->
</body>

</html>
